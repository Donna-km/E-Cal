<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Tracking Dashboard</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .custom-brown {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(139, 69, 19, 0.1), 0 2px 4px -1px rgba(139, 69, 19, 0.06);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stat-card {
            transition: transform 0.2s ease-in-out;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-amber-50 min-h-screen">
    <!-- Header -->
    <header class="custom-brown text-white p-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                    <span class="text-lg">üçΩÔ∏è</span>
                </div>
                <h1 class="text-xl font-semibold">Food Dashboard</h1>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <span class="text-sm" id="userInitial">üë§</span>
                </div>
                <span class="text-sm" id="userName">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-amber-50 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-amber-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen" class="hidden fixed inset-0 bg-amber-50 flex items-center justify-center z-40">
        <div class="text-center p-6">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h2 class="text-xl font-semibold text-amber-800 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
            <p class="text-amber-700 mb-4" id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
            <button onclick="location.reload()" class="bg-amber-800 text-white px-6 py-2 rounded-lg hover:bg-amber-900 transition-colors">
                ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="hidden max-w-6xl mx-auto p-4 pb-20">
        <!-- Time Period Selector -->
        <div class="mb-6">
            <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="flex flex-wrap gap-1 mb-4">
                    <button onclick="changePeriod('daily')" class="period-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-amber-800 text-white" data-period="daily">
                        üìÖ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                    </button>
                    <button onclick="changePeriod('weekly')" class="period-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-amber-100 text-amber-800 hover:bg-amber-200" data-period="weekly">
                        üìä ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                    </button>
                    <button onclick="changePeriod('monthly')" class="period-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-amber-100 text-amber-800 hover:bg-amber-200" data-period="monthly">
                        üìà ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </button>
                </div>
                
                <!-- Period Summary -->
                <div id="periodSummary" class="hidden bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg p-4 border-l-4 border-amber-300">
                    <div class="flex items-start space-x-3">
                        <div class="text-2xl" id="summaryIcon">üìä</div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-amber-800 mb-2" id="summaryTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="font-bold text-amber-700" id="avgCalories">0</div>
                                    <div class="text-gray-600">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-red-600" id="avgProtein">0g</div>
                                    <div class="text-gray-600">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-blue-600" id="avgCarbs">0g</div>
                                    <div class="text-gray-600">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-green-600" id="avgFat">0g</div>
                                    <div class="text-gray-600">‡πÑ‡∏ü‡∏ï‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</div>
                                </div>
                            </div>
                            <div class="mt-3 text-sm text-gray-700" id="summaryText">
                                ‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <span class="font-semibold" id="totalDays">0</span> ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl p-4 card-shadow stat-card">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl">üî•</span>
                    <span class="text-xs text-gray-500">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
                </div>
                <div class="text-2xl font-bold text-amber-800" id="totalCalories">0</div>
                <div class="text-sm text-gray-600">
                    ‡∏à‡∏≤‡∏Å <span id="tdeeValue">0</span> kcal
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-amber-600 h-2 rounded-full transition-all duration-300" id="calorieProgress" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 card-shadow stat-card">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl">üçñ</span>
                    <span class="text-xs text-gray-500">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span>
                </div>
                <div class="text-2xl font-bold text-red-600" id="totalProtein">0g</div>
                <div class="text-sm text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ <span id="proteinGoal">0g</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-red-500 h-2 rounded-full transition-all duration-300" id="proteinProgress" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 card-shadow stat-card">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl">üçû</span>
                    <span class="text-xs text-gray-500">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö</span>
                </div>
                <div class="text-2xl font-bold text-blue-600" id="totalCarbs">0g</div>
                <div class="text-sm text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ <span id="carbsGoal">0g</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" id="carbsProgress" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 card-shadow stat-card">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl">ü•ë</span>
                    <span class="text-xs text-gray-500">‡πÑ‡∏ü‡∏ï‡πå</span>
                </div>
                <div class="text-2xl font-bold text-green-600" id="totalFat">0g</div>
                <div class="text-sm text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ <span id="fatGoal">0g</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-green-500 h-2 rounded-full transition-all duration-300" id="fatProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" class="grid lg:grid-cols-2 gap-6 mb-6">
            <!-- Calorie Trend Chart -->
            <div class="bg-white rounded-xl p-8 card-shadow">
                <h3 class="text-xl font-semibold text-amber-800 mb-6">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</h3>
                <div class="h-80">
                    <canvas id="calorieChart"></canvas>
                </div>
            </div>

            <!-- Macronutrient Distribution -->
            <div class="bg-white rounded-xl p-8 card-shadow">
                <h3 class="text-xl font-semibold text-amber-800 mb-6">ü•ß ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                <div class="h-80">
                    <canvas id="macroChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Food Logs -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-amber-800 mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="foodLogsList" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">üçΩÔ∏è</div>
                    <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const LIFF_ID = "2007861127-rMvQbgw6"; // Replace with your actual LIFF ID
        const SUPABASE_URL = "https://lvtdqeerzxpznnayccmb.supabase.co"; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM"; // Replace with your Supabase anon key

        // Initialize Supabase
        let supabase = null;
        if (SUPABASE_URL !== "YOUR_SUPABASE_URL" && SUPABASE_ANON_KEY !== "YOUR_SUPABASE_ANON_KEY") {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Global variables
        let currentUserId = null;
        let currentPeriod = 'daily';
        let userProfile = null;
        let calorieChart = null;
        let macroChart = null;
        let allFoodLogs = []; // Store all logs for filtering

        // Initialize the application
        async function initApp() {
            try {
                // Check if we have real credentials or use demo mode
                if (LIFF_ID === "YOUR_LIFF_ID" || SUPABASE_URL === "YOUR_SUPABASE_URL") {
                    console.log('Using demo mode - credentials not configured');
                    await initDemoMode();
                    return;
                }

                // Initialize LIFF
                await liff.init({ liffId: LIFF_ID });

                // Check if user is logged in
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // Get user profile from LINE
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                // Update UI with user info
                document.getElementById('userName').textContent = profile.displayName;
                document.getElementById('userInitial').textContent = profile.displayName.charAt(0);

                // Load user data
                await loadUserData();
                await loadFoodLogs();

                // Hide loading screen and show main content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error('Initialization error:', error);
                // If real credentials fail, try demo mode
                console.log('Real connection failed, switching to demo mode');
                await initDemoMode();
            }
        }

        // Initialize demo mode with sample data
        async function initDemoMode() {
            // Simulate loading delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Set demo user info
            document.getElementById('userName').textContent = 'Demo User';
            document.getElementById('userInitial').textContent = 'D';
            
            // Set demo user profile
            userProfile = {
                tdee: 2200,
                weight: 65,
                protein_goal: 140,
                carbs_goal: 275,
                fat_goal: 73
            };

            // Update UI with demo profile data
            document.getElementById('tdeeValue').textContent = userProfile.tdee;
            document.getElementById('proteinGoal').textContent = userProfile.protein_goal + 'g';
            document.getElementById('carbsGoal').textContent = userProfile.carbs_goal + 'g';
            document.getElementById('fatGoal').textContent = userProfile.fat_goal + 'g';

            // Generate demo food logs and store globally
            allFoodLogs = generateDemoLogs();
            
            // Filter and display data for current period
            const dateRange = getDateRange(currentPeriod);
            const filteredLogs = allFoodLogs.filter(log => {
                const logDate = log.date;
                return logDate >= dateRange.start && logDate <= dateRange.end;
            });
            
            // Update statistics and charts with filtered demo data
            updateStatistics(filteredLogs);
            updateCharts(filteredLogs);
            updateFoodLogsList(filteredLogs);

            // Hide loading screen and show main content
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Generate demo food logs
        function generateDemoLogs() {
            const foods = [
                { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∏‡πâ‡∏á', calories: 450, protein: 25, carbs: 65, fat: 12 },
                { name: '‡∏™‡πâ‡∏°‡∏ï‡∏≥', calories: 120, protein: 3, carbs: 25, fat: 2 },
                { name: '‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á', calories: 280, protein: 35, carbs: 0, fat: 14 },
                { name: '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô', calories: 320, protein: 20, carbs: 15, fat: 22 },
                { name: '‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏°', calories: 80, protein: 1, carbs: 20, fat: 0 },
                { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', calories: 350, protein: 4, carbs: 75, fat: 8 },
                { name: '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á', calories: 200, protein: 15, carbs: 12, fat: 10 },
                { name: '‡∏•‡∏≤‡∏ö‡∏´‡∏°‡∏π', calories: 180, protein: 22, carbs: 8, fat: 7 }
            ];

            const logs = [];
            const today = new Date();

            // Generate logs for the past 30 days
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                // 2-4 meals per day
                const mealsPerDay = Math.floor(Math.random() * 3) + 2;
                
                for (let j = 0; j < mealsPerDay; j++) {
                    const food = foods[Math.floor(Math.random() * foods.length)];
                    const portion = 0.7 + Math.random() * 0.6; // 0.7 to 1.3 portion
                    
                    logs.push({
                        food_name: food.name,
                        date: date.toISOString().split('T')[0],
                        calories: Math.round(food.calories * portion),
                        protein_g: Math.round(food.protein * portion),
                        carbs_g: Math.round(food.carbs * portion),
                        fat_g: Math.round(food.fat * portion),
                        created_at: date.toISOString()
                    });
                }
            }

            return logs.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Load user profile data from Supabase
        async function loadUserData() {
            try {
                const { data: profile, error: profileError } = await supabase
                    .from("tdee_calculations")
                    .select("tdee, weight, goal_calories")
                    .eq("line_user_id", currentUserId)
                    .single();

                if (profileError) {
                    console.error('Profile error:', profileError);
                    // Set default values if no profile found
                    userProfile = {
                        tdee: 2000,
                        weight: 70,
                        goal_calories: 2000
                    };
                } else {
                    userProfile = profile;
                }

                // Calculate nutrition goals based on TDEE (standard ratios)
                const calories = userProfile.goal_calories || userProfile.tdee;
                userProfile.protein_goal = Math.round((calories * 0.25) / 4); // 25% of calories from protein
                userProfile.carbs_goal = Math.round((calories * 0.50) / 4);   // 50% of calories from carbs
                userProfile.fat_goal = Math.round((calories * 0.25) / 9);     // 25% of calories from fat

                // Update UI with profile data
                document.getElementById('tdeeValue').textContent = userProfile.goal_calories || userProfile.tdee;
                document.getElementById('proteinGoal').textContent = userProfile.protein_goal + 'g';
                document.getElementById('carbsGoal').textContent = userProfile.carbs_goal + 'g';
                document.getElementById('fatGoal').textContent = userProfile.fat_goal + 'g';

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
            }
        }

        // Load food logs based on current period
        async function loadFoodLogs() {
            try {
                // Check if we're in demo mode
                if (!supabase) {
                    // Use stored demo data
                    const dateRange = getDateRange(currentPeriod);
                    const filteredLogs = allFoodLogs.filter(log => {
                        const logDate = log.date;
                        return logDate >= dateRange.start && logDate <= dateRange.end;
                    });

                    console.log(`Demo Mode - Period: ${currentPeriod}, Date range: ${dateRange.start} to ${dateRange.end}`);
                    console.log(`Total logs: ${allFoodLogs.length}, Filtered logs: ${filteredLogs.length}`);

                    updateStatistics(filteredLogs);
                    updateCharts(filteredLogs);
                    updateFoodLogsList(filteredLogs);
                    return;
                }

                // For real Supabase connection
                if (allFoodLogs.length === 0) {
                    // Get all logs first time only
                    const { data: logs, error: logsError } = await supabase
                        .from("food_logs")
                        .select("date, food_name, calories, protein_g, fat_g, carbs_g, created_at")
                        .eq("line_userid", currentUserId)
                        .order("date", { ascending: false });

                    if (logsError) {
                        console.error('Logs error:', logsError);
                        return;
                    }

                    allFoodLogs = logs;
                }

                // Filter logs based on current period
                const dateRange = getDateRange(currentPeriod);
                const filteredLogs = allFoodLogs.filter(log => {
                    const logDate = log.date;
                    return logDate >= dateRange.start && logDate <= dateRange.end;
                });

                console.log(`Period: ${currentPeriod}, Date range: ${dateRange.start} to ${dateRange.end}`);
                console.log(`Total logs: ${allFoodLogs.length}, Filtered logs: ${filteredLogs.length}`);

                // Update statistics
                updateStatistics(filteredLogs);
                
                // Update charts
                updateCharts(filteredLogs);
                
                // Update food logs list
                updateFoodLogsList(filteredLogs);

            } catch (error) {
                console.error('Error loading food logs:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ');
            }
        }

        // Get date range based on period
        function getDateRange(period) {
            const now = new Date();
            // Use local timezone for date calculations
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let start, end;

            switch (period) {
                case 'daily':
                    start = new Date(today);
                    end = new Date(today);
                    break;
                case 'weekly':
                    // Get start of current week (Sunday = 0)
                    const dayOfWeek = today.getDay();
                    start = new Date(today);
                    start.setDate(today.getDate() - dayOfWeek);
                    end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    break;
                case 'monthly':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
            }

            // Format dates as YYYY-MM-DD strings
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            return {
                start: formatDate(start),
                end: formatDate(end)
            };
        }

        // Update statistics cards
        function updateStatistics(logs) {
            const totals = logs.reduce((acc, log) => {
                acc.calories += log.calories || 0;
                acc.protein += log.protein_g || 0;
                acc.carbs += log.carbs_g || 0;
                acc.fat += log.fat_g || 0;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            // Update values
            document.getElementById('totalCalories').textContent = Math.round(totals.calories);
            document.getElementById('totalProtein').textContent = Math.round(totals.protein) + 'g';
            document.getElementById('totalCarbs').textContent = Math.round(totals.carbs) + 'g';
            document.getElementById('totalFat').textContent = Math.round(totals.fat) + 'g';

            // Update progress bars
            const targetCalories = userProfile.goal_calories || userProfile.tdee;
            const calorieProgress = Math.min((totals.calories / targetCalories) * 100, 100);
            const proteinProgress = Math.min((totals.protein / userProfile.protein_goal) * 100, 100);
            const carbsProgress = Math.min((totals.carbs / userProfile.carbs_goal) * 100, 100);
            const fatProgress = Math.min((totals.fat / userProfile.fat_goal) * 100, 100);

            document.getElementById('calorieProgress').style.width = calorieProgress + '%';
            document.getElementById('proteinProgress').style.width = proteinProgress + '%';
            document.getElementById('carbsProgress').style.width = carbsProgress + '%';
            document.getElementById('fatProgress').style.width = fatProgress + '%';

            // Update period summary
            updatePeriodSummary(logs);
        }

        // Update period summary
        function updatePeriodSummary(logs) {
            const summaryDiv = document.getElementById('periodSummary');
            
            if (currentPeriod === 'daily') {
                // Show daily warnings too
                if (!userProfile) {
                    summaryDiv.classList.add('hidden');
                    return;
                }

                // Calculate daily totals
                const totals = logs.reduce((acc, log) => {
                    acc.calories += log.calories || 0;
                    acc.protein += log.protein_g || 0;
                    acc.carbs += log.carbs_g || 0;
                    acc.fat += log.fat_g || 0;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

                const targetCalories = userProfile.goal_calories || userProfile.tdee;
                const warnings = [];
                
                // Check all nutrients for daily warnings
                if (totals.calories > targetCalories) {
                    const excess = totals.calories - targetCalories;
                    const dailyWarnings = [
                        `üî• ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏∞! üèÉ‚Äç‚ôÄÔ∏è`,
                        `üçî ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢! üòÖ`,
                        `‚ö†Ô∏è ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏•‡πâ‡∏ô ${Math.round(excess)} - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° 30 ‡∏ô‡∏≤‡∏ó‡∏µ! üö∂‚Äç‚ôÄÔ∏è`,
                        `üéà ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏ó‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÇ‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡πÇ‡∏õ‡πà‡∏á! üòÇ`
                    ];
                    warnings.push(dailyWarnings[Math.floor(Math.random() * dailyWarnings.length)]);
                }

                if (totals.protein > userProfile.protein_goal) {
                    const proteinWarnings = [
                        `üçñ ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! üí™`,
                        `ü•© ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å - ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏¢! üèãÔ∏è‚Äç‚ôÇÔ∏è`
                    ];
                    warnings.push(proteinWarnings[Math.floor(Math.random() * proteinWarnings.length)]);
                }

                if (totals.carbs > userProfile.carbs_goal) {
                    const carbWarnings = [
                        `üçû ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡∏∞! üôà`,
                        `üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ - ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‚ö°`
                    ];
                    warnings.push(carbWarnings[Math.floor(Math.random() * carbWarnings.length)]);
                }

                if (totals.fat > userProfile.fat_goal) {
                    const fatWarnings = [
                        `ü•ë ‡πÑ‡∏ü‡∏ï‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≠‡∏î! üòã`,
                        `üçü ‡∏ó‡∏≠‡∏î‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ - ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏•‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üõ¢Ô∏è`
                    ];
                    warnings.push(fatWarnings[Math.floor(Math.random() * fatWarnings.length)]);
                }

                // Always show daily summary, with or without warnings
                summaryDiv.classList.remove('hidden');
                document.getElementById('summaryIcon').textContent = warnings.length > 0 ? '‚ö†Ô∏è' : 'üìä';
                document.getElementById('summaryTitle').textContent = warnings.length > 0 ? '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô' : '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                document.getElementById('avgCalories').textContent = Math.round(totals.calories);
                document.getElementById('avgProtein').textContent = Math.round(totals.protein) + 'g';
                document.getElementById('avgCarbs').textContent = Math.round(totals.carbs) + 'g';
                document.getElementById('avgFat').textContent = Math.round(totals.fat) + 'g';
                
                let warningText = '';
                if (warnings.length > 0) {
                    warningText = `<div class="mt-3 p-3 bg-orange-100 rounded-lg border-l-4 border-orange-400">
                        <div class="text-sm text-orange-800">
                            <div class="font-semibold mb-2">üì¢ ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</div>
                            ${warnings.map(warning => `<div class="mb-1">‚Ä¢ ${warning}</div>`).join('')}
                        </div>
                    </div>`;
                } else {
                    const encouragements = [
                        'üéâ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏•‡∏¢!',
                        '‚ú® ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞!',
                        'üåü ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!',
                        'üëè ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏°‡∏õ‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ!'
                    ];
                    const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                    warningText = `<div class="mt-3 p-3 bg-green-100 rounded-lg border-l-4 border-green-400">
                        <div class="text-sm text-green-800 font-medium">${randomEncouragement}</div>
                    </div>`;
                }
                
                document.getElementById('summaryText').innerHTML = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ${warningText}`;
                return;
            }

            // Show summary for weekly and monthly
            summaryDiv.classList.remove('hidden');

            // Calculate unique days with data
            const uniqueDates = [...new Set(logs.map(log => log.date))];
            const totalDays = uniqueDates.length;

            // Calculate totals
            const totals = logs.reduce((acc, log) => {
                acc.calories += log.calories || 0;
                acc.protein += log.protein_g || 0;
                acc.carbs += log.carbs_g || 0;
                acc.fat += log.fat_g || 0;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            // Calculate averages per day
            const avgCalories = totalDays > 0 ? Math.round(totals.calories / totalDays) : 0;
            const avgProtein = totalDays > 0 ? Math.round(totals.protein / totalDays) : 0;
            const avgCarbs = totalDays > 0 ? Math.round(totals.carbs / totalDays) : 0;
            const avgFat = totalDays > 0 ? Math.round(totals.fat / totalDays) : 0;

            // Make sure userProfile exists before checking targets
            if (!userProfile) {
                console.log('userProfile not loaded yet');
                return;
            }

            // Check if exceeding targets and create warning messages
            const targetCalories = userProfile.goal_calories || userProfile.tdee;
            const warnings = [];
            
            if (avgCalories > targetCalories) {
                const excess = avgCalories - targetCalories;
                const calorieWarnings = [
                    `üî• ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${excess} kcal/‡∏ß‡∏±‡∏ô - ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡πâ‡∏ß‡∏ô‡∏ô‡∏∞! üòÖ`,
                    `üçî ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ${excess} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏à‡∏∞‡∏Ñ‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! üòÇ`,
                    `üö® ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô! ‡πÄ‡∏Å‡∏¥‡∏ô ${excess} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! üèÉ‚Äç‚ôÄÔ∏è`,
                    `‚ö†Ô∏è ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏•‡πâ‡∏ô ${excess} - ‡∏ó‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÇ‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡πÇ‡∏õ‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß! üéà`
                ];
                warnings.push(calorieWarnings[Math.floor(Math.random() * calorieWarnings.length)]);
            }
            
            if (avgProtein > userProfile.protein_goal) {
                const proteinWarnings = [
                    `üçñ ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ - ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! üí™`,
                    `ü•© ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å - ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üèãÔ∏è‚Äç‚ôÇÔ∏è`,
                    `üêÑ ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏±‡∏á - ‡∏ß‡∏±‡∏ß‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß! ü§£`,
                    `üí™ ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏•‡πâ‡∏ô - ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡∏à‡∏∞‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! üí•`
                ];
                warnings.push(proteinWarnings[Math.floor(Math.random() * proteinWarnings.length)]);
            }
            
            if (avgCarbs > userProfile.carbs_goal) {
                const carbWarnings = [
                    `üçû ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢ - ‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡∏•‡∏î‡∏´‡∏ß‡∏≤‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞! üôà`,
                    `üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å - ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏∏‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß! üòÜ`,
                    `üç∞ ‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡∏ü‡∏±‡∏ô‡∏à‡∏∞‡∏ú‡∏∏‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ü¶∑`,
                    `üçù ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏•‡πâ‡∏ô - ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£! ‚ö°`
                ];
                warnings.push(carbWarnings[Math.floor(Math.random() * carbWarnings.length)]);
            }
            
            if (avgFat > userProfile.fat_goal) {
                const fatWarnings = [
                    `ü•ë ‡πÑ‡∏ü‡∏ï‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ - ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≠‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞! üòã`,
                    `üçü ‡∏ó‡∏≠‡∏î‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ - ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏•‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üõ¢Ô∏è`,
                    `üßà ‡∏°‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡∏•‡∏∑‡πà‡∏ô‡∏à‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß! ü§™`,
                    `ü•ì ‡πÑ‡∏ü‡∏ï‡πå‡∏•‡πâ‡∏ô - ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‚ù§Ô∏è`
                ];
                warnings.push(fatWarnings[Math.floor(Math.random() * fatWarnings.length)]);
            }

            // Create warning text
            let warningText = '';
            if (warnings.length > 0) {
                warningText = `<div class="mt-3 p-3 bg-orange-100 rounded-lg border-l-4 border-orange-400">
                    <div class="text-sm text-orange-800">
                        <div class="font-semibold mb-2">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£:</div>
                        ${warnings.map(warning => `<div class="mb-1">‚Ä¢ ${warning}</div>`).join('')}
                    </div>
                </div>`;
            } else {
                const encouragements = [
                    'üéâ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!',
                    '‚ú® ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞!',
                    'üåü ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏î‡∏µ‡πÄ‡∏•‡∏¥‡∏®!',
                    'üëè ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏°‡∏õ‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ!'
                ];
                const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                warningText = `<div class="mt-3 p-3 bg-green-100 rounded-lg border-l-4 border-green-400">
                    <div class="text-sm text-green-800 font-medium">${randomEncouragement}</div>
                </div>`;
            }

            // Update UI elements
            document.getElementById('avgCalories').textContent = avgCalories;
            document.getElementById('avgProtein').textContent = avgProtein + 'g';
            document.getElementById('avgCarbs').textContent = avgCarbs + 'g';
            document.getElementById('avgFat').textContent = avgFat + 'g';

            // Update period-specific content
            if (currentPeriod === 'weekly') {
                document.getElementById('summaryIcon').textContent = 'üìä';
                document.getElementById('summaryTitle').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)';
                document.getElementById('summaryText').innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <span class="font-semibold">${totalDays}</span> ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ${warningText}`;
            } else if (currentPeriod === 'monthly') {
                document.getElementById('summaryIcon').textContent = 'üìà';
                document.getElementById('summaryTitle').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)';
                document.getElementById('summaryText').innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <span class="font-semibold">${totalDays}</span> ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ${warningText}`;
            }
        }

        // Update charts
        function updateCharts(logs) {
            const chartsSection = document.getElementById('chartsSection');
            
            if (currentPeriod === 'daily') {
                // Hide charts for daily view
                chartsSection.classList.add('hidden');
            } else {
                // Show charts for weekly and monthly
                chartsSection.classList.remove('hidden');
                updateCalorieChart(logs);
                updateMacroChart(logs);
            }
        }

        // Update calorie trend chart
        function updateCalorieChart(logs) {
            const ctx = document.getElementById('calorieChart').getContext('2d');
            
            // Group logs by date
            const dailyCalories = {};
            logs.forEach(log => {
                const date = log.date;
                if (!dailyCalories[date]) {
                    dailyCalories[date] = 0;
                }
                dailyCalories[date] += log.calories || 0;
            });

            const dates = Object.keys(dailyCalories).sort();
            const calories = dates.map(date => dailyCalories[date]);

            // Destroy existing chart
            if (calorieChart) {
                calorieChart.destroy();
                calorieChart = null;
            }

            // Ensure we have data to display
            if (dates.length === 0 || calories.length === 0) {
                console.log('No data for calorie chart');
                return;
            }

            // Wait a bit before creating new chart to ensure canvas is ready
            setTimeout(() => {
                try {
                    calorieChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates.map(date => {
                                const d = new Date(date + 'T00:00:00'); // Add time to avoid timezone issues
                                return currentPeriod === 'monthly' ? 
                                    `${d.getDate()}/${d.getMonth() + 1}` : 
                                    d.toLocaleDateString('th-TH');
                            }),
                            datasets: [{
                                label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà',
                                data: calories,
                                borderColor: '#F59E0B',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                pointBackgroundColor: '#FCD34D',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' kcal';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                    console.log('Calorie chart created successfully with', dates.length, 'data points');
                } catch (error) {
                    console.error('Error creating calorie chart:', error);
                }
            }, 100);
        }

        // Update macro distribution chart
        function updateMacroChart(logs) {
            const ctx = document.getElementById('macroChart').getContext('2d');
            
            const totals = logs.reduce((acc, log) => {
                acc.protein += log.protein_g || 0;
                acc.carbs += log.carbs_g || 0;
                acc.fat += log.fat_g || 0;
                return acc;
            }, { protein: 0, carbs: 0, fat: 0 });

            // Destroy existing chart
            if (macroChart) {
                macroChart.destroy();
                macroChart = null;
            }

            // Wait a bit before creating new chart to ensure canvas is ready
            setTimeout(() => {
                macroChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö', '‡πÑ‡∏ü‡∏ï‡πå'],
                        datasets: [{
                            data: [totals.protein * 4, totals.carbs * 4, totals.fat * 9],
                            backgroundColor: ['#F87171', '#60A5FA', '#4ADE80'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });
            }, 150);
        }

        // Update food logs list
        function updateFoodLogsList(logs) {
            const container = document.getElementById('foodLogsList');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üçΩÔ∏è</div>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.slice(0, 10).map(log => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                            <span class="text-lg">üçΩÔ∏è</span>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${log.food_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
                            <div class="text-sm text-gray-500">${new Date(log.date).toLocaleDateString('th-TH')}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-amber-800">${Math.round(log.calories || 0)} kcal</div>
                        <div class="text-xs text-gray-500">${Math.round(log.protein_g || 0)}P ${Math.round(log.carbs_g || 0)}C ${Math.round(log.fat_g || 0)}F</div>
                    </div>
                </div>
            `).join('');
        }

        // Change time period
        function changePeriod(period) {
            currentPeriod = period;
            
            // Update button styles
            document.querySelectorAll('.period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.className = 'period-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-amber-800 text-white';
                } else {
                    btn.className = 'period-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-amber-100 text-amber-800 hover:bg-amber-200';
                }
            });

            // Reload data
            loadFoodLogs();
        }

        // Show error screen
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
        }

        // Initialize app when page loads
        window.addEventListener('load', initApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9682e4897103d02b',t:'MTc1NDAyNTY5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
