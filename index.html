<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDEE Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brown': {
                            50: '#fdf8f6',
                            100: '#f2e8e5',
                            200: '#eaddd7',
                            300: '#e0cfc5',
                            400: '#d2bab0',
                            500: '#bfa094',
                            600: '#a18072',
                            700: '#977669',
                            800: '#846358',
                            900: '#43302b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-brown-50 to-brown-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-brown-600 rounded-full mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-brown-900 mb-2">TDEE Calculator</h1>
            <p class="text-brown-600">คำนวณความต้องการพลังงานรายวันของคุณ</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-brown-700" id="progress-text">ข้อมูลพื้นฐาน</span>
                <span class="text-sm font-medium text-brown-700" id="progress-count">1/3</span>
            </div>
            <div class="w-full bg-brown-200 rounded-full h-2">
                <div class="bg-brown-600 h-2 rounded-full transition-all duration-300" id="progress-bar" style="width: 33.33%"></div>
            </div>
        </div>

        <!-- Page 1: Basic Information -->
        <div id="page1" class="fade-in">
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-brown-600 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-brown-900">ข้อมูลพื้นฐาน</h2>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-brown-700 mb-2">ชื่อ-นามสกุล</label>
                        <input type="text" id="fullName" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent" placeholder="กรอกชื่อ-นามสกุล">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-brown-700 mb-2">อายุ</label>
                            <input type="number" id="age" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent" placeholder="ปี">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-brown-700 mb-2">เพศ</label>
                            <select id="gender" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                                <option value="">เลือกเพศ</option>
                                <option value="male">ชาย</option>
                                <option value="female">หญิง</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-brown-700 mb-2">ส่วนสูง (ซม.)</label>
                            <input type="number" id="height" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent" placeholder="เซนติเมตร">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-brown-700 mb-2">น้ำหนัก (กก.)</label>
                            <input type="number" id="weight" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent" placeholder="กิโลกรัม">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-brown-700 mb-2">ระดับกิจกรรม</label>
                        <select id="activityLevel" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                            <option value="">เลือกระดับกิจกรรม</option>
                            <option value="1.2">นั่งทำงาน ไม่ออกกำลังกาย</option>
                            <option value="1.375">ออกกำลังกายเบา ๆ 1-3 วัน/สัปดาห์</option>
                            <option value="1.55">ออกกำลังกายปานกลาง 3-5 วัน/สัปดาห์</option>
                            <option value="1.725">ออกกำลังกายหนัก 6-7 วัน/สัปดาห์</option>
                            <option value="1.9">ออกกำลังกายหนักมาก หรือมีงานใช้แรง</option>
                        </select>
                    </div>
                </div>

                <button onclick="nextPage()" class="w-full mt-8 bg-brown-600 hover:bg-brown-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    ถัดไป
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Page 2: Goals & Health Info -->
        <div id="page2" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-brown-600 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-brown-900">เป้าหมายและข้อมูลสุขภาพ</h2>
                </div>

                <div class="space-y-8">
                    <!-- Goals Section -->
                    <div class="border-b border-brown-100 pb-6">
                        <h3 class="text-lg font-medium text-brown-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-brown-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            เป้าหมายของคุณ
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-brown-700 mb-2">น้ำหนักเป้าหมาย (กก.)</label>
                                <input type="number" id="targetWeight" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent" placeholder="กิโลกรัม">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-brown-700 mb-2">เป้าหมาย</label>
                                <select id="goal" class="w-full px-4 py-3 border border-brown-200 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                                    <option value="">เลือกเป้าหมาย</option>
                                    <option value="lose_weight">ลดน้ำหนัก</option>
                                    <option value="maintain_weight">รักษาน้ำหนัก</option>
                                    <option value="gain_weight">เพิ่มน้ำหนัก</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Food Allergies Section -->
                    <div class="border-b border-brown-100 pb-6">
                        <h3 class="text-lg font-medium text-brown-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-brown-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            อาหารที่แพ้ (เลือกได้หลายรายการ)
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="นม" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">นม</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="ไข่" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ไข่</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="ถั่วลิสง" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ถั่วลิสง</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="ถั่วเหลือง" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ถั่วเหลือง</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="อาหารทะเล" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">อาหารทะเล</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="กุ้ง" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">กุ้ง</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="ปลา" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ปลา</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="ข้าวสาลี" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ข้าวสาลี</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="foodAllergies" value="งา" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">งา</span>
                            </label>
                        </div>
                    </div>

                    <!-- Chronic Diseases Section -->
                    <div>
                        <h3 class="text-lg font-medium text-brown-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-brown-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                            โรคประจำตัว (เลือกได้หลายรายการ)
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="เบาหวาน" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">เบาหวาน</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="ความดันโลหิตสูง" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ความดันโลหิตสูง</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="โรคหัวใจ" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">โรคหัวใจ</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="ไขมันในเลือดสูง" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">ไขมันในเลือดสูง</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="โรคไต" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">โรคไต</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="โรคตับ" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">โรคตับ</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="โรคภูมิแพ้" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">โรคภูมิแพ้</span>
                            </label>
                            <label class="flex items-center p-3 border border-brown-200 rounded-lg hover:bg-brown-50 cursor-pointer transition-colors">
                                <input type="checkbox" name="chronicDiseases" value="โรคหอบหืด" class="w-4 h-4 text-brown-600 border-brown-300 rounded focus:ring-brown-500">
                                <span class="ml-2 text-sm text-brown-700">โรคหอบหืด</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 mt-8">
                    <button onclick="prevPage()" class="flex-1 bg-brown-200 hover:bg-brown-300 text-brown-800 font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        ย้อนกลับ
                    </button>
                    <button onclick="calculateTDEE()" class="flex-1 bg-brown-600 hover:bg-brown-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        คำนวณ TDEE
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>



        <!-- Results Page -->
        <div id="results" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-500 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-brown-900 mb-2">ผลการคำนวณ TDEE</h2>
                    <p class="text-brown-600">ความต้องการพลังงานรายวันของคุณ</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-brown-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-brown-900 mb-2" id="bmiResult">-</div>
                        <div class="text-brown-600 font-medium">BMI</div>
                        <div class="text-sm text-brown-500 mt-1" id="bmiStatus">-</div>
                    </div>
                    <div class="bg-brown-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-brown-900 mb-2" id="tdeeResult">-</div>
                        <div class="text-brown-600 font-medium">TDEE (แคลอรี่/วัน)</div>
                    </div>
                </div>

                <div class="bg-brown-50 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-brown-900 mb-4">คำแนะนำสำหรับเป้าหมายของคุณ</h3>
                    <div id="recommendation" class="text-brown-700"></div>
                </div>

                <div class="flex gap-4">
                    <button onclick="startOver()" class="flex-1 bg-brown-200 hover:bg-brown-300 text-brown-800 font-medium py-3 px-6 rounded-lg transition-colors duration-200">
                        คำนวณใหม่
                    </button>
                    <button onclick="saveData()" class="flex-1 bg-brown-600 hover:bg-brown-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200" id="saveBtn">
                        บันทึกข้อมูล
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brown-600 mx-auto mb-4"></div>
                <p class="text-brown-700">กำลังบันทึกข้อมูล...</p>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let calculatedData = {};

        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressCount = document.getElementById('progress-count');
            
            const pages = ['ข้อมูลพื้นฐาน', 'เป้าหมายและสุขภาพ'];
            const width = (currentPage / 2) * 100;
            
            progressBar.style.width = width + '%';
            progressText.textContent = pages[currentPage - 1];
            progressCount.textContent = currentPage + '/2';
        }

        function showPage(pageNum) {
            // Hide all pages
            for (let i = 1; i <= 2; i++) {
                document.getElementById('page' + i).classList.add('hidden');
            }
            document.getElementById('results').classList.add('hidden');
            
            // Show current page
            if (pageNum <= 2) {
                document.getElementById('page' + pageNum).classList.remove('hidden');
                document.getElementById('page' + pageNum).classList.add('fade-in');
            } else {
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('results').classList.add('fade-in');
            }
            
            currentPage = pageNum;
            if (pageNum <= 2) {
                updateProgress();
            }
        }

        function validatePage1() {
            const fields = ['fullName', 'age', 'gender', 'height', 'weight', 'activityLevel'];
            for (let field of fields) {
                if (!document.getElementById(field).value) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return false;
                }
            }
            return true;
        }

        function validatePage2() {
            const fields = ['targetWeight', 'goal'];
            for (let field of fields) {
                if (!document.getElementById(field).value) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return false;
                }
            }
            return true;
        }

        function nextPage() {
            if (currentPage === 1 && !validatePage1()) return;
            if (currentPage === 2 && !validatePage2()) return;
            
            if (currentPage < 2) {
                showPage(currentPage + 1);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        }

        function calculateBMI(weight, height) {
            const heightInM = height / 100;
            return weight / (heightInM * heightInM);
        }

        function getBMIStatus(bmi) {
            if (bmi < 18.5) return 'น้ำหนักน้อย';
            if (bmi < 25) return 'น้ำหนักปกติ';
            if (bmi < 30) return 'น้ำหนักเกิน';
            return 'อ้วน';
        }

        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        function getTDEESuggestion(tdee, goal) {
            let suggestion = '';
            let calories = tdee;
            
            switch(goal) {
                case 'lose_weight':
                    calories = tdee - 500;
                    suggestion = `เพื่อลดน้ำหนัก ควรบริโภคประมาณ ${Math.round(calories)} แคลอรี่ต่อวัน (ลดจาก TDEE 500 แคลอรี่)`;
                    break;
                case 'maintain_weight':
                    suggestion = `เพื่อรักษาน้ำหนัก ควรบริโภคประมาณ ${Math.round(calories)} แคลอรี่ต่อวัน (ตาม TDEE)`;
                    break;
                case 'gain_weight':
                    calories = tdee + 500;
                    suggestion = `เพื่อเพิ่มน้ำหนัก ควรบริโภคประมาณ ${Math.round(calories)} แคลอรี่ต่อวัน (เพิ่มจาก TDEE 500 แคลอรี่)`;
                    break;
            }
            
            return { suggestion, calories };
        }

        function calculateTDEE() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseInt(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const activityLevel = parseFloat(document.getElementById('activityLevel').value);
            const goal = document.getElementById('goal').value;

            // Calculate BMI
            const bmi = calculateBMI(weight, height);
            const bmiStatus = getBMIStatus(bmi);

            // Calculate BMR
            const bmr = calculateBMR(weight, height, age, gender);
            
            // Calculate TDEE
            const tdee = bmr * activityLevel;
            
            // Get suggestion
            const { suggestion, calories } = getTDEESuggestion(tdee, goal);

            // Store calculated data
            calculatedData = {
                bmi: bmi.toFixed(1),
                bmiStatus: bmiStatus,
                tdee: Math.round(tdee),
                suggestion: suggestion,
                suggestedCalories: Math.round(calories)
            };

            // Display results
            document.getElementById('bmiResult').textContent = calculatedData.bmi;
            document.getElementById('bmiStatus').textContent = calculatedData.bmiStatus;
            document.getElementById('tdeeResult').textContent = calculatedData.tdee.toLocaleString();
            document.getElementById('recommendation').textContent = calculatedData.suggestion;

            showPage(4);
        }

        function getSelectedCheckboxes(name) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            const values = Array.from(checkboxes).map(cb => cb.value);
            return values.length > 0 ? values.join(', ') : 'ไม่มี';
        }

        function collectFormData() {
            const now = new Date();
            return {
                full_name: document.getElementById('fullName').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                target_weight_kg: document.getElementById('targetWeight').value,
                activity_level: document.getElementById('activityLevel').value,
                goal: document.getElementById('goal').value,
                bmi: calculatedData.bmi,
                tdee_calculated: calculatedData.tdee,
                tdee_suggest: calculatedData.suggestedCalories,
                food_allergies: getSelectedCheckboxes('foodAllergies'),
                chronic_diseases: getSelectedCheckboxes('chronicDiseases'),
                created_timestamp: now.toISOString()
            };
        }

        async function saveData() {
            const saveBtn = document.getElementById('saveBtn');
            const loading = document.getElementById('loading');
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'กำลังบันทึก...';
            loading.classList.remove('hidden');

            try {
                const formData = collectFormData();

                const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co'; //
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM'; //

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                const { data, error } = await supabase
  .from('tdee_profile')
  .insert([formData]);

if (error) {
  throw error;
}


                // Since we're using no-cors, we can't read the response
                // We'll assume success after a short delay
                setTimeout(() => {
                    loading.classList.add('hidden');
                    alert('บันทึกข้อมูลเรียบร้อยแล้ว!');
                    saveBtn.textContent = 'บันทึกแล้ว ✓';
                    saveBtn.classList.remove('bg-brown-600', 'hover:bg-brown-700');
                    saveBtn.classList.add('bg-green-500');
                }, 2000);

            } catch (error) {
                loading.classList.add('hidden');
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง');
                saveBtn.disabled = false;
                saveBtn.textContent = 'บันทึกข้อมูล';
            }
        }

        function startOver() {
            // Reset form
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.type === 'checkbox') {
                    element.checked = false;
                } else {
                    element.value = '';
                }
            });
            
            // Reset calculated data
            calculatedData = {};
            
            // Reset save button
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'บันทึกข้อมูล';
            saveBtn.classList.remove('bg-green-500');
            saveBtn.classList.add('bg-brown-600', 'hover:bg-brown-700');
            
            // Go back to first page
            showPage(1);
        }

        // Initialize
        showPage(1);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9673fd63c73dee35',t:'MTc1Mzg2OTQyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
