<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Cal Gallery</title>
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    html {
      width: 100%;
      height: 100%;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    .app-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .masonry-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 12px;
    }

    .masonry-item {
      break-inside: avoid;
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .masonry-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(193, 39, 45, 0.3);
    }

    .masonry-item img,
    .masonry-item video {
      width: 100%;
      height: auto;
      display: block;
    }

    .media-count-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      backdrop-filter: blur(10px);
    }

    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }

    .page.active {
      opacity: 1;
      pointer-events: auto;
    }

    .heart-icon {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .heart-icon.liked {
      fill: #C1272D;
      stroke: #C1272D;
      transform: scale(1.1);
    }

    .saved-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #C1272D;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      z-index: 10;
    }

    .comment-item {
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .nav-btn {
      color: #9CA3AF;
    }

    .nav-btn.active {
      color: #C1272D;
    }

    .nav-btn:hover {
      transform: scale(1.05);
    }

    .media-slider {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-radius: 16px;
      background: #000;
    }

    .media-slider-track {
      display: flex;
      transition: transform 0.3s ease-in-out;
    }

    .media-slide {
      min-width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .media-slide img,
    .media-slide video {
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
    }

    .slider-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .slider-nav-btn:hover {
      background: rgba(193, 39, 45, 0.8);
      transform: translateY(-50%) scale(1.1);
    }

    .slider-nav-btn.prev {
      left: 12px;
    }

    .slider-nav-btn.next {
      right: 12px;
    }

    .slider-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 16px 0;
    }

    .slider-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }

    .slider-dot.active {
      background: #C1272D;
      width: 24px;
      border-radius: 4px;
    }

    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #C1272D;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: #2D2D2D;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      max-width: 320px;
    }

    .emoji-picker.show {
      display: grid;
    }

    .emoji-btn {
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      background: transparent;
      border: none;
    }

    .emoji-btn:hover {
      background: rgba(193, 39, 45, 0.3);
      transform: scale(1.2);
    }

    .reply-input-container {
      display: none;
      margin-top: 12px;
      padding-left: 44px;
    }

    .reply-input-container.show {
      display: block;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container"><!-- Loading Overlay -->
   <div id="loading-overlay" class="loading-overlay">
    <div class="text-center">
     <div class="loading-spinner"></div>
     <p class="text-white mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
   </div><!-- PAGE 1: Gallery (Masonry Grid) -->
   <div id="gallery-page" class="page active">
    <div class="masonry-grid" style="padding-bottom: 80px;"><!-- Posts will be loaded here -->
    </div>
   </div><!-- PAGE 2: Saved -->
   <div id="saved-page" class="page">
    <div class="sticky top-0 bg-black z-10 px-4 py-4 border-b border-gray-800">
     <div class="flex items-center"><button onclick="navigateTo('gallery-page')" class="p-2">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
       </svg></button>
      <h1 class="flex-1 text-center text-xl font-bold text-white">Saved</h1>
      <div class="w-10"></div>
     </div>
    </div>
    <div id="saved-grid" class="masonry-grid" style="padding-bottom: 80px;"><!-- Saved items will be inserted here -->
    </div>
   </div><!-- PAGE 3: Comments -->
   <div id="comments-page" class="page">
    <div style="height: 100%; display: flex; flex-direction: column; background: #000;"><!-- Header -->
     <div class="bg-black px-4 py-4 border-b border-gray-800" style="flex-shrink: 0;">
      <div class="flex items-center"><button onclick="navigateTo('media-view-page')" class="p-2">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg></button>
       <h1 id="comments-title" class="flex-1 text-center text-lg font-semibold text-white">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</h1>
       <div class="w-10"></div>
      </div>
     </div><!-- Comments list -->
     <div style="flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 160px;" id="comments-container">
      <div id="comments-list"><!-- Comments will be loaded here -->
      </div>
     </div><!-- Comment input - FIXED POSITION -->
     <div style="position: fixed; bottom: 60px; left: 0; right: 0; background: #000; border-top: 1px solid #374151; z-index: 30; flex-shrink: 0;">
      <div style="padding: 16px; position: relative;"><!-- Emoji Picker -->
       <div id="emoji-picker" class="emoji-picker"></div>
       <div style="display: flex; align-items: center; gap: 12px; background: #3D3D3D; border-radius: 9999px; padding: 14px 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);"><button id="emoji-trigger" onclick="toggleEmojiPicker()" style="padding: 4px; background: transparent; border: none; cursor: pointer; font-size: 20px;"> üòä </button> <input type="text" id="comment-input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå..." style="flex: 1; background: transparent; color: white; outline: none; border: none; font-size: 15px;" onkeypress="if(event.key === 'Enter') postComment(event)"> <button onclick="postComment(event)" style="padding: 8px; background: #C1272D; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 36px; height: 36px; transition: all 0.2s;">
         <svg style="width: 20px; height: 20px; color: white; fill: white;" viewbox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
         </svg></button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- PAGE 4: Full Media View -->
   <div id="media-view-page" class="page">
    <div class="fade-in" style="height: 100%; overflow-y: auto;"><!-- Top bar -->
     <div class="sticky top-0 bg-black z-20 px-4 py-4 flex items-center justify-between"><button onclick="navigateTo('gallery-page')" class="p-2">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
       </svg></button>
      <h2 id="media-title" class="flex-1 text-center font-semibold text-white"></h2><button class="p-2">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
       </svg></button>
     </div><!-- Media Slider Container -->
     <div class="px-4 pb-6">
      <div class="media-slider shadow-2xl">
       <div id="media-slider-track" class="media-slider-track"><!-- Slides will be inserted here -->
       </div><!-- Navigation Buttons --> <button id="slider-prev" class="slider-nav-btn prev" onclick="previousSlide()" style="display: none;">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg></button> <button id="slider-next" class="slider-nav-btn next" onclick="nextSlide()" style="display: none;">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg></button>
      </div><!-- Slider Dots -->
      <div id="slider-dots" class="slider-dots"><!-- Dots will be inserted here -->
      </div>
     </div><!-- Actions row WITH HEART -->
     <div class="px-4 py-4 flex items-center gap-6"><button onclick="navigateTo('comments-page')" class="flex items-center gap-2">
       <svg class="w-7 h-7" fill="none" stroke="white" stroke-width="2" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
       </svg><span id="comment-count" class="text-white font-semibold">0</span> </button> <button id="like-btn" onclick="toggleLike()" class="flex items-center gap-2">
       <svg id="heart-icon" class="w-7 h-7 heart-icon" fill="none" stroke="white" stroke-width="2" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
       </svg><span id="like-count" class="text-white font-semibold">0</span> </button>
      <div class="flex-1"></div><button id="save-btn" onclick="toggleSave()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-full font-bold text-white transition-all"> Save </button>
     </div><!-- Post details -->
     <div class="px-4 py-4 border-t border-gray-800">
      <div class="flex items-center gap-3 mb-4"><img id="creator-avatar" class="w-10 h-10 rounded-full" src="" alt="Profile">
       <div>
        <p id="creator-name" class="font-semibold text-white"></p>
       </div>
      </div>
      <h3 id="post-title-detail" class="text-xl font-bold text-white mb-2"></h3>
      <p id="post-description" class="text-gray-400 text-sm mb-4"></p>
      <p id="post-date" class="text-gray-500 text-xs"></p><button onclick="navigateTo('comments-page')" id="view-comments-link" class="text-gray-400 text-sm hover:text-white transition-colors mt-2"> ‡∏î‡∏π‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î </button>
     </div>
    </div>
   </div><!-- Bottom Navigation Bar -->
   <div class="fixed bottom-0 left-0 right-0 bg-black border-t border-gray-800 px-4 py-3 z-50" style="box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);">
    <div class="flex items-center justify-around max-w-md mx-auto">
  <button 
    id="nav-gallery" 
    onclick="navigateToTab('gallery-page')" 
    class="flex flex-col items-center gap-1 transition-all nav-btn active"
  >
    <i class="fi fi-rr-house-blank text-xl"></i>
    <span>Gallery</span>
  </button>
</div>

      <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path>
      </svg><span class="text-xs font-semibold">Gallery</span> </button> <button id="nav-saved" onclick="navigateToTab('saved-page')" class="flex flex-col items-center gap-1 transition-all nav-btn">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
      </svg><span class="text-xs font-semibold">Saved</span> </button>
    </div>
   </div>
  </div>
  <script>
const LIFF_ID = '2007859046-z3WDAbWV';
const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';

let supabase;
let currentUser = null;
let allPosts = [];
let savedPosts = new Set();
let likedPosts = new Set();
let commentLikes = new Map();
let currentComments = [];
let currentMediaIndex = null;
let currentSlideIndex = 0;
let replyingToCommentId = null;

// Emoji list
const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üî•', '‚ú®', 'üí™', 'üéâ', 'üòç', 'ü•∞', 'üòé', 'üëè', 'üôè', 'üíØ', '‚≠ê', 'üéä', 'üåü', 'üíñ', 'üò≠', 'ü§î', 'üò±', 'ü§©', 'üëå', 'üôå'];

// Initialize Supabase
supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Initialize LIFF
async function initializeLiff() {
  try {
    console.log('üöÄ Starting LIFF initialization...');
    await liff.init({ liffId: LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      console.log('‚ùå User not logged in, redirecting to LINE login...');
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    currentUser = {
      lineUserId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl
    };
    
    console.log('‚úÖ Current user:', currentUser);
    
    await loadData();
    initializeEmojiPicker();
  } catch (error) {
    console.error('‚ùå LIFF initialization failed:', error);
    document.getElementById('loading-overlay').innerHTML = `
      <div class="text-center">
        <p class="text-white">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
        <p class="text-gray-400 text-sm mt-2">${error.message}</p>
      </div>
    `;
  }
}

// Initialize emoji picker
function initializeEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  picker.innerHTML = '';
  
  emojis.forEach(emoji => {
    const btn = document.createElement('button');
    btn.className = 'emoji-btn';
    btn.textContent = emoji;
    btn.onclick = () => insertEmoji(emoji);
    picker.appendChild(btn);
  });
}

// Toggle emoji picker
function toggleEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  picker.classList.toggle('show');
}

// Insert emoji
function insertEmoji(emoji) {
  const input = document.getElementById('comment-input');
  const cursorPos = input.selectionStart;
  const textBefore = input.value.substring(0, cursorPos);
  const textAfter = input.value.substring(cursorPos);
  
  input.value = textBefore + emoji + textAfter;
  input.focus();
  
  const newCursorPos = cursorPos + emoji.length;
  input.setSelectionRange(newCursorPos, newCursorPos);
  
  document.getElementById('emoji-picker').classList.remove('show');
}

// Close emoji picker when clicking outside
document.addEventListener('click', (e) => {
  const picker = document.getElementById('emoji-picker');
  const trigger = document.getElementById('emoji-trigger');
  
  if (picker && !picker.contains(e.target) && e.target !== trigger) {
    picker.classList.remove('show');
  }
});

// Load all data
async function loadData() {
  try {
    console.log('üìä Starting to load data...');
    
    // Load posts with media
    const { data: posts, error: postsError } = await supabase
      .from('user_challenges_proof')
      .select(`
        *,
        proof_media (
          media_url,
          media_type,
          media_order
        )
      `)
      .eq('is_verified', true)
      .order('proof_date', { ascending: false });
    
    if (postsError) {
      console.error('‚ùå Error loading posts:', postsError);
      throw postsError;
    }
    
    console.log('üì¶ Raw posts data:', posts);
    console.log('üìä Total posts loaded:', posts?.length || 0);
    
    // Process posts - support both proof_media and proof_image_url
    allPosts = posts.map(post => {
      let mediaArray = [];
      
      // First, check if proof_media has data (new system - multiple files)
      if (post.proof_media && post.proof_media.length > 0) {
        mediaArray = post.proof_media
          .sort((a, b) => a.media_order - b.media_order)
          .map(m => ({
            type: m.media_type || 'image',
            url: getStorageUrl(m.media_url)
          }));
      } 
      // Fallback to proof_image_url (old system - single image)
      else if (post.proof_image_url) {
        mediaArray = [{
          type: 'image',
          url: getStorageUrl(post.proof_image_url)
        }];
      }
      
      return {
        id: post.id,
        lineUserId: post.line_user_id,
        fullName: post.full_name,
        profilePictureUrl: post.profile_picture_url,
        challengeName: post.challenge_name,
        dayNumber: post.day_number,
        proofDate: post.proof_date,
        media: mediaArray
      };
    });
    
    // Filter out posts with no media
    allPosts = allPosts.filter(post => post.media.length > 0);
    
    console.log('‚úÖ Final allPosts to display:', allPosts.length);
    
    // Load saved posts
    const { data: saves, error: savesError } = await supabase
      .from('proof_saves')
      .select('proof_id')
      .eq('saver_line_user_id', currentUser.lineUserId);
    
    if (savesError) throw savesError;
    
    savedPosts = new Set(saves.map(s => s.proof_id));
    
    console.log('üíæ Saved posts:', savedPosts);
    
    // Load liked posts
    const { data: likes, error: likesError } = await supabase
      .from('proof_likes')
      .select('proof_id')
      .eq('liker_line_user_id', currentUser.lineUserId);
    
    if (!likesError && likes) {
      likedPosts = new Set(likes.map(l => l.proof_id));
    }
    
    // Render gallery
    renderGallery();
    renderSavedGrid();
    
    // Hide loading
    document.getElementById('loading-overlay').style.display = 'none';
    
  } catch (error) {
    console.error('‚ùå Error loading data:', error);
    document.getElementById('loading-overlay').innerHTML = `
      <div class="text-center">
        <p class="text-white">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
        <p class="text-gray-400 text-sm mt-2">${error.message}</p>
      </div>
    `;
  }
}

// Get storage URL
function getStorageUrl(path) {
  if (!path) return '';
  if (path.startsWith('http')) return path;
  
  // Remove leading slash if exists
  const cleanPath = path.startsWith('/') ? path.substring(1) : path;
  
  // Build public URL manually
  return `${SUPABASE_URL}/storage/v1/object/public/proof/${cleanPath}`;
}

// Navigation functions
function navigateTo(pageId) {
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  document.getElementById(pageId).classList.add('active');
}

function navigateToTab(pageId) {
  navigateTo(pageId);
  
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (pageId === 'gallery-page') {
    document.getElementById('nav-gallery').classList.add('active');
  } else if (pageId === 'saved-page') {
    document.getElementById('nav-saved').classList.add('active');
  }
}

// Toggle save
async function toggleSave() {
  if (currentMediaIndex === null) return;
  
  const post = allPosts[currentMediaIndex];
  const saveBtn = document.getElementById('save-btn');
  
  try {
    if (savedPosts.has(post.id)) {
      // Unsave
      const { error } = await supabase
        .from('proof_saves')
        .delete()
        .eq('proof_id', post.id)
        .eq('saver_line_user_id', currentUser.lineUserId);
      
      if (error) throw error;
      
      savedPosts.delete(post.id);
      saveBtn.textContent = 'Save';
      saveBtn.style.background = '#C1272D';
    } else {
      // Save
      const { error } = await supabase
        .from('proof_saves')
        .insert({
          proof_id: post.id,
          saver_line_user_id: currentUser.lineUserId
        });
      
      if (error) throw error;
      
      savedPosts.add(post.id);
      saveBtn.textContent = 'Saved ‚úì';
      saveBtn.style.background = '#000000';
    }
    
    renderSavedGrid();
  } catch (error) {
    console.error('Error toggling save:', error);
  }
}

// Toggle like
async function toggleLike() {
  if (currentMediaIndex === null) return;
  
  const post = allPosts[currentMediaIndex];
  const heartIcon = document.getElementById('heart-icon');
  const likeCountEl = document.getElementById('like-count');
  
  try {
    if (likedPosts.has(post.id)) {
      // Unlike
      const { error } = await supabase
        .from('proof_likes')
        .delete()
        .eq('proof_id', post.id)
        .eq('liker_line_user_id', currentUser.lineUserId);
      
      if (error) throw error;
      
      likedPosts.delete(post.id);
      heartIcon.classList.remove('liked');
    } else {
      // Like
      const { error } = await supabase
        .from('proof_likes')
        .insert({
          proof_id: post.id,
          liker_line_user_id: currentUser.lineUserId
        });
      
      if (error) throw error;
      
      likedPosts.add(post.id);
      heartIcon.classList.add('liked');
    }
    
    // Update like count
    await updateLikeCount(post.id);
    
  } catch (error) {
    console.error('Error toggling like:', error);
  }
}

// Update like count
async function updateLikeCount(proofId) {
  try {
    const { count, error } = await supabase
      .from('proof_likes')
      .select('*', { count: 'exact', head: true })
      .eq('proof_id', proofId);
    
    if (!error) {
      document.getElementById('like-count').textContent = count || 0;
    }
  } catch (error) {
    console.error('Error updating like count:', error);
  }
}

// Toggle comment like
async function toggleCommentLike(commentId, heartElement, countElement) {
  try {
    const isLiked = commentLikes.has(commentId);
    
    if (isLiked) {
      // Unlike comment
      const { error } = await supabase
        .from('comment_likes')
        .delete()
        .eq('comment_id', commentId)
        .eq('liker_line_user_id', currentUser.lineUserId);
      
      if (error) throw error;
      
      commentLikes.delete(commentId);
      heartElement.classList.remove('liked');
    } else {
      // Like comment
      const { error } = await supabase
        .from('comment_likes')
        .insert({
          comment_id: commentId,
          liker_line_user_id: currentUser.lineUserId
        });
      
      if (error) throw error;
      
      commentLikes.add(commentId);
      heartElement.classList.add('liked');
    }
    
    // Update count
    const { count } = await supabase
      .from('comment_likes')
      .select('*', { count: 'exact', head: true })
      .eq('comment_id', commentId);
    
    countElement.textContent = count || 0;
    
  } catch (error) {
    console.error('Error toggling comment like:', error);
  }
}

// Show reply input
function showReplyInput(commentId) {
  replyingToCommentId = commentId;
  const input = document.getElementById('comment-input');
  input.placeholder = '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...';
  input.focus();
}

// Slider functions
function goToSlide(index) {
  if (currentMediaIndex === null) return;
  const post = allPosts[currentMediaIndex];
  const totalSlides = post.media.length;
  
  currentSlideIndex = Math.max(0, Math.min(index, totalSlides - 1));
  
  const track = document.getElementById('media-slider-track');
  track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
  
  updateSliderControls();
}

function previousSlide() {
  goToSlide(currentSlideIndex - 1);
}

function nextSlide() {
  goToSlide(currentSlideIndex + 1);
}

function updateSliderControls() {
  if (currentMediaIndex === null) return;
  const post = allPosts[currentMediaIndex];
  const totalSlides = post.media.length;
  
  const prevBtn = document.getElementById('slider-prev');
  const nextBtn = document.getElementById('slider-next');
  
  if (totalSlides > 1) {
    prevBtn.style.display = currentSlideIndex > 0 ? 'flex' : 'none';
    nextBtn.style.display = currentSlideIndex < totalSlides - 1 ? 'flex' : 'none';
  } else {
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
  }
  
  const dotsContainer = document.getElementById('slider-dots');
  dotsContainer.innerHTML = '';
  
  if (totalSlides > 1) {
    for (let i = 0; i < totalSlides; i++) {
      const dot = document.createElement('div');
      dot.className = 'slider-dot' + (i === currentSlideIndex ? ' active' : '');
      dot.onclick = () => goToSlide(i);
      dotsContainer.appendChild(dot);
    }
  }
}

// Load comments for current post
async function loadComments() {
  if (currentMediaIndex === null) return;
  
  const post = allPosts[currentMediaIndex];
  
  try {
    // Get comments first
    const { data: comments, error: commentsError } = await supabase
      .from('proof_comments')
      .select('*')
      .eq('proof_id', post.id)
      .order('created_at', { ascending: false });
    
    if (commentsError) throw commentsError;
    
    // Get unique commenter IDs
    const commenterIds = [...new Set(comments.map(c => c.commenter_line_user_id))];
    
    // Get commenter profiles from user_profiles
    const { data: profiles, error: profilesError } = await supabase
      .from('user_profiles')
      .select('line_user_id, display_name, profile_picture_url')
      .in('line_user_id', commenterIds);
    
    if (profilesError) throw profilesError;
    
    // Create a map of profiles
    const profileMap = new Map();
    profiles.forEach(p => {
      profileMap.set(p.line_user_id, p);
    });
    
    // Merge comments with profiles
    currentComments = comments.map(comment => ({
      ...comment,
      commenter_profile: profileMap.get(comment.commenter_line_user_id)
    }));
    
    // Load comment likes for current user
    const { data: commentLikesData } = await supabase
      .from('comment_likes')
      .select('comment_id')
      .eq('liker_line_user_id', currentUser.lineUserId)
      .in('comment_id', comments.map(c => c.id));
    
    commentLikes = new Map();
    if (commentLikesData) {
      commentLikesData.forEach(like => {
        commentLikes.add(like.comment_id);
      });
    }
    
    renderComments();
    
    // Update comment count
    document.getElementById('comment-count').textContent = currentComments.length;
    
  } catch (error) {
    console.error('Error loading comments:', error);
  }
}

// Render comments
async function renderComments() {
  const commentsList = document.getElementById('comments-list');
  commentsList.innerHTML = '';
  
  if (currentComments.length === 0) {
    commentsList.innerHTML = `
      <div class="text-center py-10">
        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</p>
      </div>
    `;
    return;
  }
  
  for (const comment of currentComments) {
    const commentDiv = document.createElement('div');
    commentDiv.className = 'comment-item flex gap-3 mb-6';
    
    const commenterData = comment.commenter_profile;
    const profilePic = commenterData?.profile_picture_url || 'https://via.placeholder.com/32';
    const displayName = commenterData?.display_name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    
    const createdAt = new Date(comment.created_at);
    const timeAgo = getTimeAgo(createdAt);
    
    // Get like count for this comment
    const { count: likeCount } = await supabase
      .from('comment_likes')
      .select('*', { count: 'exact', head: true })
      .eq('comment_id', comment.id);
    
    const isLiked = commentLikes.has(comment.id);
    
    commentDiv.innerHTML = `
      <img src="${profilePic}" class="w-8 h-8 rounded-full flex-shrink-0" alt="Profile">
      <div class="flex-1">
        <div class="flex items-center gap-2 mb-1">
          <span class="font-semibold text-white text-sm">${displayName}</span>
          <span class="text-gray-500 text-xs">${timeAgo}</span>
        </div>
        <p class="text-white text-sm mb-2">${escapeHtml(comment.comment_text)}</p>
        <div class="flex items-center gap-4">
          <button onclick="toggleCommentLike('${comment.id}', this.querySelector('.heart-icon'), this.querySelector('span'))" class="flex items-center gap-1 text-gray-400 hover:text-white transition-colors text-xs">
            <svg class="w-4 h-4 heart-icon ${isLiked ? 'liked' : ''}" fill="${isLiked ? '#C1272D' : 'none'}" stroke="${isLiked ? '#C1272D' : 'currentColor'}" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
            <span>${likeCount || 0}</span>
          </button>
          <button onclick="showReplyInput('${comment.id}')" class="text-gray-400 hover:text-white transition-colors text-xs font-semibold">
            ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
          </button>
        </div>
      </div>
    `;
    
    commentsList.appendChild(commentDiv);
  }
}

// Post new comment
async function postComment(event) {
  if (event) {
    event.preventDefault();
  }
  
  if (currentMediaIndex === null) return;
  
  const input = document.getElementById('comment-input');
  const commentText = input.value.trim();
  
  if (!commentText) return;
  
  const post = allPosts[currentMediaIndex];
  
  try {
    // Insert the comment
    const { data: newComment, error } = await supabase
      .from('proof_comments')
      .insert({
        proof_id: post.id,
        commenter_line_user_id: currentUser.lineUserId,
        comment_text: commentText,
        parent_comment_id: replyingToCommentId
      })
      .select()
      .single();
    
    if (error) throw error;
    
    // Get commenter profile from user_profiles
    const { data: profile, error: profileError } = await supabase
      .from('user_profiles')
      .select('line_user_id, display_name, profile_picture_url')
      .eq('line_user_id', currentUser.lineUserId)
      .single();
    
    if (profileError) {
      console.error('Error loading profile:', profileError);
    }
    
    // Add commenter profile to comment
    const commentWithProfile = {
      ...newComment,
      commenter_profile: profile || {
        line_user_id: currentUser.lineUserId,
        display_name: currentUser.displayName,
        profile_picture_url: currentUser.pictureUrl
      }
    };
    
    // Add new comment to the top
    currentComments.unshift(commentWithProfile);
    renderComments();
    
    // Update comment count
    document.getElementById('comment-count').textContent = currentComments.length;
    
    // Clear input and reset reply state
    input.value = '';
    input.placeholder = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå...';
    replyingToCommentId = null;
    
  } catch (error) {
    console.error('Error posting comment:', error);
  }
}

// Helper function: Get time ago
function getTimeAgo(date) {
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);
  
  if (seconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
  
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  const days = Math.floor(hours / 24);
  if (days < 7) return `${days} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  const weeks = Math.floor(days / 7);
  if (weeks < 4) return `${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Helper function: Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Open media view
function openMediaView(index) {
  currentMediaIndex = index;
  currentSlideIndex = 0;
  const post = allPosts[index];
  
  // Build slider - ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const sliderTrack = document.getElementById('media-slider-track');
  sliderTrack.innerHTML = '';
  sliderTrack.style.transform = 'translateX(0)';
  
  post.media.forEach(media => {
    const slide = document.createElement('div');
    slide.className = 'media-slide';
    
    if (media.type === 'video') {
      slide.innerHTML = `
        <video controls class="w-full">
          <source src="${media.url}" type="video/mp4">
        </video>
      `;
    } else {
      slide.innerHTML = `
        <img src="${media.url}" alt="Media" class="w-full h-auto">
      `;
    }
    
    sliderTrack.appendChild(slide);
  });
  
  // Update post details
  document.getElementById('media-title').textContent = `${post.challengeName} - Day ${post.dayNumber}`;
  document.getElementById('post-title-detail').textContent = `${post.challengeName} - Day ${post.dayNumber}`;
  document.getElementById('post-description').textContent = post.fullName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
  
  const proofDate = new Date(post.proofDate);
  document.getElementById('post-date').textContent = proofDate.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  // Set creator info
  const creatorAvatar = document.getElementById('creator-avatar');
  creatorAvatar.src = post.profilePictureUrl || 'https://via.placeholder.com/40';
  document.getElementById('creator-name').textContent = post.fullName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
  
  // Update save button
  const saveBtn = document.getElementById('save-btn');
  if (savedPosts.has(post.id)) {
    saveBtn.textContent = 'Saved ‚úì';
    saveBtn.style.background = '#000000';
  } else {
    saveBtn.textContent = 'Save';
    saveBtn.style.background = '#C1272D';
  }
  
  // Update heart icon
  const heartIcon = document.getElementById('heart-icon');
  if (likedPosts.has(post.id)) {
    heartIcon.classList.add('liked');
  } else {
    heartIcon.classList.remove('liked');
  }
  
  updateSliderControls();
  loadComments();
  updateLikeCount(post.id);
  navigateTo('media-view-page');
}

// Render gallery
function renderGallery() {
  console.log('üé® Rendering gallery with', allPosts.length, 'posts');
  
  const grid = document.querySelector('#gallery-page .masonry-grid');
  grid.innerHTML = '';
  
  if (allPosts.length === 0) {
    grid.innerHTML = `
      <div class="col-span-2 text-center py-20">
        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
      </div>
    `;
    return;
  }
  
  allPosts.forEach((post, index) => {
    const div = document.createElement('div');
    div.className = 'masonry-item';
    div.onclick = () => openMediaView(index);
    
    const firstMedia = post.media[0];
    const mediaCount = post.media.length;
    
    if (firstMedia && firstMedia.type === 'video') {
      div.innerHTML = `
        <div class="relative" style="height: 300px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
          <video src="${firstMedia.url}" class="w-full h-full object-cover"></video>
          ${mediaCount > 1 ? `<div class="media-count-badge">1/${mediaCount}</div>` : ''}
        </div>
      `;
    } else if (firstMedia) {
      div.innerHTML = `
        <div class="relative">
          <img src="${firstMedia.url}" alt="Gallery image" class="w-full h-auto" style="display: block;">
          ${mediaCount > 1 ? `<div class="media-count-badge">1/${mediaCount}</div>` : ''}
        </div>
      `;
    }
    
    grid.appendChild(div);
  });
  
  console.log('‚úÖ Gallery rendered successfully');
}

// Render saved grid
function renderSavedGrid() {
  const grid = document.getElementById('saved-grid');
  grid.innerHTML = '';
  
  const savedArray = allPosts.filter(post => savedPosts.has(post.id));
  
  if (savedArray.length === 0) {
    grid.innerHTML = `
      <div class="col-span-2 text-center py-20">
        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
      </div>
    `;
    return;
  }
  
  savedArray.forEach((post) => {
    const div = document.createElement('div');
    div.className = 'masonry-item';
    const itemIndex = allPosts.findIndex(p => p.id === post.id);
    div.onclick = () => {
      openMediaView(itemIndex);
      navigateTo('media-view-page');
    };
    
    const firstMedia = post.media[0];
    const mediaCount = post.media.length;
    
    if (firstMedia && firstMedia.type === 'video') {
      div.innerHTML = `
        <div class="relative" style="height: 300px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
          <video src="${firstMedia.url}" class="w-full h-full object-cover"></video>
          <div class="saved-badge">‚úì</div>
          ${mediaCount > 1 ? `<div class="media-count-badge" style="top: 8px; right: 48px;">1/${mediaCount}</div>` : ''}
        </div>
      `;
    } else if (firstMedia) {
      div.innerHTML = `
        <div class="relative">
          <img src="${firstMedia.url}" alt="Saved image" class="w-full h-auto" style="display: block;">
          <div class="saved-badge">‚úì</div>
          ${mediaCount > 1 ? `<div class="media-count-badge" style="top: 8px; right: 48px;">1/${mediaCount}</div>` : ''}
        </div>
      `;
    }
    
    grid.appendChild(div);
  });
}

// Initialize app
initializeLiff();
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ab37200d3a2d336',t:'MTc2NTI3MjIyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

