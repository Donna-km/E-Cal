<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Cal Gallery</title>
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.4.0/uicons-solid-rounded/css/uicons-solid-rounded.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    html {
      width: 100%;
      height: 100%;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    .app-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .masonry-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 12px;
    }

    .masonry-item {
      break-inside: avoid;
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .masonry-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(193, 39, 45, 0.3);
    }

    .masonry-item img,
    .masonry-item video {
      width: 100%;
      height: auto;
      display: block;
    }

    .media-count-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      backdrop-filter: blur(10px);
    }

    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }

    .page.active {
      opacity: 1;
      pointer-events: auto;
    }

    .heart-icon {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .heart-icon.liked {
      fill: #C1272D;
      stroke: #C1272D;
      transform: scale(1.1);
    }

    .saved-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #C1272D;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: bold;
      z-index: 10;
    }

    .comment-item {
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .nav-btn {
      color: #9CA3AF;
    }

    .nav-btn.active {
      color: #C1272D;
    }

    .nav-btn:hover {
      transform: scale(1.05);
    }

    .media-slider {
  position: relative;
  width: 100vw;
  height: 100vh;
  border-radius: 0;
  overflow: hidden;
  background: black;
}


    .media-slider-track {
      display: flex;
      transition: transform 0.3s ease-in-out;
    }

    .media-slide {
      min-width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

   .media-slide img,
.media-slide video {
  width: 100vw !important;
  height: 100vh !important;
  object-fit: cover !important;
}


    .slider-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .slider-nav-btn:hover {
      background: rgba(193, 39, 45, 0.8);
      transform: translateY(-50%) scale(1.1);
    }

    .slider-nav-btn.prev {
      left: 12px;
    }

    .slider-nav-btn.next {
      right: 12px;
    }

    .slider-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 16px 0;
    }

    .slider-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }

    .slider-dot.active {
      background: #C1272D;
      width: 24px;
      border-radius: 4px;
    }

    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #C1272D;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: #2D2D2D;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      max-width: 320px;
    }

    .emoji-picker.show {
      display: grid;
    }

    .emoji-btn {
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      background: transparent;
      border: none;
    }

    .emoji-btn:hover {
      background: rgba(193, 39, 45, 0.3);
      transform: scale(1.2);
    }

    .reply-input-container {
      display: none;
      margin-top: 12px;
      padding-left: 44px;
    }

    .reply-input-container.show {
      display: block;
    }

   .floating-actions {
  position: absolute;
  right: 16px;
  top: 55%;
  display: flex;
  flex-direction: column;
  gap: 22px;
  z-index: 50;
}

.fab-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: white;
}

.fab-text {
  margin-top: 4px;
  font-size: 14px;
  font-weight: bold;
}

.save-btn {
  margin-top: 6px;              /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î */
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

/* icon default (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà save) */
.save-btn i {
  font-size: 28px;              /* üëà ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  color: white;
  transition: all 0.2s ease;
}

/* saved state */
.save-btn.saved i {
  color: #ef4444;               /* ‡πÅ‡∏î‡∏á */
  fill: #ef4444;   /* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ */
  transform: scale(1.05);       /* ‡πÄ‡∏î‡πâ‡∏á‡∏ô‡∏¥‡∏î */
}

/* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç count */
.save-btn .fab-text {
  font-size: 13px;              /* üëà ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
  line-height: 1;
  color: white;
}

/* count ‡∏ï‡∏≠‡∏ô saved */
.save-btn.saved .fab-text {
  color: #ef4444;
  font-weight: 600;
}
   
#media-view-page {
  overflow: hidden !important;
}

   html, body {
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
}

#media-view-page {
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
}

   /* ===== Reels Vertical Snap Animation ===== */
.media-slider {
  will-change: transform;
  transition: transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
}




  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container"><!-- Loading Overlay -->
   <div id="loading-overlay" class="loading-overlay">
    <div class="text-center">
     <div class="loading-spinner"></div>
     <p class="text-white mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
   </div><!-- PAGE 1: Gallery (Masonry Grid) -->
   <div id="gallery-page" class="page active">
    <div class="masonry-grid" style="padding-bottom: 80px;"><!-- Posts will be loaded here -->
    </div>
   </div><!-- PAGE 2: Saved -->
   <div id="saved-page" class="page">
    <div class="sticky top-0 bg-black z-10 px-4 py-4 border-b border-gray-800">
     <div class="flex items-center"><button onclick="navigateTo('gallery-page')" class="p-2">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
       </svg></button>
      <h1 class="flex-1 text-center text-xl font-bold text-white">Saved</h1>
      <div class="w-10"></div>
     </div>
    </div>
    <div id="saved-grid" class="masonry-grid" style="padding-bottom: 80px;"><!-- Saved items will be inserted here -->
    </div>
   </div><!-- PAGE 3: Comments -->
   <div id="comments-page" class="page">
    <div style="height: 100%; display: flex; flex-direction: column; background: #000;"><!-- Header -->
     <div class="bg-black px-4 py-4 border-b border-gray-800" style="flex-shrink: 0;">
      <div class="flex items-center"><button onclick="navigateTo('media-view-page')" class="p-2">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg></button>
       <h1 id="comments-title" class="flex-1 text-center text-lg font-semibold text-white">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</h1>
       <div class="w-10"></div>
      </div>
     </div><!-- Comments list -->
     <div style="flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 160px;" id="comments-container">
      <div id="comments-list"><!-- Comments will be loaded here -->
      </div>
     </div><!-- Comment input - FIXED POSITION -->
     <div style="position: fixed; bottom: 60px; left: 0; right: 0; background: #000; border-top: 1px solid #374151; z-index: 30; flex-shrink: 0;">
      <div style="padding: 16px; position: relative;"><!-- Emoji Picker -->
       <div id="emoji-picker" class="emoji-picker"></div>
       <div style="display: flex; align-items: center; gap: 12px; background: #3D3D3D; border-radius: 9999px; padding: 14px 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);"><button id="emoji-trigger" onclick="toggleEmojiPicker()" style="padding: 4px; background: transparent; border: none; cursor: pointer; font-size: 20px;"> üòä </button> <input type="text" id="comment-input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå..." style="flex: 1; background: transparent; color: white; outline: none; border: none; font-size: 15px;" onkeypress="if(event.key === 'Enter') postComment(event)"> <button onclick="postComment(event)" style="padding: 8px; background: #C1272D; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 36px; height: 36px; transition: all 0.2s;">
         <svg style="width: 20px; height: 20px; color: white; fill: white;" viewbox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
         </svg></button>
       </div>
      </div>
     </div>
    </div>
   </div>

   <!-- PAGE 4: Full Media View -->
<div id="media-view-page" class="page">

 <div class="fade-in" style="height: 100%; overflow: hidden; position: relative;">

    <!-- Floating Top Bar -->
    <div class="absolute top-4 left-0 right-0 z-30 flex items-center justify-between px-4 pointer-events-none">

      <button onclick="stopAllVideos(); navigateTo('gallery-page')" 
              class="pointer-events-auto p-2 bg-black/40 rounded-full backdrop-blur-sm">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M15 19l-7-7 7-7"/>
          </svg>
      </button>

      <h2 id="media-title" class="text-white font-semibold pointer-events-none"></h2>

      <div class="w-6 h-6"></div>
    </div>

    <!-- Media Slider Container -->
    <div class="p-0 m-0">
      <div class="media-slider relative z-10">
        <div id="media-slider-track" class="media-slider-track">
        </div>
       
<!-- üîä Sound toggle -->
<div id="sound-hint" class="absolute top-16 right-4 z-40">
  <button
    onclick="toggleSound()"
    class="bg-black/60 text-white p-3 rounded-full backdrop-blur-sm">
    <i id="sound-icon" class="fi fi-rr-volume-slash"></i>
  </button>
</div>
       
      <!-- Slide Count -->
<div id="slide-counter"
  class="absolute top-6 right-4 z-40 bg-black/40 text-white px-3 py-1 rounded-full text-sm backdrop-blur-sm pointer-events-none"
  style="font-weight: 500;">
</div>


</div> <!-- end .media-slider -->

<div id="slider-dots" class="slider-dots"></div>
</div> <!-- end outer container -->


    <!-- ‚≠ê Floating Profile Overlay (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) -->
    <div id="floating-overlay"
         class="absolute bottom-20 left-4 z-40 flex items-center gap-3 pointer-events-none">

      <img id="floating-avatar"
           class="w-10 h-10 rounded-full border border-white/40 shadow-lg" />

      <div class="flex flex-col">
        <span id="floating-name"
              class="text-white font-semibold text-base drop-shadow"></span>

        <span id="floating-caption"
              class="text-gray-300 text-xs drop-shadow max-w-[250px]"></span>
      </div>
    </div>


    <!-- Floating Action Buttons -->
    <div class="floating-actions z-50">

      <button id="like-btn" onclick="toggleLike()" class="fab-btn">
        <svg id="heart-icon" class="w-8 h-8 heart-icon" fill="none" stroke="white" stroke-width="2" 
              viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <span id="like-count" class="fab-text">0</span>
      </button>

      <button onclick="navigateTo('comments-page')" class="fab-btn">
        <svg class="w-8 h-8" fill="none" stroke="white" stroke-width="2"
              viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <span id="comment-count" class="fab-text">0</span>
      </button>

      <button id="save-btn"
        onclick="toggleSave()"
        class="fab-btn save-btn flex flex-col items-center gap-1">

  <i id="save-icon" class="fi fi-rr-bookmark text-white text-3xl"></i>
  <span id="save-count" class="fab-text">0</span>
</button>

    </div>
  </div>
</div>

     
     <!-- Post details -->
     <div class="px-4 py-4 border-t border-gray-800">
      <div class="flex items-center gap-3 mb-4"><img id="creator-avatar" class="w-10 h-10 rounded-full" src="" alt="Profile">
       <div>
        <p id="creator-name" class="font-semibold text-white"></p>
       </div>
      </div>
      <h3 id="post-title-detail" class="text-xl font-bold text-white mb-2"></h3>
      <p id="post-description" class="text-gray-400 text-sm mb-4"></p>
      <p id="post-date" class="text-gray-500 text-xs"></p><button onclick="navigateTo('comments-page')" id="view-comments-link" class="text-gray-400 text-sm hover:text-white transition-colors mt-2"> ‡∏î‡∏π‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î </button>
     </div>
    </div>
   </div>
  
   <!-- Bottom Navigation Bar -->
<div class="fixed bottom-0 left-0 right-0 bg-black border-t border-gray-800 px-4 py-3 z-50"
     style="box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);">

  <div class="flex items-center justify-around max-w-md mx-auto">

    <!-- Gallery -->
    <button id="nav-gallery" 
            onclick="navigateToTab('gallery-page')" 
            class="flex flex-col items-center gap-1 transition-all nav-btn active">

      <i class="fi fi-rr-house-blank text-xl"></i>
      <span class="text-xs font-semibold">Gallery</span>
    </button>

    <!-- Saved -->
    <button id="nav-saved" 
            onclick="navigateToTab('saved-page')" 
            class="flex flex-col items-center gap-1 transition-all nav-btn">

      <i class="fi fi-rr-bookmark text-xl"></i>
      <span class="text-xs font-semibold">Saved</span>
    </button>
  </div>
</div>

  <script>
const LIFF_ID = '2007859046-z3WDAbWV';
const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';

let supabase;
let currentUser = null;
let allPosts = [];
let savedPosts = new Set();
let currentSaveCount = 0;   
let likedPosts = new Set();
let commentLikes = new Set();
let currentComments = [];
let currentMediaIndex = null;
let currentSlideIndex = 0;
let startY = 0;
let verticalSwipeHandled = false; 
let isAnimatingPost = false;   
let replyingToCommentId = null;

// Emoji list
const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üî•', '‚ú®', 'üí™', 'üéâ', 'üòç', 'ü•∞', 'üòé', 'üëè', 'üôè', 'üíØ', '‚≠ê', 'üéä', 'üåü', 'üíñ', 'üò≠', 'ü§î', 'üò±', 'ü§©', 'üëå', 'üôå'];

// Initialize Supabase
supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Initialize LIFF
async function initializeLiff() {
  try {
    console.log('üöÄ Starting LIFF initialization...');
    await liff.init({ liffId: LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      console.log('‚ùå User not logged in, redirecting to LINE login...');
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    currentUser = {
      lineUserId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl
    };
    
    console.log('‚úÖ Current user:', currentUser);
    
    await loadData();
    initializeEmojiPicker();
  } catch (error) {
    console.error('‚ùå LIFF initialization failed:', error);
    document.getElementById('loading-overlay').innerHTML = `
      <div class="text-center">
        <p class="text-white">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
        <p class="text-gray-400 text-sm mt-2">${error.message}</p>
      </div>
    `;
  }
}

// Initialize emoji picker
function initializeEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  picker.innerHTML = '';
  
  emojis.forEach(emoji => {
    const btn = document.createElement('button');
    btn.className = 'emoji-btn';
    btn.textContent = emoji;
    btn.onclick = () => insertEmoji(emoji);
    picker.appendChild(btn);
  });
}

// Toggle emoji picker
function toggleEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  picker.classList.toggle('show');
}

// Insert emoji
function insertEmoji(emoji) {
  const input = document.getElementById('comment-input');
  const cursorPos = input.selectionStart;
  const textBefore = input.value.substring(0, cursorPos);
  const textAfter = input.value.substring(cursorPos);
  
  input.value = textBefore + emoji + textAfter;
  input.focus();
  
  const newCursorPos = cursorPos + emoji.length;
  input.setSelectionRange(newCursorPos, newCursorPos);
  
  document.getElementById('emoji-picker').classList.remove('show');
}

// Close emoji picker when clicking outside
document.addEventListener('click', (e) => {
  const picker = document.getElementById('emoji-picker');
  const trigger = document.getElementById('emoji-trigger');
  
  if (picker && !picker.contains(e.target) && e.target !== trigger) {
    picker.classList.remove('show');
  }
});

// Load all data
async function loadData() {
  try {
    console.log('üìä Starting to load data...');
    
    // Load posts with media
    const { data: posts, error: postsError } = await supabase
      .from('user_challenges_proof')
      .select(`
        *,
        proof_media (
          media_url,
          media_type,
          media_order,
          thumbnail_url
        )
      `)
      .eq('is_verified', true)
      .order('proof_date', { ascending: false });
    
    if (postsError) {
      console.error('‚ùå Error loading posts:', postsError);
      throw postsError;
    }
    
    console.log('üì¶ Raw posts data:', posts);
    console.log('üìä Total posts loaded:', posts?.length || 0);
    
    // Process posts - support both proof_media and proof_image_url
    allPosts = posts.map(post => {
      let mediaArray = [];
      
      // First, check if proof_media has data (new system - multiple files)
if (post.proof_media && post.proof_media.length > 0) {
  mediaArray = post.proof_media
    .sort((a, b) => a.media_order - b.media_order)
    .map(m => ({
      type: m.media_type || 'image',

      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Gallery ‚Üí ‡πÉ‡∏ä‡πâ thumbnail ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      url: m.media_type === 'video'
        ? getStorageUrl(m.thumbnail_url || m.media_url)
        : getStorageUrl(m.media_url),

      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Full Media View ‚Üí ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏™‡∏°‡∏≠
      fullUrl: getStorageUrl(m.media_url)
    }));
  } 
      // Fallback to proof_image_url (old system - single image)
      else if (post.proof_image_url) {
        mediaArray = [{
          type: 'image',
          url: getStorageUrl(post.proof_image_url)
        }];
      }
      
      return {
        id: post.id,
        lineUserId: post.line_user_id,
        fullName: post.full_name,
        profilePictureUrl: post.profile_picture_url,
        challengeName: post.challenge_name,
        dayNumber: post.day_number,
        proofDate: post.proof_date,
        caption: post.caption, 
        media: mediaArray
      };
    });
    
    // Filter out posts with no media
    allPosts = allPosts.filter(post => post.media.length > 0);
    
    console.log('‚úÖ Final allPosts to display:', allPosts.length);
    
    // Load saved posts
    const { data: saves, error: savesError } = await supabase
      .from('proof_saves')
      .select('proof_id')
      .eq('saver_line_user_id', currentUser.lineUserId);
    
    if (savesError) throw savesError;
    
    savedPosts = new Set(saves.map(s => s.proof_id));
    
    console.log('üíæ Saved posts:', savedPosts);
    
    // Load liked posts
    const { data: likes, error: likesError } = await supabase
      .from('proof_likes')
      .select('proof_id')
      .eq('liker_line_user_id', currentUser.lineUserId);
    
    if (!likesError && likes) {
      likedPosts = new Set(likes.map(l => l.proof_id));
    }
    
    // Render gallery
    renderGallery();
    renderSavedGrid();
    
    // Hide loading
    document.getElementById('loading-overlay').style.display = 'none';
    
  } catch (error) {
    console.error('‚ùå Error loading data:', error);
    document.getElementById('loading-overlay').innerHTML = `
      <div class="text-center">
        <p class="text-white">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
        <p class="text-gray-400 text-sm mt-2">${error.message}</p>
      </div>
    `;
  }
}

// Get storage URL
function getStorageUrl(path) {
  if (!path) return '';
  if (path.startsWith('http')) return path;
  
  // Remove leading slash if exists
  const cleanPath = path.startsWith('/') ? path.substring(1) : path;
  
  // Build public URL manually
  return `${SUPABASE_URL}/storage/v1/object/public/proof/${cleanPath}`;
}

// Navigation functions
function navigateTo(pageId) {
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  document.getElementById(pageId).classList.add('active');
}

function navigateToTab(pageId) {
  navigateTo(pageId);
  
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (pageId === 'gallery-page') {
    document.getElementById('nav-gallery').classList.add('active');
  } else if (pageId === 'saved-page') {
    document.getElementById('nav-saved').classList.add('active');
  }
}

// Toggle save
async function toggleSave() {
  if (currentMediaIndex === null) return;

  const post = allPosts[currentMediaIndex];
  const saveBtn = document.getElementById('save-btn');
  const icon = saveBtn.querySelector('i');

  try {
    if (savedPosts.has(post.id)) {
      // Unsave
      const { error } = await supabase
        .from('proof_saves')
        .delete()
        .eq('proof_id', post.id)
        .eq('saver_line_user_id', currentUser.lineUserId);

      if (error) throw error;

      savedPosts.delete(post.id);
      saveBtn.classList.remove('saved');

      // ‚úÖ outline
      icon.className = 'fi fi-rr-bookmark save-icon';

      // üî¢ update save count (‡∏•‡∏ö)
      currentSaveCount--;
      document.getElementById('save-count').textContent = currentSaveCount;

    } else {
      // Save
      const { error } = await supabase
        .from('proof_saves')
        .insert({
          proof_id: post.id,
          saver_line_user_id: currentUser.lineUserId
        });

      if (error) throw error;

      savedPosts.add(post.id);
      saveBtn.classList.add('saved');

      // ‚úÖ solid
      icon.className = 'fi fi-sr-bookmark save-icon';

      // üî¢ update save count (‡πÄ‡∏û‡∏¥‡πà‡∏°)
      currentSaveCount++;
      document.getElementById('save-count').textContent = currentSaveCount;
    }

    renderSavedGrid();

  } catch (error) {
    console.error('Error toggling save:', error);
  }
}


// Toggle like
async function toggleLike() {
  if (currentMediaIndex === null) return;
  
  const post = allPosts[currentMediaIndex];
  const heartIcon = document.getElementById('heart-icon');
  const likeCountEl = document.getElementById('like-count');
  
  try {
    if (likedPosts.has(post.id)) {
      // Unlike
      const { error } = await supabase
        .from('proof_likes')
        .delete()
        .eq('proof_id', post.id)
        .eq('liker_line_user_id', currentUser.lineUserId);
      
      if (error) throw error;
      
      likedPosts.delete(post.id);
      heartIcon.classList.remove('liked');
    } else {
      // Like
      const { error } = await supabase
        .from('proof_likes')
        .insert({
          proof_id: post.id,
          liker_line_user_id: currentUser.lineUserId
        });
      
      if (error) throw error;
      
      likedPosts.add(post.id);
      heartIcon.classList.add('liked');
    }
    
    // Update like count
    await updateLikeCount(post.id);
    
  } catch (error) {
    console.error('Error toggling like:', error);
  }
}

// Update like count
async function updateLikeCount(proofId) {
  try {
    const { count, error } = await supabase
      .from('proof_likes')
      .select('*', { count: 'exact', head: true })
      .eq('proof_id', proofId);
    
    if (!error) {
      document.getElementById('like-count').textContent = count || 0;
    }
  } catch (error) {
    console.error('Error updating like count:', error);
  }
}

// Toggle comment like
async function toggleCommentLike(commentId, heartElement, countElement) {
  try {
    const isLiked = commentLikes.has(commentId);
    
    if (isLiked) {
      // Unlike comment
      const { error } = await supabase
        .from('comment_likes')
        .delete()
        .eq('comment_id', commentId)
        .eq('liker_line_user_id', currentUser.lineUserId);
      
      if (error) throw error;
      
      commentLikes.delete(commentId);
      heartElement.classList.remove('liked');
    } else {
      // Like comment
      const { error } = await supabase
        .from('comment_likes')
        .insert({
          comment_id: commentId,
          liker_line_user_id: currentUser.lineUserId
        });
      
      if (error) throw error;
      
      commentLikes.add(commentId);
      heartElement.classList.add('liked');
    }
    
    // Update count
    const { count } = await supabase
      .from('comment_likes')
      .select('*', { count: 'exact', head: true })
      .eq('comment_id', commentId);
    
    countElement.textContent = count || 0;
    
  } catch (error) {
    console.error('Error toggling comment like:', error);
  }
}

// Show reply input
function showReplyInput(commentId) {
  replyingToCommentId = commentId;
  const input = document.getElementById('comment-input');
  input.placeholder = '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...';
  input.focus();
}

// Slider functions
function goToSlide(index) {
  if (currentMediaIndex === null) return;

  const post = allPosts[currentMediaIndex];
  const totalSlides = post.media.length;

  currentSlideIndex = Math.max(0, Math.min(index, totalSlides - 1));

  const track = document.getElementById('media-slider-track');
  track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;

  // ‚≠ê Update slide counter (1 / total)
  const slideCounter = document.getElementById("slide-counter");
  if (slideCounter && totalSlides > 1) {
    slideCounter.textContent = `${currentSlideIndex + 1} / ${totalSlides}`;
  } else if (slideCounter) {
    slideCounter.textContent = "";
  }

  // ‚≠ê Update dots
  updateSliderControls();
}

function updateSliderControls() {
  if (currentMediaIndex === null) return;

  const post = allPosts[currentMediaIndex];
  const totalSlides = post.media.length;

  // ‚≠ê ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ô‡πÉ‡∏à prev/next ‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
  //   -> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á query ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á style ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á display

  const dotsContainer = document.getElementById('slider-dots');
  dotsContainer.innerHTML = '';

  if (totalSlides > 1) {
    for (let i = 0; i < totalSlides; i++) {
      const dot = document.createElement('div');
      dot.className = 'slider-dot' + (i === currentSlideIndex ? ' active' : '');
      dot.onclick = () => goToSlide(i);
      dotsContainer.appendChild(dot);
    }
  }
}


// Load comments for current post
async function loadComments() {
  if (currentMediaIndex === null) return;
  
  const post = allPosts[currentMediaIndex];
  
  try {
    // Get comments first
    const { data: comments, error: commentsError } = await supabase
      .from('proof_comments')
      .select('*')
      .eq('proof_id', post.id)
      .order('created_at', { ascending: false });
    
    if (commentsError) throw commentsError;
    
    // Get unique commenter IDs
    const commenterIds = [...new Set(comments.map(c => c.commenter_line_user_id))];
    
    // Get commenter profiles from user_profiles
    const { data: profiles, error: profilesError } = await supabase
      .from('user_profiles')
      .select('line_user_id, display_name, profile_picture_url')
      .in('line_user_id', commenterIds);
    
    if (profilesError) throw profilesError;
    
    // Create a map of profiles
    const profileMap = new Map();
    profiles.forEach(p => {
      profileMap.set(p.line_user_id, p);
    });
    
    // Merge comments with profiles
    currentComments = comments.map(comment => ({
      ...comment,
      commenter_profile: profileMap.get(comment.commenter_line_user_id)
    }));
    
    // Load comment likes for current user
const { data: commentLikesData } = await supabase
  .from('comment_likes')
  .select('comment_id')
  .eq('liker_line_user_id', currentUser.lineUserId)
  .in('comment_id', comments.map(c => c.id));

commentLikes = new Set();

if (commentLikesData && commentLikesData.length > 0) {
  commentLikesData.forEach(like => {
    commentLikes.add(like.comment_id);
  });
}

    
    renderComments();
    
    // Update comment count
    document.getElementById('comment-count').textContent = currentComments.length;
    
  } catch (error) {
    console.error('Error loading comments:', error);
  }
}

// Render comments
async function renderComments() {
  const commentsList = document.getElementById('comments-list');
  commentsList.innerHTML = '';
  
  if (currentComments.length === 0) {
    commentsList.innerHTML = `
      <div class="text-center py-10">
        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</p>
      </div>
    `;
    return;
  }
  
  for (const comment of currentComments) {
    const commentDiv = document.createElement('div');
    commentDiv.className = 'comment-item flex gap-3 mb-6';
    
    const commenterData = comment.commenter_profile;
    const profilePic = commenterData?.profile_picture_url || 'https://via.placeholder.com/32';
    const displayName = commenterData?.display_name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    
    const createdAt = new Date(comment.created_at);
    const timeAgo = getTimeAgo(createdAt);
    
    // Get like count for this comment
    const { count: likeCount } = await supabase
      .from('comment_likes')
      .select('*', { count: 'exact', head: true })
      .eq('comment_id', comment.id);
    
    const isLiked = commentLikes.has(comment.id);
    
    commentDiv.innerHTML = `
      <img src="${profilePic}" class="w-8 h-8 rounded-full flex-shrink-0" alt="Profile">
      <div class="flex-1">
        <div class="flex items-center gap-2 mb-1">
          <span class="font-semibold text-white text-sm">${displayName}</span>
          <span class="text-gray-500 text-xs">${timeAgo}</span>
        </div>
        <p class="text-white text-sm mb-2">${escapeHtml(comment.comment_text)}</p>
        <div class="flex items-center gap-4">
          <button onclick="toggleCommentLike('${comment.id}', this.querySelector('.heart-icon'), this.querySelector('span'))" class="flex items-center gap-1 text-gray-400 hover:text-white transition-colors text-xs">
            <svg class="w-4 h-4 heart-icon ${isLiked ? 'liked' : ''}" fill="${isLiked ? '#C1272D' : 'none'}" stroke="${isLiked ? '#C1272D' : 'currentColor'}" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
            <span>${likeCount || 0}</span>
          </button>
          <button onclick="showReplyInput('${comment.id}')" class="text-gray-400 hover:text-white transition-colors text-xs font-semibold">
            ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
          </button>
        </div>
      </div>
    `;
    
    commentsList.appendChild(commentDiv);
  }
}

// Post new comment
async function postComment(event) {
  if (event) {
    event.preventDefault();
  }
  
  if (currentMediaIndex === null) return;
  
  const input = document.getElementById('comment-input');
  const commentText = input.value.trim();
  
  if (!commentText) return;
  
  const post = allPosts[currentMediaIndex];
  
  try {
    // Insert the comment
    const { data: newComment, error } = await supabase
      .from('proof_comments')
      .insert({
        proof_id: post.id,
        commenter_line_user_id: currentUser.lineUserId,
        comment_text: commentText,
        parent_comment_id: replyingToCommentId
      })
      .select()
      .single();
    
    if (error) throw error;
    
    // Get commenter profile from user_profiles
    const { data: profile, error: profileError } = await supabase
      .from('user_profiles')
      .select('line_user_id, display_name, profile_picture_url')
      .eq('line_user_id', currentUser.lineUserId)
      .single();
    
    if (profileError) {
      console.error('Error loading profile:', profileError);
    }
    
    // Add commenter profile to comment
    const commentWithProfile = {
      ...newComment,
      commenter_profile: profile || {
        line_user_id: currentUser.lineUserId,
        display_name: currentUser.displayName,
        profile_picture_url: currentUser.pictureUrl
      }
    };
    
    // Add new comment to the top
    currentComments.unshift(commentWithProfile);
    renderComments();
    
    // Update comment count
    document.getElementById('comment-count').textContent = currentComments.length;
    
    // Clear input and reset reply state
    input.value = '';
    input.placeholder = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå...';
    replyingToCommentId = null;
    
  } catch (error) {
    console.error('Error posting comment:', error);
  }
}

// Helper function: Get time ago
function getTimeAgo(date) {
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);
  
  if (seconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
  
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  const days = Math.floor(hours / 24);
  if (days < 7) return `${days} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  const weeks = Math.floor(days / 7);
  if (weeks < 4) return `${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  
  return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Helper function: Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===============================
// Open Media View (Full-farm + Build Slides)
// ===============================
async function openMediaView(index) {
  currentMediaIndex = index;
  currentSlideIndex = 0;
  const post = allPosts[index];

  const hint = document.getElementById('sound-hint');
if (hint) hint.style.display = 'block';

const icon = document.getElementById('sound-icon');
if (icon) icon.className = 'fi fi-rr-volume-slash';

soundUnlocked = false;



  // Load save count
  const { count } = await supabase
    .from('proof_saves')
    .select('*', { count: 'exact', head: true })
    .eq('proof_id', post.id);

  currentSaveCount = count || 0;
  document.getElementById('save-count').textContent = currentSaveCount;

  const slider = document.querySelector('.media-slider');
const sliderTrack = document.getElementById('media-slider-track');

// üî• ‡∏ã‡πà‡∏≠‡∏ô container ‡∏Å‡∏±‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
slider.style.opacity = '0';

// reset slider
sliderTrack.style.transition = 'none';
sliderTrack.style.transform = 'translateX(0)';
sliderTrack.innerHTML = '';

// force clear frame
sliderTrack.offsetHeight;

// ‡πÄ‡∏õ‡∏¥‡∏î transition ‡∏Å‡∏•‡∏±‡∏ö
sliderTrack.style.transition = '';


  post.media.forEach(media => {
    const slide = document.createElement('div');
    slide.className = 'media-slide';

    slide.style.width = '100vw';
    slide.style.height = '100vh';
    slide.style.overflow = 'hidden';
    slide.style.position = 'relative';
    slide.style.background = 'black';

    if (media.type === 'video') {
      slide.innerHTML = `
        <video
  src="${media.fullUrl}"
  autoplay
  muted
  playsinline
  loop
  class="absolute inset-0 w-full h-full object-cover"
></video>
      `;
    } else {
      slide.innerHTML = `
        <img
          src="${media.url}"
          class="absolute inset-0 w-full h-full object-cover"
        >
      `;
    }

    sliderTrack.appendChild(slide);
  });

 // üî• ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏£‡∏¥‡∏á
requestAnimationFrame(() => {
  slider.style.transition = 'opacity 0.12s ease-out';
  slider.style.opacity = '1';
});


  // Floating overlay data
  document.getElementById("floating-avatar").src =
    post.profilePictureUrl || "https://via.placeholder.com/40";

  document.getElementById("floating-name").textContent =
    post.fullName || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";

  document.getElementById("floating-caption").textContent =
    post.caption || "";

  // Update post details
  document.getElementById('media-title').textContent =
    `${post.challengeName} - Day ${post.dayNumber}`;

  document.getElementById('post-description').textContent =
    post.fullName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';

  const proofDate = new Date(post.proofDate);
  document.getElementById('post-date').textContent =
    proofDate.toLocaleDateString('th-TH', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

  // Set creator info
  const creatorAvatar = document.getElementById('creator-avatar');
  creatorAvatar.src =
    post.profilePictureUrl || 'https://via.placeholder.com/40';

  document.getElementById('creator-name').textContent =
    post.fullName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';

  // Update save button (icon version)
  const saveBtn = document.getElementById('save-btn');
  saveBtn.classList.toggle('saved', savedPosts.has(post.id));

  const saveIcon = saveBtn.querySelector('i');
  if (savedPosts.has(post.id)) {
    saveIcon.className = 'fi fi-sr-bookmark save-icon';
  } else {
    saveIcon.className = 'fi fi-rr-bookmark save-icon';
  }

  // Update heart icon
  const heartIcon = document.getElementById('heart-icon');
  if (likedPosts.has(post.id)) {
    heartIcon.classList.add('liked');
  } else {
    heartIcon.classList.remove('liked');
  }

  updateSliderControls();
  loadComments();
  updateLikeCount(post.id);
  goToSlide(0);

 // üî• Auto play / pause Reels
pauseAllReelVideos();
playActiveReelVideo();
 
  navigateTo('media-view-page');
}
 

// Render gallery
function renderGallery() {
  console.log('üé® Rendering gallery with', allPosts.length, 'posts');
  
  const grid = document.querySelector('#gallery-page .masonry-grid');
  grid.innerHTML = '';
  
  if (allPosts.length === 0) {
    grid.innerHTML = `
      <div class="col-span-2 text-center py-20">
        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
      </div>
    `;
    return;
  }
  
  allPosts.forEach((post, index) => {
    const div = document.createElement('div');
    div.className = 'masonry-item';
    div.onclick = () => openMediaView(index);
    
    const firstMedia = post.media[0];
    const mediaCount = post.media.length;

    // -----------------------------
    // Video Thumbnail Version
    // -----------------------------
    if (firstMedia && firstMedia.type === 'video') {
      div.innerHTML = `
        <div class="relative" 
             style="height: 300px; background: #000; overflow: hidden; border-radius: 12px;">
          
          <!-- Thumbnail video (muted + preload) -->
          <img 
  src="${firstMedia.url}" 
  class="w-full h-full object-cover"
  alt="thumbnail"
/>


          <!-- Play icon -->
          <div class="absolute top-2 right-2 bg-black/60 rounded-full p-1">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"></path>
            </svg>
          </div>

          <!-- Media count -->
          ${mediaCount > 1 ? `<div class="media-count-badge">1/${mediaCount}</div>` : ''}
        </div>
      `;
    }

    // -----------------------------
    // Image Version
    // -----------------------------
    else if (firstMedia) {
      div.innerHTML = `
        <div class="relative" style="border-radius: 12px; overflow: hidden;">
          <img src="${firstMedia.url}" 
               alt="Gallery image" 
               class="w-full h-auto block object-cover">

          ${mediaCount > 1 ? `<div class="media-count-badge">1/${mediaCount}</div>` : ''}
        </div>
      `;
    }
    
    grid.appendChild(div);
  });
  
  console.log('‚úÖ Gallery rendered successfully');
}


// Render saved grid
function renderSavedGrid() {
  const grid = document.getElementById('saved-grid');
  grid.innerHTML = '';
  
  const savedArray = allPosts.filter(post => savedPosts.has(post.id));
  
  if (savedArray.length === 0) {
    grid.innerHTML = `
      <div class="col-span-2 text-center py-20">
        <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
      </div>
    `;
    return;
  }
  
  savedArray.forEach((post) => {
    const div = document.createElement('div');
    div.className = 'masonry-item';
    const itemIndex = allPosts.findIndex(p => p.id === post.id);
    div.onclick = () => {
      openMediaView(itemIndex);
      navigateTo('media-view-page');
    };
    
    const firstMedia = post.media[0];
    const mediaCount = post.media.length;
    
    if (firstMedia && firstMedia.type === 'video') {
  div.innerHTML = `
    <div class="relative" style="height: 300px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
      <video src="${firstMedia.url}" class="w-full h-full object-cover"></video>
      <div class="saved-badge"><i class="fi fi-sr-bookmark"></i></div>
      ${mediaCount > 1 ? `<div class="media-count-badge" style="top: 8px; right: 48px;">1/${mediaCount}</div>` : ''}
    </div>
  `;
} else if (firstMedia) {
  div.innerHTML = `
    <div class="relative">
      <img src="${firstMedia.url}" alt="Saved image" class="w-full h-auto" style="display: block;">
      <div class="saved-badge"><i class="fi fi-sr-bookmark"></i></div>
      ${mediaCount > 1 ? `<div class="media-count-badge" style="top: 8px; right: 48px;">1/${mediaCount}</div>` : ''}
    </div>
  `;
}

    
    grid.appendChild(div);
  });
}

   function stopAllVideos() {
  const videos = document.querySelectorAll('#media-slider-track video');
  videos.forEach(video => {
    video.pause();
    video.currentTime = 0;
  });
}

  let soundUnlocked = false;

function toggleSound() {
  const activeVideo = document.querySelector('#media-slider-track video');
  if (!activeVideo) return;

  if (!soundUnlocked) {
    // üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    activeVideo.muted = false;
    activeVideo.volume = 1;
    soundUnlocked = true;

    document.getElementById('sound-icon').className =
      'fi fi-rr-volume-down';
  } else {
    // üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    activeVideo.muted = true;
    soundUnlocked = false;

    document.getElementById('sound-icon').className =
      'fi fi-rr-volume-slash';
  }
}

   

   // ===============================
// Swipe Gesture (Bind once)
// ===============================
let startX = 0;
let swipeHandled = false;

const trackEl = document.getElementById('media-slider-track');

if (trackEl) {
  trackEl.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    swipeHandled = false;
  }, { passive: true });

  trackEl.addEventListener('touchmove', (e) => {
    if (swipeHandled) return;

    const currentX = e.touches[0].clientX;
    const diff = currentX - startX;
    const threshold = Math.min(window.innerWidth * 0.15, 120);

    if (diff < -threshold) {
      goToSlide(currentSlideIndex + 1);
      swipeHandled = true;
    } else if (diff > threshold) {
      goToSlide(currentSlideIndex - 1);
      swipeHandled = true;
    }
  }, { passive: true });

  trackEl.addEventListener('touchend', () => {
    swipeHandled = false;
  });
}

   // ===============================
// Vertical Swipe (change post)
// ===============================
const verticalEl = document.querySelector('.media-slider');

if (verticalEl) {
  verticalEl.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
    verticalSwipeHandled = false;
  }, { passive: true });

  verticalEl.addEventListener('touchmove', (e) => {
    e.preventDefault(); // üîë ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÉ‡∏ô LIFF

    if (verticalSwipeHandled) return;

    const currentY = e.touches[0].clientY;
    const diffY = currentY - startY;
    const threshold = Math.min(window.innerHeight * 0.15, 120);

    // ‚¨ÜÔ∏è swipe up ‚Üí next post
    if (diffY < -threshold) {
      goToNextPost();
      verticalSwipeHandled = true;
    }

    // ‚¨áÔ∏è swipe down ‚Üí prev post
    if (diffY > threshold) {
      goToPrevPost();
      verticalSwipeHandled = true;
    }
  }, { passive: false }); // üîë ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô false

  verticalEl.addEventListener('touchend', () => {
    verticalSwipeHandled = false;
  });
}

   
function goToNextPost() {
  if (currentMediaIndex === null) return;
  if (currentMediaIndex >= allPosts.length - 1) return;
  if (isAnimatingPost) return;

  isAnimatingPost = true;

  const slider = document.querySelector('.media-slider');
  slider.style.transform = 'translateY(-100%)';

  setTimeout(() => {
    stopAllVideos();
    openMediaView(currentMediaIndex + 1);

    slider.style.transition = 'none';
    slider.style.transform = 'translateY(0)';

    // force reflow
    slider.offsetHeight;

    slider.style.transition =
      'transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1)';

    isAnimatingPost = false;
  }, 300);
}

function goToPrevPost() {
  if (currentMediaIndex === null) return;
  if (currentMediaIndex <= 0) return;
  if (isAnimatingPost) return;

  isAnimatingPost = true;

  const slider = document.querySelector('.media-slider');
  slider.style.transform = 'translateY(100%)';

  setTimeout(() => {
    stopAllVideos();
    openMediaView(currentMediaIndex - 1);

    slider.style.transition = 'none';
    slider.style.transform = 'translateY(0)';

    slider.offsetHeight;

    slider.style.transition =
      'transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1)';

    isAnimatingPost = false;
  }, 300);
}

function pauseAllReelVideos() {
  document.querySelectorAll('#media-slider-track video').forEach(v => {
    v.pause();
    v.currentTime = 0;
  });
}

function playActiveReelVideo() {
  const activeVideo = document.querySelector('#media-slider-track video');
  if (!activeVideo) return;

  // ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö Reels
  activeVideo.muted = !soundUnlocked; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‚Üí muted
  activeVideo.playsInline = true;

  const p = activeVideo.play();
  if (p && typeof p.catch === 'function') {
    p.catch(() => {}); // ‡∏Å‡∏±‡∏ô error ‡∏ö‡∏ô iOS/LIFF
  }
}

// Initialize app
initializeLiff();
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ab37200d3a2d336',t:'MTc2NTI3MjIyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>







































































