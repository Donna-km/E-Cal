<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Cal Proof Gallery</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Kanit', -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
      background: #FAF9F6;
      color: #333333;
      min-height: 100%;
      width: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .app-container {
      width: 100%;
      min-height: 100%;
      background: #FAF9F6;
    }

    .header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .header h1 {
      margin: 0 0 15px 0;
      font-size: 28px;
      color: #2D2D2D;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Kanit', 'Arial', sans-serif;
    }

    .btn-primary {
      background: #FF6B9D;
      color: #FFFFFF;
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.25);
    }

    .btn-primary:hover {
      background: #FF5088;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.35);
    }

    .btn-secondary {
      background: #FFFFFF;
      color: #2D2D2D;
      border: 1.5px solid #E8E8E8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .btn-secondary:hover {
      background: #F8F8F8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .gallery-grid {
      column-count: 4;
      column-gap: 20px;
      padding: 30px 20px;
      width: 100%;
    }

    @media (max-width: 1200px) {
      .gallery-grid {
        column-count: 3;
      }
    }

    @media (max-width: 768px) {
      .gallery-grid {
        column-count: 2;
        column-gap: 15px;
        padding: 20px 15px;
      }

      .proof-info {
        padding: 10px 12px;
      }

      .proof-user {
        font-size: 12px;
      }

      .proof-rating {
        font-size: 10px;
      }

      .save-btn {
        font-size: 18px;
        width: 36px;
        height: 36px;
      }
    }

    .proof-card {
      background: #FFFFFF;
      border-radius: 24px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      break-inside: avoid;
      margin-bottom: 20px;
      display: inline-block;
      width: 100%;
      position: relative;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .proof-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
    }

    .proof-card:hover .proof-overlay {
      opacity: 1;
    }

    .proof-image-container {
      position: relative;
      width: 100%;
      overflow: hidden;
      aspect-ratio: 4 / 5;
      background: linear-gradient(135deg, #FFF5F8 0%, #FFF9FB 100%);
    }

    .proof-image {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      filter: brightness(1.02) contrast(0.98) saturate(1.1);
    }

    .proof-video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    .media-indicator {
      position: absolute;
      top: 14px;
      right: 14px;
      background: rgba(255, 255, 255, 0.95);
      color: #555555;
      padding: 7px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      z-index: 5;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
      letter-spacing: 0.3px;
    }

    .proof-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.35) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      padding: 15px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    .save-btn {
      position: absolute;
      top: 14px;
      left: 14px;
      background: rgba(255, 255, 255, 0.97);
      border: none;
      color: #FF6B9D;
      font-size: 22px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 8px;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
    }

    .save-btn:hover {
      transform: scale(1.2);
      background: #FFFFFF;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
    }

    .save-btn.saved {
      color: #FF6B9D;
      background: #FFFFFF;
    }

    .proof-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 14px 16px;
      background: linear-gradient(to top, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 70%, rgba(255,255,255,0) 100%);
      backdrop-filter: blur(12px);
    }

    .proof-user-header {
      display: flex;
      align-items: center;
      gap: 9px;
      margin-bottom: 7px;
    }

    .proof-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 2.5px solid #FFFFFF;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .proof-user {
      font-size: 13px;
      font-weight: 600;
      color: #2D2D2D;
      letter-spacing: -0.3px;
      line-height: 1.2;
    }

    .proof-mission {
      display: none;
    }

    .proof-rating {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: #777777;
      font-weight: 500;
      letter-spacing: 0.2px;
    }

    .stars {
      color: #FFB800;
      font-size: 13px;
      line-height: 1;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      max-width: 600px;
      margin: 0 auto;
      background: #FFFFFF;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.3);
    }

    .carousel-container {
      position: relative;
      width: 100%;
      max-height: 500px;
      background: #F8F8F8;
      overflow: hidden;
    }

    .carousel-track {
      display: flex;
      transition: transform 0.3s ease;
    }

    .carousel-slide {
      min-width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #F8F8F8;
    }

    .carousel-image {
      width: 100%;
      max-height: 500px;
      object-fit: contain;
    }

    .carousel-video {
      width: 100%;
      max-height: 500px;
    }

    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #2D2D2D;
      border: none;
      padding: 15px 20px;
      cursor: pointer;
      font-size: 24px;
      z-index: 10;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .carousel-btn:hover {
      background: #FFFFFF;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    .carousel-btn.prev {
      left: 10px;
      border-radius: 0 12px 12px 0;
    }

    .carousel-btn.next {
      right: 10px;
      border-radius: 12px 0 0 12px;
    }

    .carousel-dots {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .carousel-dot.active {
      background: #FF6B9D;
      width: 24px;
      border-radius: 4px;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-close {
      float: right;
      font-size: 28px;
      cursor: pointer;
      color: #FF6B9D;
      line-height: 1;
      font-weight: 300;
    }

    .modal-close:hover {
      color: #FF5088;
    }

    .modal-user-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .modal-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #FF6B9D;
    }

    .rating-section {
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, #FFF5F8 0%, #FFF9FB 100%);
      border-radius: 16px;
      border: 1px solid rgba(255, 107, 157, 0.1);
    }

    .rating-stars {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }

    .rating-star {
      font-size: 36px;
      cursor: pointer;
      color: #E0E0E0;
      transition: all 0.2s;
    }

    .rating-star:hover,
    .rating-star.active {
      color: #FFB800;
      transform: scale(1.2);
    }

    .comment-section {
      margin: 20px 0;
    }

    .comment-section h3 {
      color: #2D2D2D;
      font-size: 18px;
      margin-bottom: 12px;
    }

    .comment-box {
      width: 100%;
      padding: 15px;
      background: #F8F8F8;
      border: 1.5px solid #E8E8E8;
      border-radius: 12px;
      color: #2D2D2D;
      font-size: 15px;
      font-family: 'Kanit', 'Arial', sans-serif;
      resize: vertical;
      min-height: 80px;
      transition: all 0.3s;
    }

    .comment-box:focus {
      outline: none;
      border-color: #FF6B9D;
      background: #FFFFFF;
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
    }

    .comment-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .comment-item {
      padding: 14px;
      background: #F8F8F8;
      border-left: 3px solid #FF6B9D;
      margin-bottom: 10px;
      border-radius: 8px;
    }

    .comment-user {
      font-weight: 600;
      color: #FF6B9D;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .comment-text {
      color: #555555;
      line-height: 1.5;
    }

    .ranking-view {
      display: none;
      padding: 20px;
    }

    .ranking-view.active {
      display: block;
    }

    .ranking-item {
      background: #FFFFFF;
      border-radius: 20px;
      padding: 18px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      transition: all 0.3s;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .ranking-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }

    .ranking-number {
      font-size: 32px;
      font-weight: 700;
      color: #FF6B9D;
      min-width: 50px;
      text-align: center;
    }

    .ranking-number.top3 {
      color: #FFB800;
    }

    .ranking-thumb {
      width: 80px;
      height: 100px;
      object-fit: cover;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .ranking-details {
      flex: 1;
    }

    .ranking-user {
      font-size: 20px;
      font-weight: 600;
      color: #2D2D2D;
    }

    .ranking-score {
      font-size: 16px;
      color: #FFB800;
      margin-top: 5px;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 107, 157, 0.3);
      border-radius: 50%;
      border-top-color: #FF6B9D;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(250, 249, 246, 0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
      gap: 20px;
    }

    .loading-overlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 107, 157, 0.2);
      border-radius: 50%;
      border-top-color: #FF6B9D;
      animation: spin 1s linear infinite;
    }

    .loading-overlay p {
      color: #2D2D2D;
      font-size: 18px;
      font-weight: 500;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2D2D2D;
      color: #FFFFFF;
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 10000;
      font-weight: 600;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="loadingOverlay" class="loading-overlay">
   <div class="spinner"></div>
   <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>
  <div class="app-container" style="display: none;">
   <div class="header">
    <h1>E-Cal Proof Gallery</h1>
    <div class="header-buttons"><button class="btn btn-secondary" id="rankingBtn">üèÜ Top 10</button> <button class="btn btn-secondary" id="savedBtn">‚ù§Ô∏è Saved</button> <button class="btn btn-secondary" id="galleryBtn" style="display:none;">üì∑ Gallery</button>
    </div>
   </div>
   <div id="galleryView">
    <div class="gallery-grid" id="galleryGrid"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
     <div class="empty-state-icon">
      üì∏
     </div>
     <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Proof</h2>
     <p>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î Proof ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
    </div>
   </div>
   <div class="ranking-view" id="rankingView">
    <div id="rankingList"></div>
    <div class="empty-state" id="rankingEmpty" style="display:none;">
     <div class="empty-state-icon">
      üèÜ
     </div>
     <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
     <p>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß Proof ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö!</p>
    </div>
   </div>
   <div class="ranking-view" id="savedView">
    <div class="gallery-grid" id="savedGrid"></div>
    <div class="empty-state" id="savedEmpty" style="display:none;">
     <div class="empty-state-icon">
      üíî
     </div>
     <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Proof ‡∏ó‡∏µ‡πà Save</h2>
     <p>‡∏Å‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠ Save Proof ‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö!</p>
    </div>
   </div>
   <div class="modal" id="proofModal">
    <div class="modal-content">
     <div class="carousel-container" id="carouselContainer">
      <div class="carousel-track" id="carouselTrack"></div><button class="carousel-btn prev" id="carouselPrev">‚Äπ</button> <button class="carousel-btn next" id="carouselNext">‚Ä∫</button>
      <div class="carousel-dots" id="carouselDots"></div>
     </div>
     <div class="modal-body"><span class="modal-close" id="modalClose">√ó</span>
      <div class="modal-user-header" id="modalUserHeader"></div>
      <p id="modalMission"></p>
      <div class="rating-section">
       <h3>‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Proof ‡∏ô‡∏µ‡πâ</h3>
       <div class="rating-stars" id="ratingStars"></div>
       <p style="text-align:center; color:#777;" id="currentRating"></p>
      </div>
      <div class="comment-section">
       <h3>‡πÅ‡∏ã‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ üòà</h3><textarea class="comment-box" id="commentBox" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå..."></textarea> <button class="btn btn-primary" id="submitComment" style="width:100%; margin-top:10px;"> ‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå </button>
      </div>
      <div class="comment-section">
       <h3>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
       <div class="comment-list" id="commentList"></div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
    const LIFF_ID = '2007859046-z3WDAbWV';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentView = 'gallery';
    let proofs = [];
    let currentProofId = null;
    let currentUserId = null;
    let currentUserName = 'Guest';
    let currentSlideIndex = 0;
    let currentMediaFiles = [];
    let liffInitialized = false;

    const roastPrefixes = [
      "‡∏≠‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô: ",
      "‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™: ",
      "‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢: ",
      "‡πÄ‡∏Æ‡πâ‡∏¢‡πÄ‡∏ß‡πâ‡∏¢: ",
      "‡πÅ‡∏´‡∏°: ",
      "‡πÇ‡∏≠‡πâ‡πÇ‡∏´: ",
      "‡∏≠‡πâ‡∏≤‡∏ß: ",
      "5555: "
    ];

    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return false;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        currentUserName = profile.displayName || 'User';
        liffInitialized = true;
        
        return true;
      } catch (error) {
        console.error('LIFF Init Error:', error);
        currentUserId = 'guest_' + Math.random().toString(36).substr(2, 9);
        currentUserName = 'Guest';
        return true;
      }
    }

    async function loadProofs() {
      try {
        const { data: proofData, error: proofError } = await supabase
          .from('user_challenges_proof')
          .select('*')
          .eq('is_verified', true)
          .order('proof_date', { ascending: false });

        if (proofError) throw proofError;

        const { data: mediaData, error: mediaError } = await supabase
          .from('proof_media')
          .select('*')
          .order('media_order', { ascending: true });

        if (mediaError) throw mediaError;

        const mediaMap = new Map();
        if (mediaData) {
          mediaData.forEach(media => {
            const proofId = media.proof_id.toString();
            if (!mediaMap.has(proofId)) {
              mediaMap.set(proofId, []);
            }
            mediaMap.get(proofId).push({
              url: media.media_url,
              type: media.media_type || 'image'
            });
          });
        }

        proofs = (proofData || []).map(proof => ({
          id: proof.id.toString(),
          userId: proof.line_user_id,
          userName: proof.full_name || ('User ' + proof.line_user_id.substr(-4)),
          missionName: `${proof.challenge_name || 'Challenge'} - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${proof.day_number}`,
          uploadedAt: proof.proof_date,
          profilePicture: proof.profile_picture_url,
          mediaFiles: mediaMap.get(proof.id.toString()) || [],
          totalRating: 0,
          ratingCount: 0
        }));

        proofs = proofs.filter(p => p.mediaFiles.length > 0);
        
        await loadRatings();
        
        return true;
      } catch (error) {
        console.error('Load Proofs Error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Proof ‡πÑ‡∏î‡πâ: ' + error.message);
        return false;
      }
    }

    async function loadRatings() {
      try {
        const { data, error } = await supabase
          .from('proof_ratings')
          .select('proof_id, rating');

        if (error) throw error;

        const ratingMap = new Map();
        
        (data || []).forEach(rating => {
          const key = rating.proof_id.toString();
          if (!ratingMap.has(key)) {
            ratingMap.set(key, { total: 0, count: 0 });
          }
          ratingMap.get(key).total += rating.rating;
          ratingMap.get(key).count += 1;
        });

        proofs.forEach(proof => {
          const ratingData = ratingMap.get(proof.id);
          if (ratingData) {
            proof.totalRating = ratingData.total;
            proof.ratingCount = ratingData.count;
          }
        });
      } catch (error) {
        console.error('Load Ratings Error:', error);
      }
    }

    async function loadComments(proofId) {
      try {
        const { data, error } = await supabase
          .from('proof_comments')
          .select('*')
          .eq('proof_id', parseInt(proofId))
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        const commentList = document.getElementById('commentList');
        
        if (!data || data.length === 0) {
          commentList.innerHTML = '<p style="color:#999; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</p>';
          return;
        }

        commentList.innerHTML = data.map(comment => `
          <div class="comment-item">
            <div class="comment-user">User ${comment.commenter_line_user_id.substr(-4)}</div>
            <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Load Comments Error:', error);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function parseMediaFiles(mediaFilesArray) {
      return Array.isArray(mediaFilesArray) ? mediaFilesArray : [];
    }

    function renderGallery() {
      const grid = document.getElementById('galleryGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (proofs.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      grid.innerHTML = proofs.map(proof => {
        const avgRating = proof.ratingCount > 0 ? (proof.totalRating / proof.ratingCount).toFixed(1) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
        const stars = proof.ratingCount > 0 ? '‚≠ê'.repeat(Math.round(proof.totalRating / proof.ratingCount)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
        const isSaved = localStorage.getItem('saved_' + proof.id) === 'true';
        const saveIcon = isSaved ? '‚ù§Ô∏è' : 'ü§ç';
        
        const mediaFiles = parseMediaFiles(proof.mediaFiles);
        const firstMedia = mediaFiles[0] || {};
        const mediaCount = mediaFiles.length;
        
        let mediaHtml = '';
        if (firstMedia.type === 'video') {
          mediaHtml = `<video class="proof-video" src="${firstMedia.url}" muted loop autoplay playsinline></video>`;
        } else {
          mediaHtml = `<img class="proof-image" src="${firstMedia.url || ''}" alt="${escapeHtml(proof.userName)}" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">`;
        }
        
        const mediaIndicator = mediaCount > 1 ? `<div class="media-indicator">üì∑ ${mediaCount}</div>` : '';
        
        const avatarHtml = proof.profilePicture 
          ? `<img class="proof-avatar" src="${proof.profilePicture}" alt="${escapeHtml(proof.userName)}" onerror="this.style.display='none';">`
          : '';
        
        return `
          <div class="proof-card" onclick="openModal('${proof.id}')">
            <div class="proof-image-container">
              ${mediaHtml}
              ${mediaIndicator}
              <div class="proof-overlay"></div>
              <button class="save-btn ${isSaved ? 'saved' : ''}" onclick="event.stopPropagation(); toggleSave('${proof.id}')" id="save_${proof.id}">
                ${saveIcon}
              </button>
            </div>
            <div class="proof-info">
              <div class="proof-user-header">
                ${avatarHtml}
                <div class="proof-user">${escapeHtml(proof.userName)}</div>
              </div>
              <div class="proof-rating">
                <span class="stars">${stars}</span>
                <span>${avgRating}${proof.ratingCount > 0 ? ' (' + proof.ratingCount + ')' : ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openModal(proofId) {
      currentProofId = proofId;
      const proof = proofs.find(p => p.id === proofId);
      if (!proof) return;
      
      currentMediaFiles = parseMediaFiles(proof.mediaFiles);
      currentSlideIndex = 0;
      
      const avatarHtml = proof.profilePicture 
        ? `<img class="modal-avatar" src="${proof.profilePicture}" alt="${escapeHtml(proof.userName)}" onerror="this.style.display='none';">`
        : '';
      
      document.getElementById('modalUserHeader').innerHTML = `
        ${avatarHtml}
        <div>
          <h2 style="margin:0;">${escapeHtml(proof.userName)}</h2>
        </div>
      `;
      document.getElementById('modalMission').textContent = 'üéØ ' + proof.missionName;
      
      renderCarousel();
      updateModalRating();
      loadComments(proofId);
      
      document.getElementById('proofModal').classList.add('active');
    }

    function renderCarousel() {
      const track = document.getElementById('carouselTrack');
      const dots = document.getElementById('carouselDots');
      const prevBtn = document.getElementById('carouselPrev');
      const nextBtn = document.getElementById('carouselNext');
      
      if (currentMediaFiles.length === 0) {
        track.innerHTML = '<div class="carousel-slide"><p style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå</p></div>';
        dots.innerHTML = '';
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
      }
      
      track.innerHTML = currentMediaFiles.map(media => {
        if (media.type === 'video') {
          return `
            <div class="carousel-slide">
              <video class="carousel-video" src="${media.url}" controls autoplay muted loop playsinline></video>
            </div>
          `;
        } else {
          return `
            <div class="carousel-slide">
              <img class="carousel-image" src="${media.url}" alt="Proof" onerror="this.src=''; this.alt='Image failed to load';">
            </div>
          `;
        }
      }).join('');
      
      dots.innerHTML = currentMediaFiles.map((_, index) => 
        `<div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>`
      ).join('');
      
      if (currentMediaFiles.length > 1) {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
      } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }
      
      updateCarousel();
    }

    function updateCarousel() {
      const track = document.getElementById('carouselTrack');
      track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
      
      const dotElements = document.querySelectorAll('.carousel-dot');
      dotElements.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlideIndex);
      });
    }

    function goToSlide(index) {
      currentSlideIndex = index;
      updateCarousel();
    }

    document.getElementById('carouselPrev').onclick = function() {
      currentSlideIndex = (currentSlideIndex - 1 + currentMediaFiles.length) % currentMediaFiles.length;
      updateCarousel();
    };

    document.getElementById('carouselNext').onclick = function() {
      currentSlideIndex = (currentSlideIndex + 1) % currentMediaFiles.length;
      updateCarousel();
    };

    function updateModalRating() {
      const proof = proofs.find(p => p.id === currentProofId);
      if (!proof) return;
      
      const avgRating = proof.ratingCount > 0 ? (proof.totalRating / proof.ratingCount).toFixed(1) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
      const ratingText = proof.ratingCount > 0 ? `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgRating} ‚≠ê (${proof.ratingCount} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß - ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å!';
      
      document.getElementById('currentRating').textContent = ratingText;
      
      const starsContainer = document.getElementById('ratingStars');
      starsContainer.innerHTML = '';
      
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'rating-star';
        star.textContent = '‚≠ê';
        star.onclick = () => submitRating(i);
        starsContainer.appendChild(star);
      }
    }

    async function submitRating(stars) {
      if (!liffInitialized) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô LINE');
        return;
      }

      const userRatingKey = `rating_${currentUserId}_${currentProofId}`;
      const hasRated = localStorage.getItem(userRatingKey);
      
      if (hasRated) {
        showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß!');
        return;
      }
      
      const btn = document.getElementById('submitComment');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const { error } = await supabase
          .from('proof_ratings')
          .insert({
            proof_id: parseInt(currentProofId),
            rater_line_user_id: currentUserId,
            rating: stars
          });

        if (error) throw error;

        localStorage.setItem(userRatingKey, stars.toString());
        showToast(`‚úÖ ‡πÉ‡∏´‡πâ ${stars} ‡∏î‡∏≤‡∏ß!`);
        
        await loadRatings();
        renderGallery();
        updateModalRating();
        
      } catch (error) {
        console.error('Submit Rating Error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ: ' + error.message);
      }
      
      btn.disabled = false;
      btn.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå';
    }

    document.getElementById('submitComment').onclick = async function() {
      if (!liffInitialized) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô LINE');
        return;
      }

      const commentText = document.getElementById('commentBox').value.trim();
      if (!commentText) {
        showToast('‚ùå ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏Å‡πà‡∏≠‡∏ô!');
        return;
      }
      
      const btn = this;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const prefix = roastPrefixes[Math.floor(Math.random() * roastPrefixes.length)];
        
        const { error } = await supabase
          .from('proof_comments')
          .insert({
            proof_id: parseInt(currentProofId),
            commenter_line_user_id: currentUserId,
            comment_text: prefix + commentText
          });

        if (error) throw error;

        loadComments(currentProofId);
        document.getElementById('commentBox').value = '';
        showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!');
        
      } catch (error) {
        console.error('Submit Comment Error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ: ' + error.message);
      }
      
      btn.disabled = false;
      btn.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå';
    };

    document.getElementById('modalClose').onclick = function() {
      document.getElementById('proofModal').classList.remove('active');
      currentProofId = null;
      
      const videos = document.querySelectorAll('.carousel-video');
      videos.forEach(video => video.pause());
    };

    document.getElementById('rankingBtn').onclick = function() {
      currentView = 'ranking';
      document.getElementById('galleryView').style.display = 'none';
      document.getElementById('rankingView').classList.add('active');
      document.getElementById('savedView').classList.remove('active');
      document.getElementById('galleryBtn').style.display = 'inline-block';
      renderRanking();
    };

    document.getElementById('galleryBtn').onclick = function() {
      currentView = 'gallery';
      document.getElementById('galleryView').style.display = 'block';
      document.getElementById('rankingView').classList.remove('active');
      document.getElementById('savedView').classList.remove('active');
      document.getElementById('galleryBtn').style.display = 'none';
    };

    document.getElementById('savedBtn').onclick = function() {
      currentView = 'saved';
      document.getElementById('galleryView').style.display = 'none';
      document.getElementById('rankingView').classList.remove('active');
      document.getElementById('savedView').classList.add('active');
      document.getElementById('galleryBtn').style.display = 'inline-block';
      renderSavedProofs();
    };

    function renderRanking() {
      const rankingList = document.getElementById('rankingList');
      const rankingEmpty = document.getElementById('rankingEmpty');
      
      const rankedProofs = proofs
        .filter(p => p.ratingCount > 0)
        .map(p => ({
          ...p,
          avgRating: p.totalRating / p.ratingCount
        }))
        .sort((a, b) => b.avgRating - a.avgRating)
        .slice(0, 10);
      
      if (rankedProofs.length === 0) {
        rankingList.innerHTML = '';
        rankingEmpty.style.display = 'block';
        return;
      }
      
      rankingEmpty.style.display = 'none';
      
      rankingList.innerHTML = rankedProofs.map((proof, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? 'top3' : '';
        const stars = '‚≠ê'.repeat(Math.round(proof.avgRating));
        
        const mediaFiles = parseMediaFiles(proof.mediaFiles);
        const firstMedia = mediaFiles[0] || {};
        const thumbUrl = firstMedia.url || '';
        
        return `
          <div class="ranking-item" onclick="openModal('${proof.id}')" style="cursor: pointer;">
            <div class="ranking-number ${rankClass}">${rank}</div>
            <img class="ranking-thumb" src="${thumbUrl}" alt="${escapeHtml(proof.userName)}" onerror="this.style.display='none';">
            <div class="ranking-details">
              <div class="ranking-user">${escapeHtml(proof.userName)}</div>
              <div style="color:#999;">${escapeHtml(proof.missionName)}</div>
              <div class="ranking-score">${stars} ${proof.avgRating.toFixed(2)} (${proof.ratingCount} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleSave(proofId) {
      const saveKey = 'saved_' + proofId;
      const isSaved = localStorage.getItem(saveKey) === 'true';
      
      if (isSaved) {
        localStorage.removeItem(saveKey);
        showToast('üíî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Save ‡πÅ‡∏•‡πâ‡∏ß');
      } else {
        localStorage.setItem(saveKey, 'true');
        showToast('‚ù§Ô∏è Save ‡πÅ‡∏•‡πâ‡∏ß!');
      }
      
      renderGallery();
      if (currentView === 'saved') {
        renderSavedProofs();
      }
    }

    function renderSavedProofs() {
      const savedGrid = document.getElementById('savedGrid');
      const savedEmpty = document.getElementById('savedEmpty');
      
      const savedProofs = proofs.filter(proof => {
        const saveKey = 'saved_' + proof.id;
        return localStorage.getItem(saveKey) === 'true';
      });
      
      if (savedProofs.length === 0) {
        savedGrid.innerHTML = '';
        savedEmpty.style.display = 'block';
        return;
      }
      
      savedEmpty.style.display = 'none';
      
      savedGrid.innerHTML = savedProofs.map(proof => {
        const avgRating = proof.ratingCount > 0 ? (proof.totalRating / proof.ratingCount).toFixed(1) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
        const stars = proof.ratingCount > 0 ? '‚≠ê'.repeat(Math.round(proof.totalRating / proof.ratingCount)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
        
        const mediaFiles = parseMediaFiles(proof.mediaFiles);
        const firstMedia = mediaFiles[0] || {};
        const mediaCount = mediaFiles.length;
        
        let mediaHtml = '';
        if (firstMedia.type === 'video') {
          mediaHtml = `<video class="proof-video" src="${firstMedia.url}" muted loop autoplay playsinline></video>`;
        } else {
          mediaHtml = `<img class="proof-image" src="${firstMedia.url || ''}" alt="${escapeHtml(proof.userName)}" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">`;
        }
        
        const mediaIndicator = mediaCount > 1 ? `<div class="media-indicator">üì∑ ${mediaCount}</div>` : '';
        
        const avatarHtml = proof.profilePicture 
          ? `<img class="proof-avatar" src="${proof.profilePicture}" alt="${escapeHtml(proof.userName)}" onerror="this.style.display='none';">`
          : '';
        
        return `
          <div class="proof-card" onclick="openModal('${proof.id}')">
            <div class="proof-image-container">
              ${mediaHtml}
              ${mediaIndicator}
              <div class="proof-overlay"></div>
              <button class="save-btn saved" onclick="event.stopPropagation(); toggleSave('${proof.id}')" id="save_${proof.id}">
                ‚ù§Ô∏è
              </button>
            </div>
            <div class="proof-info">
              <div class="proof-user-header">
                ${avatarHtml}
                <div class="proof-user">${escapeHtml(proof.userName)}</div>
              </div>
              <div class="proof-rating">
                <span class="stars">${stars}</span>
                <span>${avgRating}${proof.ratingCount > 0 ? ' (' + proof.ratingCount + ')' : ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showToast(message) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    async function init() {
      try {
        const liffSuccess = await initializeLIFF();
        
        if (liffSuccess) {
          await loadProofs();
          renderGallery();
        }

        document.getElementById('loadingOverlay').style.display = 'none';
        document.querySelector('.app-container').style.display = 'block';

      } catch (error) {
        console.error('Init Error:', error);
        document.getElementById('loadingOverlay').querySelector('p').textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
          document.querySelector('.app-container').style.display = 'block';
        }, 3000);
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a73205b47492711',t:'MTc2NDU5Nzc5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
