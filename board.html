<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Cal Proof Gallery</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Kanit', 'Arial', sans-serif;
      background: #000000;
      color: #FFFFFF;
      min-height: 100%;
      width: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .app-container {
      width: 100%;
      min-height: 100%;
      background: linear-gradient(135deg, #000000 0%, #1A1A1A 100%);
    }

    .header {
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .header h1 {
      margin: 0 0 15px 0;
      font-size: 28px;
      color: #FFFFFF;
      text-shadow: 0 0 20px rgba(193, 39, 45, 0.3);
    }

    .header-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Kanit', 'Arial', sans-serif;
    }

    .btn-primary {
      background: #C1272D;
      color: #FFFFFF;
    }

    .btn-primary:hover {
      background: #A01F25;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(193, 39, 45, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #FFFFFF;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .gallery-grid {
      column-count: 4;
      column-gap: 15px;
      padding: 20px;
      width: 100%;
    }

    @media (max-width: 1200px) {
      .gallery-grid {
        column-count: 3;
      }
    }

    @media (max-width: 768px) {
      .gallery-grid {
        column-count: 2;
        column-gap: 10px;
        padding: 10px;
      }

      .proof-info {
        padding: 10px;
      }

      .proof-user {
        font-size: 14px;
      }

      .proof-mission {
        font-size: 12px;
      }

      .proof-rating {
        font-size: 12px;
      }

      .save-btn {
        font-size: 18px;
      }
    }

    .proof-card {
      background: rgba(26, 26, 26, 0.9);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
      break-inside: avoid;
      margin-bottom: 15px;
      display: inline-block;
      width: 100%;
      position: relative;
    }

    .proof-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
    }

    .proof-card:hover .proof-overlay {
      opacity: 1;
    }

    .proof-image-container {
      position: relative;
      width: 100%;
      overflow: hidden;
    }

    .proof-image {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
      background: #1A1A1A;
    }

    .proof-video {
      width: 100%;
      height: auto;
      display: block;
      background: #000;
    }

    .media-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #FFFFFF;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 5;
    }

    .proof-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 50%);
      opacity: 0;
      transition: opacity 0.3s;
      padding: 15px;
    }

    .save-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: #FFD700;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px 12px;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .save-btn:hover {
      transform: scale(1.2);
      background: rgba(0, 0, 0, 0.9);
    }

    .save-btn.saved {
      color: #C1272D;
    }

    .proof-info {
      padding: 15px;
    }

    .proof-user {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #FFFFFF;
    }

    .proof-mission {
      font-size: 13px;
      color: #999;
      margin-bottom: 10px;
    }

    .proof-rating {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .stars {
      color: #FFD700;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      max-width: 600px;
      margin: 0 auto;
      background: #1A1A1A;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .carousel-container {
      position: relative;
      width: 100%;
      max-height: 500px;
      background: #000;
      overflow: hidden;
    }

    .carousel-track {
      display: flex;
      transition: transform 0.3s ease;
    }

    .carousel-slide {
      min-width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .carousel-image {
      width: 100%;
      max-height: 500px;
      object-fit: contain;
    }

    .carousel-video {
      width: 100%;
      max-height: 500px;
    }

    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #FFFFFF;
      border: none;
      padding: 15px 20px;
      cursor: pointer;
      font-size: 24px;
      z-index: 10;
      transition: all 0.3s;
    }

    .carousel-btn:hover {
      background: rgba(193, 39, 45, 0.9);
    }

    .carousel-btn.prev {
      left: 10px;
    }

    .carousel-btn.next {
      right: 10px;
    }

    .carousel-dots {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s;
    }

    .carousel-dot.active {
      background: #C1272D;
      width: 24px;
      border-radius: 4px;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-close {
      float: right;
      font-size: 28px;
      cursor: pointer;
      color: #C1272D;
      line-height: 1;
    }

    .modal-close:hover {
      color: #FF3B42;
    }

    .rating-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(193, 39, 45, 0.1);
      border-radius: 12px;
    }

    .rating-stars {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }

    .rating-star {
      font-size: 36px;
      cursor: pointer;
      color: #666;
      transition: all 0.2s;
    }

    .rating-star:hover,
    .rating-star.active {
      color: #FFD700;
      transform: scale(1.2);
    }

    .comment-section {
      margin: 20px 0;
    }

    .comment-box {
      width: 100%;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #FFFFFF;
      font-size: 16px;
      font-family: 'Kanit', 'Arial', sans-serif;
      resize: vertical;
      min-height: 80px;
    }

    .comment-box:focus {
      outline: none;
      border-color: #C1272D;
      box-shadow: 0 0 10px rgba(193, 39, 45, 0.3);
    }

    .comment-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .comment-item {
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-left: 3px solid #C1272D;
      margin-bottom: 10px;
      border-radius: 8px;
    }

    .comment-user {
      font-weight: bold;
      color: #C1272D;
      margin-bottom: 5px;
    }

    .comment-text {
      color: #FFFFFF;
    }

    .ranking-view {
      display: none;
      padding: 20px;
    }

    .ranking-view.active {
      display: block;
    }

    .ranking-item {
      background: rgba(26, 26, 26, 0.9);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      transition: all 0.3s;
    }

    .ranking-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .ranking-number {
      font-size: 32px;
      font-weight: bold;
      color: #C1272D;
      min-width: 50px;
      text-align: center;
    }

    .ranking-number.top3 {
      color: #FFD700;
    }

    .ranking-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 12px;
    }

    .ranking-details {
      flex: 1;
    }

    .ranking-user {
      font-size: 20px;
      font-weight: bold;
      color: #FFFFFF;
    }

    .ranking-score {
      font-size: 18px;
      color: #FFD700;
      margin-top: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #C1272D;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
      gap: 20px;
    }

    .loading-overlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #C1272D;
      animation: spin 1s linear infinite;
    }

    .loading-overlay p {
      color: #FFFFFF;
      font-size: 18px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="loadingOverlay" class="loading-overlay">
   <div class="spinner"></div>
   <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>
  <div class="app-container" style="display: none;">
   <div class="header">
    <h1 id="appTitle">E-Cal Proof Gallery</h1>
    <div class="header-buttons"><button class="btn btn-secondary" id="rankingBtn">üèÜ Top 10</button> <button class="btn btn-secondary" id="savedBtn">‚ù§Ô∏è Saved</button> <button class="btn btn-secondary" id="galleryBtn" style="display:none;">üì∑ Gallery</button>
    </div>
   </div>
   <div id="galleryView">
    <div class="gallery-grid" id="galleryGrid"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
     <div class="empty-state-icon">
      üì∏
     </div>
     <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Proof</h2>
     <p>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î Proof ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
    </div>
   </div>
   <div class="ranking-view" id="rankingView">
    <div id="rankingList"></div>
    <div class="empty-state" id="rankingEmpty" style="display:none;">
     <div class="empty-state-icon">
      üèÜ
     </div>
     <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
     <p>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß Proof ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö!</p>
    </div>
   </div>
   <div class="ranking-view" id="savedView">
    <div class="gallery-grid" id="savedGrid"></div>
    <div class="empty-state" id="savedEmpty" style="display:none;">
     <div class="empty-state-icon">
      üíî
     </div>
     <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Proof ‡∏ó‡∏µ‡πà Save</h2>
     <p>‡∏Å‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠ Save Proof ‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö!</p>
    </div>
   </div>
   <div class="modal" id="proofModal">
    <div class="modal-content">
     <div class="carousel-container" id="carouselContainer">
      <div class="carousel-track" id="carouselTrack"></div><button class="carousel-btn prev" id="carouselPrev">‚Äπ</button> <button class="carousel-btn next" id="carouselNext">‚Ä∫</button>
      <div class="carousel-dots" id="carouselDots"></div>
     </div>
     <div class="modal-body"><span class="modal-close" id="modalClose">√ó</span>
      <h2 id="modalUser"></h2>
      <p id="modalMission"></p>
      <div class="rating-section">
       <h3>‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Proof ‡∏ô‡∏µ‡πâ</h3>
       <div class="rating-stars" id="ratingStars"></div>
       <p style="text-align:center; color:#999;" id="currentRating"></p>
      </div>
      <div class="comment-section">
       <h3>‡πÅ‡∏ã‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ üòà</h3><textarea class="comment-box" id="commentBox" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå..."></textarea> <button class="btn btn-primary" id="submitComment" style="width:100%; margin-top:10px;"> ‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå </button>
      </div>
      <div class="comment-section">
       <h3>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
       <div class="comment-list" id="commentList"></div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
    const LIFF_ID = '2007859046-z3WDAbWV';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const defaultConfig = {
      app_title: "E-Cal Proof Gallery",
      ranking_button_text: "üèÜ Top 10",
      primary_color: "#C1272D",
      background_color: "#000000",
      surface_color: "#1A1A1A",
      text_color: "#FFFFFF",
      accent_color: "#FFD700"
    };

    let currentView = 'gallery';
    let proofs = [];
    let comments = [];
    let ratings = [];
    let currentProofId = null;
    let currentUserId = null;
    let currentUserName = 'Guest';
    let currentSlideIndex = 0;
    let currentMediaFiles = [];
    let liffInitialized = false;

    const roastPrefixes = [
      "‡∏≠‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô: ",
      "‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™: ",
      "‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢: ",
      "‡πÄ‡∏Æ‡πâ‡∏¢‡πÄ‡∏ß‡πâ‡∏¢: ",
      "‡πÅ‡∏´‡∏°: ",
      "‡πÇ‡∏≠‡πâ‡πÇ‡∏´: ",
      "‡∏≠‡πâ‡∏≤‡∏ß: ",
      "5555: "
    ];

    async function onConfigChange(config) {
      document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('rankingBtn').textContent = config.ranking_button_text || defaultConfig.ranking_button_text;
      
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      
      document.body.style.background = backgroundColor;
      document.body.style.color = textColor;
      
      const appContainer = document.querySelector('.app-container');
      if (appContainer) {
        appContainer.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${surfaceColor} 100%)`;
      }
      
      const header = document.querySelector('.header');
      if (header) {
        header.style.background = `rgba(${hexToRgb(surfaceColor)}, 0.95)`;
      }
      
      const h1 = document.querySelector('.header h1');
      if (h1) {
        h1.style.color = textColor;
      }
      
      const primaryButtons = document.querySelectorAll('.btn-primary');
      primaryButtons.forEach(btn => {
        btn.style.background = primaryColor;
      });
      
      const cards = document.querySelectorAll('.proof-card, .ranking-item, .modal-content');
      cards.forEach(card => {
        card.style.background = `rgba(${hexToRgb(surfaceColor)}, 0.9)`;
      });
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '26, 26, 26';
    }

    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return false;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        currentUserName = profile.displayName || 'User';
        liffInitialized = true;
        
        return true;
      } catch (error) {
        console.error('LIFF Init Error:', error);
        currentUserId = 'guest_' + Math.random().toString(36).substr(2, 9);
        currentUserName = 'Guest';
        return true;
      }
    }

    async function loadProofs() {
      try {
        const { data, error } = await supabase
          .from('proof_media')
          .select(`
            *,
            user_challenges_proof!inner(
              proof_id,
              line_user_id,
              challenge_id,
              proof_date,
              description
            )
          `)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const proofMap = new Map();
        
        data.forEach(item => {
          const proofId = item.user_challenges_proof.proof_id;
          
          if (!proofMap.has(proofId)) {
            proofMap.set(proofId, {
              id: proofId.toString(),
              userId: item.user_challenges_proof.line_user_id,
              userName: 'User ' + item.user_challenges_proof.line_user_id.substr(-4),
              missionName: `Challenge ${item.user_challenges_proof.challenge_id}`,
              uploadedAt: item.user_challenges_proof.proof_date,
              mediaFiles: [],
              totalRating: 0,
              ratingCount: 0
            });
          }
          
          proofMap.get(proofId).mediaFiles.push({
            url: item.media_url,
            type: item.media_type
          });
        });

        proofs = Array.from(proofMap.values());
        
        await loadRatings();
        
        return true;
      } catch (error) {
        console.error('Load Proofs Error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Proof ‡πÑ‡∏î‡πâ');
        return false;
      }
    }

    async function loadRatings() {
      try {
        const { data, error } = await supabase
          .from('proof_ratings')
          .select('proof_id, rating');

        if (error) throw error;

        const ratingMap = new Map();
        
        data.forEach(rating => {
          const key = rating.proof_id.toString();
          if (!ratingMap.has(key)) {
            ratingMap.set(key, { total: 0, count: 0 });
          }
          ratingMap.get(key).total += rating.rating;
          ratingMap.get(key).count += 1;
        });

        proofs.forEach(proof => {
          const ratingData = ratingMap.get(proof.id);
          if (ratingData) {
            proof.totalRating = ratingData.total;
            proof.ratingCount = ratingData.count;
          }
        });
      } catch (error) {
        console.error('Load Ratings Error:', error);
      }
    }

    async function loadComments(proofId) {
      try {
        const { data, error } = await supabase
          .from('proof_comments')
          .select('*')
          .eq('proof_id', parseInt(proofId))
          .order('created_at', { ascending: false })
          .limit(5);

        if (error) throw error;

        const commentList = document.getElementById('commentList');
        
        if (!data || data.length === 0) {
          commentList.innerHTML = '<p style="color:#999; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</p>';
          return;
        }

        commentList.innerHTML = data.map(comment => `
          <div class="comment-item">
            <div class="comment-user">User ${comment.commenter_line_user_id.substr(-4)}</div>
            <div class="comment-text">${comment.comment_text}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Load Comments Error:', error);
      }
    }

    function parseMediaFiles(mediaFilesArray) {
      return Array.isArray(mediaFilesArray) ? mediaFilesArray : [];
    }

    function renderGallery() {
      const grid = document.getElementById('galleryGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (proofs.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      grid.innerHTML = proofs.map(proof => {
        const avgRating = proof.ratingCount > 0 ? (proof.totalRating / proof.ratingCount).toFixed(1) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
        const stars = proof.ratingCount > 0 ? '‚≠ê'.repeat(Math.round(proof.totalRating / proof.ratingCount)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
        const isSaved = localStorage.getItem('saved_' + proof.id) === 'true';
        const saveIcon = isSaved ? '‚ù§Ô∏è' : 'ü§ç';
        
        const mediaFiles = parseMediaFiles(proof.mediaFiles);
        const firstMedia = mediaFiles[0] || {};
        const mediaCount = mediaFiles.length;
        
        let mediaHtml = '';
        if (firstMedia.type === 'video') {
          mediaHtml = `<video class="proof-video" src="${firstMedia.url}" muted loop autoplay playsinline></video>`;
        } else {
          mediaHtml = `<img class="proof-image" src="${firstMedia.url || ''}" alt="${proof.userName}" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">`;
        }
        
        const mediaIndicator = mediaCount > 1 ? `<div class="media-indicator">üì∑ ${mediaCount}</div>` : '';
        
        return `
          <div class="proof-card" onclick="openModal('${proof.id}')">
            <div class="proof-image-container">
              ${mediaHtml}
              ${mediaIndicator}
              <div class="proof-overlay"></div>
              <button class="save-btn ${isSaved ? 'saved' : ''}" onclick="event.stopPropagation(); toggleSave('${proof.id}')" id="save_${proof.id}">
                ${saveIcon}
              </button>
            </div>
            <div class="proof-info">
              <div class="proof-user">${proof.userName}</div>
              <div class="proof-mission">üéØ ${proof.missionName}</div>
              <div class="proof-rating">
                <span class="stars">${stars}</span>
                <span>${avgRating}${proof.ratingCount > 0 ? ' (' + proof.ratingCount + ')' : ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openModal(proofId) {
      currentProofId = proofId;
      const proof = proofs.find(p => p.id === proofId);
      if (!proof) return;
      
      currentMediaFiles = parseMediaFiles(proof.mediaFiles);
      currentSlideIndex = 0;
      
      document.getElementById('modalUser').textContent = proof.userName;
      document.getElementById('modalMission').textContent = 'üéØ ' + proof.missionName;
      
      renderCarousel();
      updateModalRating();
      loadComments(proofId);
      
      document.getElementById('proofModal').classList.add('active');
    }

    function renderCarousel() {
      const track = document.getElementById('carouselTrack');
      const dots = document.getElementById('carouselDots');
      const prevBtn = document.getElementById('carouselPrev');
      const nextBtn = document.getElementById('carouselNext');
      
      if (currentMediaFiles.length === 0) {
        track.innerHTML = '<div class="carousel-slide"><p style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå</p></div>';
        dots.innerHTML = '';
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
      }
      
      track.innerHTML = currentMediaFiles.map(media => {
        if (media.type === 'video') {
          return `
            <div class="carousel-slide">
              <video class="carousel-video" src="${media.url}" controls autoplay muted loop playsinline></video>
            </div>
          `;
        } else {
          return `
            <div class="carousel-slide">
              <img class="carousel-image" src="${media.url}" alt="Proof" onerror="this.src=''; this.alt='Image failed to load';">
            </div>
          `;
        }
      }).join('');
      
      dots.innerHTML = currentMediaFiles.map((_, index) => 
        `<div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>`
      ).join('');
      
      if (currentMediaFiles.length > 1) {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
      } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }
      
      updateCarousel();
    }

    function updateCarousel() {
      const track = document.getElementById('carouselTrack');
      track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
      
      const dotElements = document.querySelectorAll('.carousel-dot');
      dotElements.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlideIndex);
      });
    }

    function goToSlide(index) {
      currentSlideIndex = index;
      updateCarousel();
    }

    document.getElementById('carouselPrev').onclick = function() {
      currentSlideIndex = (currentSlideIndex - 1 + currentMediaFiles.length) % currentMediaFiles.length;
      updateCarousel();
    };

    document.getElementById('carouselNext').onclick = function() {
      currentSlideIndex = (currentSlideIndex + 1) % currentMediaFiles.length;
      updateCarousel();
    };

    function updateModalRating() {
      const proof = proofs.find(p => p.id === currentProofId);
      if (!proof) return;
      
      const avgRating = proof.ratingCount > 0 ? (proof.totalRating / proof.ratingCount).toFixed(1) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
      const ratingText = proof.ratingCount > 0 ? `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgRating} ‚≠ê (${proof.ratingCount} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß - ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å!';
      
      document.getElementById('currentRating').textContent = ratingText;
      
      const starsContainer = document.getElementById('ratingStars');
      starsContainer.innerHTML = '';
      
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'rating-star';
        star.textContent = '‚≠ê';
        star.onclick = () => submitRating(i);
        starsContainer.appendChild(star);
      }
    }

    async function submitRating(stars) {
      if (!liffInitialized) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô LINE');
        return;
      }

      const userRatingKey = `rating_${currentUserId}_${currentProofId}`;
      const hasRated = localStorage.getItem(userRatingKey);
      
      if (hasRated) {
        showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß!');
        return;
      }
      
      const btn = document.getElementById('submitComment');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const { error } = await supabase
          .from('proof_ratings')
          .insert({
            proof_id: parseInt(currentProofId),
            rater_line_user_id: currentUserId,
            rating: stars
          });

        if (error) throw error;

        localStorage.setItem(userRatingKey, stars.toString());
        showToast(`‚úÖ ‡πÉ‡∏´‡πâ ${stars} ‡∏î‡∏≤‡∏ß!`);
        
        await loadRatings();
        renderGallery();
        updateModalRating();
        
      } catch (error) {
        console.error('Submit Rating Error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ');
      }
      
      btn.disabled = false;
      btn.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå';
    }

    document.getElementById('submitComment').onclick = async function() {
      if (!liffInitialized) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô LINE');
        return;
      }

      const commentText = document.getElementById('commentBox').value.trim();
      if (!commentText) {
        showToast('‚ùå ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏Å‡πà‡∏≠‡∏ô!');
        return;
      }
      
      const btn = this;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const prefix = roastPrefixes[Math.floor(Math.random() * roastPrefixes.length)];
        
        const { error } = await supabase
          .from('proof_comments')
          .insert({
            proof_id: parseInt(currentProofId),
            commenter_line_user_id: currentUserId,
            comment_text: prefix + commentText
          });

        if (error) throw error;

        loadComments(currentProofId);
        document.getElementById('commentBox').value = '';
        showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!');
        
      } catch (error) {
        console.error('Submit Comment Error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ');
      }
      
      btn.disabled = false;
      btn.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå';
    };

    document.getElementById('modalClose').onclick = function() {
      document.getElementById('proofModal').classList.remove('active');
      currentProofId = null;
      
      const videos = document.querySelectorAll('.carousel-video');
      videos.forEach(video => video.pause());
    };

    document.getElementById('rankingBtn').onclick = function() {
      currentView = 'ranking';
      document.getElementById('galleryView').style.display = 'none';
      document.getElementById('rankingView').classList.add('active');
      document.getElementById('savedView').classList.remove('active');
      document.getElementById('galleryBtn').style.display = 'inline-block';
      renderRanking();
    };

    document.getElementById('galleryBtn').onclick = function() {
      currentView = 'gallery';
      document.getElementById('galleryView').style.display = 'block';
      document.getElementById('rankingView').classList.remove('active');
      document.getElementById('savedView').classList.remove('active');
      document.getElementById('galleryBtn').style.display = 'none';
    };

    document.getElementById('savedBtn').onclick = function() {
      currentView = 'saved';
      document.getElementById('galleryView').style.display = 'none';
      document.getElementById('rankingView').classList.remove('active');
      document.getElementById('savedView').classList.add('active');
      document.getElementById('galleryBtn').style.display = 'inline-block';
      renderSavedProofs();
    };

    function renderRanking() {
      const rankingList = document.getElementById('rankingList');
      const rankingEmpty = document.getElementById('rankingEmpty');
      
      const rankedProofs = proofs
        .filter(p => p.ratingCount > 0)
        .map(p => ({
          ...p,
          avgRating: p.totalRating / p.ratingCount
        }))
        .sort((a, b) => b.avgRating - a.avgRating)
        .slice(0, 10);
      
      if (rankedProofs.length === 0) {
        rankingList.innerHTML = '';
        rankingEmpty.style.display = 'block';
        return;
      }
      
      rankingEmpty.style.display = 'none';
      
      rankingList.innerHTML = rankedProofs.map((proof, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? 'top3' : '';
        const stars = '‚≠ê'.repeat(Math.round(proof.avgRating));
        
        const mediaFiles = parseMediaFiles(proof.mediaFiles);
        const firstMedia = mediaFiles[0] || {};
        const thumbUrl = firstMedia.url || '';
        
        return `
          <div class="ranking-item" onclick="openModal('${proof.id}')" style="cursor: pointer;">
            <div class="ranking-number ${rankClass}">${rank}</div>
            <img class="ranking-thumb" src="${thumbUrl}" alt="${proof.userName}" onerror="this.style.display='none';">
            <div class="ranking-details">
              <div class="ranking-user">${proof.userName}</div>
              <div style="color:#999;">${proof.missionName}</div>
              <div class="ranking-score">${stars} ${proof.avgRating.toFixed(2)} (${proof.ratingCount} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleSave(proofId) {
      const saveKey = 'saved_' + proofId;
      const isSaved = localStorage.getItem(saveKey) === 'true';
      
      if (isSaved) {
        localStorage.removeItem(saveKey);
        showToast('üíî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Save ‡πÅ‡∏•‡πâ‡∏ß');
      } else {
        localStorage.setItem(saveKey, 'true');
        showToast('‚ù§Ô∏è Save ‡πÅ‡∏•‡πâ‡∏ß!');
      }
      
      renderGallery();
      if (currentView === 'saved') {
        renderSavedProofs();
      }
    }

    function renderSavedProofs() {
      const savedGrid = document.getElementById('savedGrid');
      const savedEmpty = document.getElementById('savedEmpty');
      
      const savedProofs = proofs.filter(proof => {
        const saveKey = 'saved_' + proof.id;
        return localStorage.getItem(saveKey) === 'true';
      });
      
      if (savedProofs.length === 0) {
        savedGrid.innerHTML = '';
        savedEmpty.style.display = 'block';
        return;
      }
      
      savedEmpty.style.display = 'none';
      
      savedGrid.innerHTML = savedProofs.map(proof => {
        const avgRating = proof.ratingCount > 0 ? (proof.totalRating / proof.ratingCount).toFixed(1) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
        const stars = proof.ratingCount > 0 ? '‚≠ê'.repeat(Math.round(proof.totalRating / proof.ratingCount)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
        
        const mediaFiles = parseMediaFiles(proof.mediaFiles);
        const firstMedia = mediaFiles[0] || {};
        const mediaCount = mediaFiles.length;
        
        let mediaHtml = '';
        if (firstMedia.type === 'video') {
          mediaHtml = `<video class="proof-video" src="${firstMedia.url}" muted loop autoplay playsinline></video>`;
        } else {
          mediaHtml = `<img class="proof-image" src="${firstMedia.url || ''}" alt="${proof.userName}" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">`;
        }
        
        const mediaIndicator = mediaCount > 1 ? `<div class="media-indicator">üì∑ ${mediaCount}</div>` : '';
        
        return `
          <div class="proof-card" onclick="openModal('${proof.id}')">
            <div class="proof-image-container">
              ${mediaHtml}
              ${mediaIndicator}
              <div class="proof-overlay"></div>
              <button class="save-btn saved" onclick="event.stopPropagation(); toggleSave('${proof.id}')" id="save_${proof.id}">
                ‚ù§Ô∏è
              </button>
            </div>
            <div class="proof-info">
              <div class="proof-user">${proof.userName}</div>
              <div class="proof-mission">üéØ ${proof.missionName}</div>
              <div class="proof-rating">
                <span class="stars">${stars}</span>
                <span>${avgRating}${proof.ratingCount > 0 ? ' (' + proof.ratingCount + ')' : ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showToast(message) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #C1272D;
        color: #FFFFFF;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 5px 20px rgba(193, 39, 45, 0.5);
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    async function init() {
      try {
        if (window.elementSdk) {
          await window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.primary_color || defaultConfig.primary_color,
                  set: (value) => {
                    config.primary_color = value;
                    window.elementSdk.setConfig({ primary_color: value });
                  }
                },
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    config.background_color = value;
                    window.elementSdk.setConfig({ background_color: value });
                  }
                },
                {
                  get: () => config.surface_color || defaultConfig.surface_color,
                  set: (value) => {
                    config.surface_color = value;
                    window.elementSdk.setConfig({ surface_color: value });
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                },
                {
                  get: () => config.accent_color || defaultConfig.accent_color,
                  set: (value) => {
                    config.accent_color = value;
                    window.elementSdk.setConfig({ accent_color: value });
                  }
                }
              ],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
              ["app_title", config.app_title || defaultConfig.app_title],
              ["ranking_button_text", config.ranking_button_text || defaultConfig.ranking_button_text]
            ])
          });

          await onConfigChange(window.elementSdk.config);
        }

        const liffSuccess = await initializeLIFF();
        
        if (liffSuccess) {
          await loadProofs();
          renderGallery();
        }

        document.getElementById('loadingOverlay').style.display = 'none';
        document.querySelector('.app-container').style.display = 'block';

      } catch (error) {
        console.error('Init Error:', error);
        document.getElementById('loadingOverlay').querySelector('p').textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
          document.querySelector('.app-container').style.display = 'block';
        }, 2000);
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a72884a701ed339',t:'MTc2NDU5MTU2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>