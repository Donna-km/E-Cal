<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Cal Proof Challenge</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #FFE5F1 0%, #FFF8DC 100%);
            min-height: 100%;
            overflow-x: hidden;
            position: relative;
        }

        html, body {
            height: 100%;
        }



        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(255, 57, 116, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 57, 116, 0.1);
            width: 100%;
            text-align: center;
            transition: all 0.3s ease;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FF3974;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(255, 57, 116, 0.2);
        }

        .subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
            font-weight: 400;
        }

        .upload-box {
            border: 3px dashed #FF3974;
            border-radius: 20px;
            padding: 40px 20px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #FFF0F5 0%, #FFFFFF 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-box:hover {
            border-color: #E6326A;
            background: linear-gradient(135deg, #FFE8F0 0%, #FFF5F8 100%);
            transform: translateY(-2px);
        }

        .upload-box::before {
            content: 'üì∏';
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #FF3974;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #999;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #FFB6C1;
            border-radius: 15px;
            font-size: 1rem;
            font-family: 'Kanit', sans-serif;
            transition: all 0.3s ease;
            background: #FAFAFA;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #FF3974;
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(255, 57, 116, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            text-align: left;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #FF3974;
        }

        .checkbox-label {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .submit-btn, .ig-btn {
            background: linear-gradient(135deg, #FF3974 0%, #E6326A 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(255, 57, 116, 0.3);
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .submit-btn:hover, .ig-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 57, 116, 0.4);
            background: linear-gradient(135deg, #E6326A 0%, #CC2D5F 100%);
        }

        .submit-btn:active, .ig-btn:active {
            transform: translateY(-1px);
        }

        .back-btn {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            color: #333;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(255, 182, 193, 0.3);
            margin: 10px;
            display: inline-block;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 182, 193, 0.4);
            background: linear-gradient(135deg, #FFA0B4 0%, #FF8FA3 100%);
        }

        .back-btn:active {
            transform: translateY(0px);
        }

        .success-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        .success-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #FF3974;
            margin-bottom: 15px;
        }

        .success-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #FF3974;
            animation: confetti-fall 3s linear infinite;
            z-index: 1000;
        }

        .confetti:nth-child(odd) {
            background: #FFB6C1;
            width: 8px;
            height: 8px;
            animation-duration: 2.5s;
        }

        .confetti:nth-child(3n) {
            background: #FFC0CB;
            width: 6px;
            height: 6px;
            animation-duration: 3.5s;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .floating-stickers {
            position: fixed;
            font-size: 1.5rem;
            opacity: 0.7;
            animation: sticker-float 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 5;
        }

        .floating-stickers:nth-child(1) {
            top: 15%;
            left: 5%;
            animation-delay: 0s;
        }

        .floating-stickers:nth-child(2) {
            top: 70%;
            right: 10%;
            animation-delay: 3s;
        }

        .floating-stickers:nth-child(3) {
            top: 40%;
            left: 85%;
            animation-delay: 6s;
        }

        @keyframes sticker-float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
            33% { transform: translateY(-15px) rotate(10deg) scale(1.1); }
            66% { transform: translateY(10px) rotate(-5deg) scale(0.9); }
        }

        .loading {
            display: none;
            color: #FF3974;
            font-weight: 600;
            margin-top: 10px;
        }

        .login-message {
            text-align: center;
            padding: 40px;
            color: #FF3974;
            font-size: 1.2rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 30px 20px;
            }
            
            .header {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- Loading/Login Page -->
   <div id="loginPage" class="page active">
    <div class="card">
     <div class="login-message">
      <div style="font-size: 3rem; margin-bottom: 20px;">
       üîê
      </div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...<br><small style="color: #999;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</small>
     </div>
    </div>
   </div><!-- PAGE 1: Upload Form -->
   <div id="page1" class="page">
    <div class="card">
     <h1 class="header" id="main-title">üì∏ ‡∏≠‡∏ß‡∏î‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏• üëÄ</h1>
     <p class="subtitle" id="subtitle">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ Proof ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏° üí™</p>
     <form id="uploadForm">
      <div class="upload-box" onclick="document.getElementById('fileInput').click()">
       <div class="upload-text">
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
       </div>
       <div class="upload-subtext">
        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå JPG, PNG, MP4
       </div><input type="file" id="fileInput" multiple accept="image/*,video/*" style="display: none;">
      </div>
      <div class="form-group"><label for="caption" class="form-label">üí¨ ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô</label> <textarea id="caption" class="form-textarea" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏î‡∏ô‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏î‡πà‡∏≤‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß üòÇ"></textarea>
      </div>
      <div class="form-group"><label for="instagram" class="form-label">üì± Instagram Username</label> <input type="text" id="instagram" class="form-input" placeholder="IG ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ä‡πà‡∏ô donna.fitstyle">
      </div>
      <div class="checkbox-group"><input type="checkbox" id="sendToEcal" class="checkbox" checked> <label for="sendToEcal" class="checkbox-label">‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏î‡∏π</label>
      </div><button type="submit" class="submit-btn">‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏î‡∏π üíÖ</button>
      <div class="loading" id="loading">
       ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á... ‚ú®
      </div>
     </form>
    </div>
   </div><!-- PAGE 2: Success Page -->
   <div id="page2" class="page">
    <div class="card">
     <div class="success-icon">
      ‚ú®üíñ‚ú®
     </div>
     <h1 class="success-title" id="success-title">üíñ ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ò‡∏≠‡∏°‡∏≤‡∏Å!</h1>
     <p class="success-subtitle" id="success-subtitle">‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á @e.cal.official ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏•‡∏Å‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏° üëè</p>
     <div style="margin: 20px 0;"><a href="https://www.instagram.com/e.cal.official/" target="_blank" rel="noopener noreferrer" class="ig-btn"> ‡πÑ‡∏õ‡∏î‡∏π IG ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏• üíÖ </a> <button onclick="goBackToPage1()" class="back-btn"> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å üîÑ </button>
     </div>
    </div><!-- Floating Stickers for Success Page -->
    <div class="floating-stickers">
     üíñ
    </div>
    <div class="floating-stickers">
     ‚ú®
    </div>
    <div class="floating-stickers">
     üì∏
    </div>
   </div>
  </div>
  <script>
        // Configuration object
        const defaultConfig = {
            main_title: "üì∏ ‡∏≠‡∏ß‡∏î‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏• üëÄ",
            subtitle: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ Proof ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏° üí™",
            success_title: "üíñ ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ò‡∏≠‡∏°‡∏≤‡∏Å!",
            success_subtitle: "‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á @e.cal.official ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏•‡∏Å‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏° üëè"
        };

        // Global variables
        let userProfile = null;
        let supabase = null;

        // Initialize Supabase
        function initSupabase() {
            const supabaseUrl = 'https://lvtdqeerzxpznnayccmb.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        }

        // Data handler for SDK
        const dataHandler = {
            onDataChanged(data) {
                // Update UI if needed - for this app we don't need to display stored data
                console.log('Data updated:', data.length, 'submissions');
            }
        };

        // Initialize LIFF
        async function initializeLIFF() {
            try {
                await liff.init({ liffId: "2007859046-5n7a6M7V" });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                // Get user profile
                userProfile = await liff.getProfile();
                console.log('User profile:', userProfile);
                
                // Show main app
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('page1').classList.add('active');
                
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                // Fallback - show app anyway for testing
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('page1').classList.add('active');
            }
        }

        // Initialize SDKs
        async function initializeApp() {
            // Initialize Supabase
            initSupabase();
            
            // Initialize LIFF
            await initializeLIFF();
            
            // Initialize Data SDK
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error('Failed to initialize data SDK');
                }
            }

            // Initialize Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        // Update text content based on config
                        const mainTitle = document.getElementById('main-title');
                        const subtitle = document.getElementById('subtitle');
                        const successTitle = document.getElementById('success-title');
                        const successSubtitle = document.getElementById('success-subtitle');

                        if (mainTitle) mainTitle.textContent = config.main_title || defaultConfig.main_title;
                        if (subtitle) subtitle.textContent = config.subtitle || defaultConfig.subtitle;
                        if (successTitle) successTitle.textContent = config.success_title || defaultConfig.success_title;
                        if (successSubtitle) successSubtitle.textContent = config.success_subtitle || defaultConfig.success_subtitle;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["main_title", config.main_title || defaultConfig.main_title],
                        ["subtitle", config.subtitle || defaultConfig.subtitle],
                        ["success_title", config.success_title || defaultConfig.success_title],
                        ["success_subtitle", config.success_subtitle || defaultConfig.success_subtitle]
                    ])
                });
            }
        }

        // Get user challenge data
        async function getUserChallengeData(lineUserId) {
            if (!supabase) return null;
            
            try {
                const { data, error } = await supabase
                    .from('user_challenges')
                    .select('id, current_day, is_active')
                    .eq('line_user_id', lineUserId)
                    .eq('is_active', true)
                    .single();
                
                if (error) {
                    console.error('Error fetching user challenge:', error);
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('Error in getUserChallengeData:', error);
                return null;
            }
        }

        // Upload files to Supabase Storage
        async function uploadFilesToStorage(files, lineUserId, challengeId, dayNumber) {
            if (!supabase || !files || files.length === 0) return [];
            
            const uploadedFiles = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop();
                const fileName = `${lineUserId}_challenge${challengeId}_day${dayNumber}_${Date.now()}_${i}.${fileExt}`;
                
                try {
                    const { data, error } = await supabase.storage
                        .from('proof')
                        .upload(fileName, file);
                    
                    if (error) {
                        console.error('Upload error:', error);
                        continue;
                    }
                    
                    // Get public URL
                    const { data: urlData } = supabase.storage
                        .from('proof')
                        .getPublicUrl(fileName);
                    
                    uploadedFiles.push({
                        fileName: fileName,
                        originalName: file.name,
                        fileSize: file.size,
                        fileType: file.type,
                        publicUrl: urlData.publicUrl
                    });
                    
                } catch (error) {
                    console.error('File upload error:', error);
                }
            }
            
            return uploadedFiles;
        }

        // Save to Supabase
        async function saveToSupabase(data, files) {
            if (!supabase) return { success: false, error: 'Supabase not initialized' };
            
            const lineUserId = userProfile?.userId || 'anonymous';
            
            // Get user challenge data first
            const challengeData = await getUserChallengeData(lineUserId);
            
            if (!challengeData) {
                return { 
                    success: false, 
                    error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Challenge ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Challenge ‡∏Å‡πà‡∏≠‡∏ô' 
                };
            }
            
            // Upload files to storage
            const uploadedFiles = await uploadFilesToStorage(files, lineUserId, challengeData.id, challengeData.current_day);
            
            try {
                const { data: result, error } = await supabase
                    .from('user_challenges_proof')
                    .insert([{
                        line_user_id: lineUserId,
                        user_challenge_id: challengeData.id,
                        day_number: challengeData.current_day,
                        proof_type: uploadedFiles.length > 0 ? 'image' : 'text',
                        proof_content: JSON.stringify({
                            caption: data.caption,
                            instagram_username: data.instagram_username,
                            send_to_ecal: data.send_to_ecal,
                            files_count: data.files_count || 0,
                            uploaded_files: uploadedFiles
                        }),
                        proof_date: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('Supabase error:', error);
                    return { success: false, error: error.message };
                }

                // Update user challenge progress after successful proof submission
                await updateChallengeProgress(challengeData.id, challengeData.current_day);
                
                return { success: true, data: result, uploadedFiles: uploadedFiles };
            } catch (error) {
                console.error('Supabase save error:', error);
                return { success: false, error: error.message };
            }
        }

        // Update challenge progress
        async function updateChallengeProgress(challengeId, currentDay) {
            if (!supabase) return;
            
            try {
                const { error } = await supabase
                    .from('user_challenges')
                    .update({
                        completed_days: currentDay,
                        current_day: currentDay < 7 ? currentDay + 1 : currentDay,
                        last_submitted_at: new Date().toISOString(),
                        is_active: currentDay < 7 // Set to false if completed all 7 days
                    })
                    .eq('id', challengeId);
                
                if (error) {
                    console.error('Error updating challenge progress:', error);
                }
            } catch (error) {
                console.error('Error in updateChallengeProgress:', error);
            }
        }

        // Form submission handler
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const caption = document.getElementById('caption').value;
            const instagram = document.getElementById('instagram').value;
            const sendToEcal = document.getElementById('sendToEcal').checked;
            const files = document.getElementById('fileInput').files;
            const loading = document.getElementById('loading');
            const submitBtn = document.querySelector('.submit-btn');
            
            // Show loading state
            loading.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.7';
            
            const submissionData = {
                caption: caption || '',
                instagram_username: instagram || '',
                send_to_ecal: sendToEcal,
                files_count: files.length,
                uploaded_at: new Date().toISOString()
            };
            
            // Save to Supabase (with file upload)
            const supabaseResult = await saveToSupabase(submissionData, files);
            
            // Save to Canva Sheet (Data SDK)
            let canvaResult = { isOk: true };
            if (window.dataSdk) {
                const canvaData = {
                    id: Date.now().toString(),
                    ...submissionData,
                    uploaded_files_count: supabaseResult.uploadedFiles ? supabaseResult.uploadedFiles.length : 0
                };
                canvaResult = await window.dataSdk.create(canvaData);
            }
            
            if (supabaseResult.success || canvaResult.isOk) {
                // Success - transition to page 2
                setTimeout(() => {
                    showPage2();
                }, 1000);
            } else {
                // Error handling - show specific error message
                const errorMessage = supabaseResult.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà üòÖ';
                loading.textContent = errorMessage;
                loading.style.color = '#FF3974';
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                
                setTimeout(() => {
                    loading.style.display = 'none';
                    loading.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á... ‚ú®';
                    loading.style.color = '#FF3974';
                }, 5000);
            }
        });

        // Show page 2 with animations
        function showPage2() {
            document.getElementById('page1').classList.remove('active');
            document.getElementById('page2').classList.add('active');
            
            // Create confetti effect
            createConfetti();
        }

        // Go back to page 1 function
        function goBackToPage1() {
            document.getElementById('page2').classList.remove('active');
            document.getElementById('page1').classList.add('active');
            
            // Reset form
            document.getElementById('uploadForm').reset();
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.submit-btn').disabled = false;
            document.querySelector('.submit-btn').style.opacity = '1';
            
            // Reset upload box
            const uploadBox = document.querySelector('.upload-box');
            const uploadText = uploadBox.querySelector('.upload-text');
            uploadText.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠';
            uploadBox.style.borderColor = '#FF3974';
            uploadBox.style.background = 'linear-gradient(135deg, #FFF0F5 0%, #FFFFFF 100%)';
        }

        // Confetti animation
        function createConfetti() {
            const colors = ['#FF3974', '#FFB6C1', '#FFC0CB', '#FF69B4', '#FFE4E1'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    document.body.appendChild(confetti);
                    
                    // Remove confetti after animation
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 4000);
                }, i * 100);
            }
        }

        // File input change handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = e.target.files;
            const uploadBox = document.querySelector('.upload-box');
            
            if (files.length > 0) {
                const uploadText = uploadBox.querySelector('.upload-text');
                uploadText.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ${files.length} ‡πÑ‡∏ü‡∏•‡πå ‚úÖ`;
                uploadBox.style.borderColor = '#28a745';
                uploadBox.style.background = 'linear-gradient(135deg, #E8F5E8 0%, #F0FFF0 100%)';
            }
        });

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 </body>
</html>
