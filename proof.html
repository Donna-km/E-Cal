<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Proof Upload System</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #000000;
      color: #ffffff;
      min-height: 100%;
      overflow-x: hidden;
    }
    
    * {
      box-sizing: border-box;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100%;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      font-size: 32px;
      margin: 0 0 10px 0;
      text-align: center;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 30px;
      font-size: 16px;
    }

    .upload-zone {
      border: 2px dashed #C1272D;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(193, 39, 45, 0.05);
    }

    .upload-zone:hover {
      background: rgba(193, 39, 45, 0.1);
      border-color: #ff3940;
    }

    .upload-zone.drag-over {
      background: rgba(193, 39, 45, 0.15);
      border-color: #ff3940;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    input[type="file"] {
      display: none;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }

    .preview-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.05);
      aspect-ratio: 1;
    }

    .preview-item img,
    .preview-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-item .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #C1272D;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }

    .preview-item .delete-btn:hover {
      background: #ff3940;
      transform: scale(1.1);
    }

    .file-type-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid #C1272D;
      background: transparent;
      color: white;
      margin-top: 20px;
    }

    .btn:hover:not(:disabled) {
      background: #C1272D;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(193, 39, 45, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.loading {
      position: relative;
      color: transparent;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .success-page {
      text-align: center;
      padding: 40px 20px;
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .success-message {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .points-earned {
      font-size: 48px;
      font-weight: 800;
      color: #C1272D;
      margin: 20px 0;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 10px;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(5px);
    }

    .leaderboard-item.current-user {
      background: rgba(193, 39, 45, 0.2);
      border: 2px solid #C1272D;
    }

    .rank {
      font-size: 20px;
      font-weight: 700;
      min-width: 40px;
      text-align: center;
    }

    .rank-icon {
      font-size: 28px;
    }

    .profile-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .user-points {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
    }

    .points-display {
      font-size: 22px;
      font-weight: 700;
      color: #C1272D;
    }

    .current-rank-card {
      background: rgba(193, 39, 45, 0.1);
      border: 2px solid #C1272D;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .next-rank-info {
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .error-message {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
      color: #ff3b30;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      text-align: center;
    }

    .file-info {
      margin-top: 15px;
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }

      .glass-card {
        padding: 20px;
      }

      h1 {
        font-size: 26px;
      }

      .preview-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <canvas id="confettiCanvas" class="confetti-canvas"></canvas><!-- Loading Page -->
  <div id="loadingPage" class="page active" style="display: flex; align-items: center; justify-content: center; min-height: 100%; text-align: center;">
   <div>
    <div style="font-size: 60px; margin-bottom: 20px;">
     ‚è≥
    </div>
    <div style="font-size: 20px; font-weight: 600;">
     ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
    </div>
    <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-top: 10px;">
     ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
    </div>
   </div>
  </div>
  <div class="container"><!-- Page 1: Upload -->
   <div id="uploadPage" class="page">
    <div class="glass-card">
     <h1 id="uploadTitle">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Proof</h1>
     <p class="subtitle" id="uploadSubtitle">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 30MB ‡∏ï‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)</p>
     <div class="upload-zone" id="uploadZone">
      <div class="upload-icon">
       üì§
      </div>
      <div>
       ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á
      </div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-top: 8px;">
       ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
      </div>
     </div><input type="file" id="fileInput" accept="image/*,video/*" multiple>
     <div class="file-info" id="fileInfo"></div>
     <div class="preview-grid" id="previewGrid"></div>
     <div id="errorMessage"></div><button class="btn" id="submitBtn" disabled> <span id="submitBtnText">‡∏™‡πà‡∏á Proof</span> </button>
    </div>
   </div><!-- Page 2: Success -->
   <div id="successPage" class="page">
    <div class="glass-card">
     <div class="success-page">
      <div class="success-icon">
       üéâ
      </div>
      <div class="success-message" id="successMessage"></div>
      <div class="points-earned" id="pointsEarned"></div><button class="btn" id="viewLeaderboardBtn">‡∏î‡∏π Leaderboard</button>
     </div>
    </div>
   </div><!-- Page 3: Leaderboard -->
   <div id="leaderboardPage" class="page">
    <div class="glass-card">
     <h1 id="leaderboardTitle">Leaderboard</h1>
     <div id="currentRankCard"></div>
     <div id="leaderboardList"></div><button class="btn" id="backToUploadBtn">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    </div>
   </div>
  </div>
  <script>
    // ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const LIFF_ID = "2007859046-5n7a6M7V"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_URL = "https://lvtdqeerzxpznnayccmb.supabase.co"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Supabase URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Supabase Anon Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    // Default configuration
    const defaultConfig = {
      background_color: "#000000",
      card_color: "rgba(255, 255, 255, 0.08)",
      text_color: "#ffffff",
      button_color: "#C1272D",
      upload_title: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Proof",
      upload_subtitle: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
      submit_button_text: "‡∏™‡πà‡∏á Proof",
      leaderboard_title: "Leaderboard"
    };

    let selectedFiles = [];
    let currentUser = null;
    let supabaseClient = null;

    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
    const encouragementMessages = [
      "‡πÇ‡∏´ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏ç‡πà!! ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏Ñ‡∏•‡πÅ‡∏≠‡∏ö‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏ò‡∏≠‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏°‡∏≤‡∏Å üí™üî•",
      "‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏Å‡∏Å! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ä‡∏¥‡πà‡∏á‡πÅ‡∏ã‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏°‡πà üíÖ‚ú®",
      "‡πÇ‡∏≠‡πä‡∏¢‡∏¢‡∏¢ ‡∏™‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏¢‡∏±‡∏ô‡∏°‡∏≤‡∏Å ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡πâ‡∏∞ üíñ",
      "‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà! ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á üí™üî•",
      "‡∏™‡∏∏‡∏î‡∏à‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡∏à‡∏£‡∏¥‡∏á! ‡πÅ‡∏Ñ‡∏•‡πÉ‡∏´‡πâ‡∏°‡∏á üëë",
      "‡∏≠‡∏±‡∏õ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏°‡∏≤‡∏ô‡∏µ‡πà‡πÉ‡∏à‡∏ñ‡∏∂‡∏á‡∏°‡∏≤‡∏Å ‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ üòåüî•",
      "‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏∞ ‡∏ô‡∏µ‡πà‡πÅ‡∏´‡∏•‡∏∞‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏õ‡∏±‡∏á!",
      "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ò‡∏≠‡∏û‡∏∏‡πà‡∏á‡πÅ‡∏£‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡∏∏‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏µ‡∏Å‡∏≠‡πà‡∏∞ üî•",
      "‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏π‡πâ‡πÜ‡πÜ",
      "‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏õ‡πà‡∏∞! ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡∏∞ leaderboard ‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô üî•"
    ];

    // Initialize LIFF and Supabase
    async function initializeApp() {
      try {
        // Initialize LIFF
        await liff.init({ liffId: LIFF_ID });

        // Check if logged in
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get LINE profile
        const profile = await liff.getProfile();
        currentUser = {
          lineUserId: profile.userId,
          displayName: profile.displayName,
          profileImage: profile.pictureUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profile.displayName) + '&background=C1272D&color=fff&size=200'
        };

        // Initialize Supabase
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Ensure user exists in database
        await ensureUserExists();

        // Hide loading, show upload page
        document.getElementById('loadingPage').classList.remove('active');
        document.getElementById('uploadPage').classList.add('active');

      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('loadingPage').innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 60px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 10px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.6);">${error.message}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 15px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF_ID ‡πÅ‡∏•‡∏∞ Supabase config</div>
          </div>
        `;
      }
    }

    // Ensure user exists in user_points table
    async function ensureUserExists() {
      const { data, error } = await supabaseClient
        .from('user_points')
        .select('*')
        .eq('line_user_id', currentUser.lineUserId)
        .single();

      if (error && error.code === 'PGRST116') {
        // User doesn't exist, create
        await supabaseClient
          .from('user_points')
          .insert({
            line_user_id: currentUser.lineUserId,
            display_name: currentUser.displayName,
            profile_picture_url: currentUser.profileImage,
            total_points: 0
          });
      } else if (!error && data) {
        // Update profile if changed
        if (data.display_name !== currentUser.displayName || data.profile_picture_url !== currentUser.profileImage) {
          await supabaseClient
            .from('user_points')
            .update({
              display_name: currentUser.displayName,
              profile_picture_url: currentUser.profileImage
            })
            .eq('line_user_id', currentUser.lineUserId);
        }
      }
    }

    // Initialize Element SDK
    async function initializeElementSdk() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.body.style.background = config.background_color || defaultConfig.background_color;
            
            const cards = document.querySelectorAll('.glass-card');
            cards.forEach(card => {
              card.style.background = config.card_color || defaultConfig.card_color;
            });

            document.body.style.color = config.text_color || defaultConfig.text_color;

            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
              btn.style.borderColor = config.button_color || defaultConfig.button_color;
            });

            document.getElementById('uploadTitle').textContent = config.upload_title || defaultConfig.upload_title;
            document.getElementById('uploadSubtitle').textContent = config.upload_subtitle || defaultConfig.upload_subtitle;
            document.getElementById('submitBtnText').textContent = config.submit_button_text || defaultConfig.submit_button_text;
            document.getElementById('leaderboardTitle').textContent = config.leaderboard_title || defaultConfig.leaderboard_title;
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ background_color: value });
                  }
                }
              },
              {
                get: () => config.card_color || defaultConfig.card_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ card_color: value });
                  }
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ text_color: value });
                  }
                }
              },
              {
                get: () => config.button_color || defaultConfig.button_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ button_color: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["upload_title", config.upload_title || defaultConfig.upload_title],
            ["upload_subtitle", config.upload_subtitle || defaultConfig.upload_subtitle],
            ["submit_button_text", config.submit_button_text || defaultConfig.submit_button_text],
            ["leaderboard_title", config.leaderboard_title || defaultConfig.leaderboard_title]
          ])
        });
      }
    }

    // File upload handling
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const previewGrid = document.getElementById('previewGrid');
    const submitBtn = document.getElementById('submitBtn');
    const fileInfo = document.getElementById('fileInfo');
    const errorMessage = document.getElementById('errorMessage');

    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      errorMessage.innerHTML = '';
      const maxSize = 30 * 1024 * 1024; // 30MB
      
      Array.from(files).forEach(file => {
        if (file.size > maxSize) {
          errorMessage.innerHTML = `<div class="error-message">‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30MB</div>`;
          return;
        }

        if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
          errorMessage.innerHTML = `<div class="error-message">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>`;
          return;
        }

        selectedFiles.push(file);
      });

      updatePreview();
      updateFileInfo();
      submitBtn.disabled = selectedFiles.length === 0;
    }

    function updatePreview() {
      previewGrid.innerHTML = '';
      
      selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';

        const reader = new FileReader();
        reader.onload = (e) => {
          if (file.type.startsWith('image/')) {
            item.innerHTML = `
              <img src="${e.target.result}" alt="Preview">
              <div class="file-type-badge">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
              <button class="delete-btn" data-index="${index}">√ó</button>
            `;
          } else if (file.type.startsWith('video/')) {
            item.innerHTML = `
              <video src="${e.target.result}"></video>
              <div class="file-type-badge">‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</div>
              <button class="delete-btn" data-index="${index}">√ó</button>
            `;
          }

          const deleteBtn = item.querySelector('.delete-btn');
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeFile(parseInt(e.target.dataset.index));
          });
        };
        reader.readAsDataURL(file);

        previewGrid.appendChild(item);
      });
    }

    function updateFileInfo() {
      const imageCount = selectedFiles.filter(f => f.type.startsWith('image/')).length;
      const videoCount = selectedFiles.filter(f => f.type.startsWith('video/')).length;
      
      const parts = [];
      if (imageCount > 0) parts.push(`${imageCount} ‡∏£‡∏π‡∏õ`);
      if (videoCount > 0) parts.push(`${videoCount} ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠`);
      
      fileInfo.textContent = parts.length > 0 ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${parts.join(', ')}` : '';
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updatePreview();
      updateFileInfo();
      submitBtn.disabled = selectedFiles.length === 0;
    }

    function calculatePoints() {
      const images = selectedFiles.filter(f => f.type.startsWith('image/')).slice(0, 3);
      const videos = selectedFiles.filter(f => f.type.startsWith('video/')).slice(0, 1);
      
      let points = 0;
      if (images.length >= 1 && images.length <= 3) {
        points += 5;
      }
      if (videos.length >= 1) {
        points += 10;
      }
      
      return points;
    }

    submitBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      errorMessage.innerHTML = '';

      try {
        const points = calculatePoints();

        // Upload files to Supabase Storage
        for (const file of selectedFiles) {
          const fileExt = file.name.split('.').pop();
          const fileName = `${currentUser.lineUserId}_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
          const filePath = `${fileName}`;

          const { error: uploadError } = await supabaseClient.storage
            .from('proof')
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: false
            });

          if (uploadError) {
            throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ${file.name}: ${uploadError.message}`);
          }
        }

        // Update user points
        const { data: userData, error: fetchError } = await supabaseClient
          .from('user_points')
          .select('total_points')
          .eq('line_user_id', currentUser.lineUserId)
          .single();

        if (fetchError) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ');
        }

        const newTotalPoints = (userData.total_points || 0) + points;

        const { error: updateError } = await supabaseClient
          .from('user_points')
          .update({ total_points: newTotalPoints })
          .eq('line_user_id', currentUser.lineUserId);

        if (updateError) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ');
        }

        // Show success page
        showSuccessPage(points);

      } catch (error) {
        console.error('Upload error:', error);
        errorMessage.innerHTML = `<div class="error-message">${error.message}</div>`;
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
      }
    });

    function showSuccessPage(points) {
      const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
      
      document.getElementById('successMessage').textContent = randomMessage;
      document.getElementById('pointsEarned').textContent = `+${points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;

      document.getElementById('uploadPage').classList.remove('active');
      document.getElementById('successPage').classList.add('active');

      setTimeout(() => {
        fireGoldenConfetti();
      }, 100);
    }

    function fireGoldenConfetti() {
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.display = 'block';

      const particles = [];
      const particleCount = 150;
      const colors = ['#FFD700', '#FFA500', '#FFED4E', '#FFB800', '#FFAA00', '#FFC107'];

      class ConfettiParticle {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height - canvas.height;
          this.size = Math.random() * 8 + 4;
          this.speedY = Math.random() * 3 + 2;
          this.speedX = Math.random() * 4 - 2;
          this.color = colors[Math.floor(Math.random() * colors.length)];
          this.rotation = Math.random() * 360;
          this.rotationSpeed = Math.random() * 10 - 5;
          this.opacity = 1;
        }

        update() {
          this.y += this.speedY;
          this.x += this.speedX;
          this.rotation += this.rotationSpeed;
          
          if (this.y > canvas.height * 0.8) {
            this.opacity -= 0.02;
          }
          
          return this.opacity > 0 && this.y < canvas.height;
        }

        draw() {
          ctx.save();
          ctx.globalAlpha = this.opacity;
          ctx.translate(this.x, this.y);
          ctx.rotate(this.rotation * Math.PI / 180);
          ctx.fillStyle = this.color;
          ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size * 0.6);
          ctx.restore();
        }
      }

      for (let i = 0; i < particleCount; i++) {
        particles.push(new ConfettiParticle());
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (let i = particles.length - 1; i >= 0; i--) {
          if (particles[i].update()) {
            particles[i].draw();
          } else {
            particles.splice(i, 1);
          }
        }

        if (particles.length > 0) {
          requestAnimationFrame(animate);
        } else {
          canvas.style.display = 'none';
        }
      }

      animate();
    }

    document.getElementById('viewLeaderboardBtn').addEventListener('click', async () => {
      document.getElementById('successPage').classList.remove('active');
      document.getElementById('leaderboardPage').classList.add('active');
      await renderLeaderboard();
    });

    document.getElementById('backToUploadBtn').addEventListener('click', () => {
      document.getElementById('leaderboardPage').classList.remove('active');
      document.getElementById('uploadPage').classList.add('active');
      
      selectedFiles = [];
      previewGrid.innerHTML = '';
      fileInfo.textContent = '';
      errorMessage.innerHTML = '';
      submitBtn.disabled = true;
      submitBtn.classList.remove('loading');
      fileInput.value = '';
    });

    async function renderLeaderboard() {
      // Fetch leaderboard from Supabase
      const { data: leaderboard, error } = await supabaseClient
        .from('user_points')
        .select('*')
        .order('total_points', { ascending: false })
        .limit(10);

      if (error) {
        console.error('Error fetching leaderboard:', error);
        return;
      }

      // Render current user rank
      const { data: allUsers } = await supabaseClient
        .from('user_points')
        .select('line_user_id, total_points')
        .order('total_points', { ascending: false });

      const currentUserRank = allUsers.findIndex(u => u.line_user_id === currentUser.lineUserId) + 1;
      const currentRankCard = document.getElementById('currentRankCard');

      if (currentUserRank > 0) {
        const nextUser = allUsers[currentUserRank - 2];
        const userTotalPoints = allUsers.find(u => u.line_user_id === currentUser.lineUserId)?.total_points || 0;
        const pointsNeeded = nextUser ? nextUser.total_points - userTotalPoints + 1 : 0;

        currentRankCard.innerHTML = `
          <div class="current-rank-card">
            <div style="font-size: 18px; margin-bottom: 10px;">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div style="font-size: 48px; font-weight: 800; color: #C1272D;">
              #${currentUserRank}
            </div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px;">
              ${userTotalPoints} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </div>
            ${currentUserRank > 1 && pointsNeeded > 0 ? `
              <div class="next-rank-info">
                ‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${pointsNeeded} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ! üí™
              </div>
            ` : ''}
          </div>
        `;
      } else {
        currentRankCard.innerHTML = '';
      }

      // Render top 10
      const leaderboardList = document.getElementById('leaderboardList');
      leaderboardList.innerHTML = '';

      leaderboard.forEach((user, index) => {
        const rank = index + 1;
        let rankDisplay = `#${rank}`;
        
        if (rank === 1) rankDisplay = 'üëë';
        else if (rank === 2) rankDisplay = 'ü•á';
        else if (rank === 3) rankDisplay = 'ü•à';

        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        if (user.line_user_id === currentUser.lineUserId) {
          item.classList.add('current-user');
        }

        item.innerHTML = `
          <div class="rank">${rank <= 3 ? `<span class="rank-icon">${rankDisplay}</span>` : rankDisplay}</div>
          <img src="${user.profile_picture_url}" alt="${user.display_name}" class="profile-img" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.display_name)}&background=C1272D&color=fff&size=200';">
          <div class="user-info">
            <div class="user-name">${user.display_name}</div>
            <div class="user-points">${user.total_points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          </div>
          <div class="points-display">${user.total_points}</div>
        `;

        leaderboardList.appendChild(item);
      });
    }

    // Initialize on page load
    initializeApp();
    initializeElementSdk();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a0dfbb8324b26cd',t:'MTc2MzUzNzIyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
