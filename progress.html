<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Food Tracker</title>
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    




<style>
/* ===== Weight Style for Progress Page ===== */
body {
  background-color: #000000 !important;
  color: #FFFFFF !important;
  font-family: 'Inter', sans-serif;
  box-sizing: border-box;
}
.gradient-bg {
  background-color: #000000 !important;
}
.glass-effect {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
}
h1, h2, h3, h4, h5, h6, p, span, label, div, a {
  color: #FFFFFF !important;
}
input, select, textarea {
  background-color: #000000 !important;
  border: 1px solid #C1272D !important;
  color: #FFFFFF !important;
  border-radius: 0.75rem !important;
}
input::placeholder, textarea::placeholder {
  color: rgba(255, 255, 255, 0.6);
}
button, .btn, [type="button"], [type="submit"], a.button {
  background-color: #C1272D !important;
  color: #FFFFFF !important;
  border: none !important;
  border-radius: 0.75rem !important;
  transition: all 0.25s ease;
}
button:hover, .btn:hover, [type="button"]:hover, [type="submit"]:hover, a.button:hover {
  background-color: #a01f24 !important;
}
.bg-white, .bg-gray-50, .bg-gray-100 {
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.15) !important;
  color: #FFFFFF !important;
}
.text-gray-500, .text-gray-600, .text-gray-700, .text-gray-800 {
  color: #FFFFFF !important;
}
.border-gray-100, .border-gray-200 {
  border-color: #C1272D !important;
}
.bg-orange-800, .bg-orange-600, .bg-orange-700, .custom-pink {
  background-color: #C1272D !important;
  color: #FFFFFF !important;
}
.custom-pink-text {
  color: #FFFFFF !important;
}
.custom-pink-border {
  border-color: #C1272D !important;
}
canvas {
  background-color: #000000 !important;
  border: 1px solid #C1272D !important;
  border-radius: 12px !important;
  width: 100% !important;
  height: 280px !important; /* ‚úÖ ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö weight */
}
svg, i {
  color: #FFFFFF !important;
}
.card-shadow, .rounded-xl, .rounded-2xl, .shadow-lg {
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.15) !important;
  backdrop-filter: blur(12px);
}
a { color: #FFFFFF !important; }
a:hover { color: #C1272D !important; }
</style>
    
    <style>
.fade-out {
  opacity: 0;
  transition: opacity 0.25s ease-in-out;
}
</style>


</head>
<body class="custom-cream min-h-screen">
    <!-- Header -->
    <header class="custom-pink text-white p-3 sm:p-4 shadow-lg">
        <div class="max-width-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-white bg-opacity-25 rounded-lg flex items-center justify-center shadow-sm">
        <i class="fi fi-rr-salad text-white" style="font-size:22px;"></i>
      </div>
      <h1 class="text-lg sm:text-xl font-semibold tracking-wide">Tracker</h1>
    </div>
            <div id="userInfo" class="flex items-center space-x-1.5 sm:space-x-2">
                <div class="w-7 h-7 sm:w-8 sm:h-8 bg-white rounded-full flex items-center justify-center overflow-hidden">
                    <img id="userPicture" src="" alt="Profile" class="w-full h-full object-cover rounded-full hidden">
                    <span class="text-xs sm:text-sm custom-pink-text font-bold" id="userInitial">D</span>
                </div>
                <span id="userName" class="text-xs sm:text-sm truncate max-w-20 sm:max-w-none">Demo User</span>
            </div>
        </div>
    </header>

  <!-- Navigation Menu -->
<div class="max-w-6xl mx-auto p-4">
  <div class="glass-effect rounded-xl p-4 flex flex-wrap gap-2">

    <!-- ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
    <a 
      onclick="smoothGo('https://liff.line.me/2007859046-7NZV6xZG')" 
      class="px-4 py-2 rounded-lg text-sm font-medium transition-all 
             flex items-center gap-2 text-white cursor-pointer"
      style="background-color:black !important; border:1px solid #C1272D;">
      <i class="fi fi-rr-calendar-lines-pen text-white"></i>
      <span>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
    </a>

    <!-- Dashboard (‡πÅ‡∏î‡∏á‡πÅ‡∏ó‡πâ) -->
    <a 
      onclick="smoothGo('https://liff.line.me/2007859046-WDvlrevQ')" 
      class="px-4 py-2 rounded-lg text-sm font-medium transition-all 
             flex items-center gap-2 text-white shadow-lg cursor-pointer"
      style="background-color:#C1272D !important; border:1px solid #C1272D;">
      <i class="fi fi-rr-chart-line-up text-white"></i>
      <span>Dashboard</span>
    </a>

  </div>
</div>



    <!-- Today's Summary -->
    <div class="max-w-6xl mx-auto p-3 sm:p-4">
        <div class="bg-white rounded-xl shadow-md p-3 sm:p-6 mb-4 sm:mb-6">
            <h2 class="text-lg sm:text-xl font-bold custom-pink-text mb-3 sm:mb-4">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
            <div class="grid grid-cols-3 gap-2 sm:gap-4">
                <div class="text-center p-2 sm:p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg sm:text-2xl mb-1 sm:mb-2">üçΩÔ∏è</div>
                    <div class="text-xs sm:text-sm text-gray-600 leading-tight">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ</div>
                    <div class="text-sm sm:text-xl font-bold custom-pink-text" id="todayCalories">0</div>
                </div>
                <div class="text-center p-2 sm:p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg sm:text-2xl mb-1 sm:mb-2">üéØ</div>
                    <div class="text-xs sm:text-sm text-gray-600 leading-tight">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ TDEE</div>
                    <div class="text-sm sm:text-xl font-bold text-gray-700" id="tdeeGoal">0</div>
                </div>
                <div class="text-center p-2 sm:p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg sm:text-2xl mb-1 sm:mb-2" id="moodEmoji">üòä</div>
                    <div class="text-xs sm:text-sm text-gray-600 leading-tight">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                    <div class="text-xs sm:text-sm font-semibold" id="statusText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Streak Counter -->
    <div class="max-w-6xl mx-auto p-3 sm:p-4">
        <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-center space-x-2 sm:space-x-3">
                <span class="text-2xl sm:text-4xl">üî•</span>
                <span class="text-lg sm:text-2xl font-bold custom-pink-text streak-glow" id="streakCount">0/0</span>
                <span class="text-sm sm:text-lg text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ</span>
            </div>
            <div id="ecalMessage" class="mt-3 text-center text-base sm:text-lg font-semibold text-gray-700"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-3 sm:p-4 grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
        <!-- Calendar Section -->
        <div class="bg-white rounded-xl shadow-md p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
                <h2 class="text-lg sm:text-xl font-bold custom-pink-text">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                <div class="flex space-x-1 sm:space-x-2">
                    <button onclick="changeMonth(-1)" class="p-1.5 sm:p-2 custom-pink text-white rounded-lg hover:opacity-80 text-sm sm:text-base">
                        ‚Üê
                    </button>
                    <button onclick="changeMonth(1)" class="p-1.5 sm:p-2 custom-pink text-white rounded-lg hover:opacity-80 text-sm sm:text-base">
                        ‚Üí
                    </button>
                </div>
            </div>
            <div id="currentMonth" class="text-center font-semibold mb-3 sm:mb-4 custom-pink-text text-sm sm:text-base"></div>
            <div class="grid grid-cols-7 gap-1 sm:gap-2 mb-2">
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏≠‡∏≤</div>
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏à</div>
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏≠</div>
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏û</div>
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏û‡∏§</div>
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏®</div>
                <div class="text-center text-xs sm:text-sm font-semibold text-gray-600 p-1 sm:p-2">‡∏™</div>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white rounded-xl shadow-md p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-3 sm:mb-4 space-y-2 sm:space-y-0">
                <h2 class="text-lg sm:text-xl font-bold custom-pink-text">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</h2>
                <select id="chartPeriod" onchange="updateChart()" class="border custom-pink-border rounded-lg px-2 sm:px-3 py-1 text-xs sm:text-sm w-full sm:w-auto">
                    <option value="1w">1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                    <option value="1m">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="3m">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="6m">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="9m">9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="1y">1 ‡∏õ‡∏µ</option>
                </select>
            </div>
            <div class="w-full overflow-x-auto">
                <canvas id="calorieChart" class="w-full h-48 sm:h-auto"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App data
        let currentDate = new Date();
        let currentUser = null;
        let foodData = {};
        let chart = null;
        let userTDEE = 2000; // Default value

        // LIFF Integration
        async function initializeLIFF() {
            try {
                if (typeof liff !== 'undefined') {
                    await liff.init({ liffId: "2007859046-WDvlrevQ" });
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    
                    const profile = await liff.getProfile();
                    currentUser = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl
                    };
                    
                    updateUserInfo();
                    await loadUserData();
                } else {
                    console.log('LIFF not available, using demo mode');
                    initializeDemoData();
                }
            } catch (error) {
                console.log('LIFF initialization failed, using demo mode:', error);
                initializeDemoData();
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName;
                document.getElementById('userInitial').textContent = currentUser.displayName.charAt(0);
                
                // Show profile picture if available
                if (currentUser.pictureUrl) {
                    const profileImg = document.getElementById('userPicture');
                    const initialSpan = document.getElementById('userInitial');
                    
                    profileImg.src = currentUser.pictureUrl;
                    profileImg.classList.remove('hidden');
                    initialSpan.classList.add('hidden');
                    
                    // Fallback to initial if image fails to load
                    profileImg.onerror = function() {
                        this.classList.add('hidden');
                        initialSpan.classList.remove('hidden');
                    };
                }
            }
        }

        // Supabase Functions
        async function loadUserData() {
            if (!currentUser) return;

            try {
                console.log('Loading user data for:', currentUser.userId);
                
                // Load all data from daily_calorie_summary table
                const { data: calorieData, error: calorieError } = await supabaseClient
                    .from('daily_calorie_summary')
                    .select('date, total_calories, goal_calories, diff')
                    .eq('line_user_id', currentUser.userId)
                    .order('date', { ascending: false })
                    .limit(365);

                console.log('Calorie data from Supabase:', calorieData);
                console.log('Error (if any):', calorieError);

                if (calorieData && !calorieError) {
                    foodData = {};
                    
                    // Get the most recent goal_calories as default TDEE
                    const latestRecord = calorieData.find(record => record.goal_calories && record.goal_calories > 0);
                    if (latestRecord && latestRecord.goal_calories) {
                        userTDEE = latestRecord.goal_calories;
                        console.log('Updated userTDEE to:', userTDEE);
                    }
                    
                    calorieData.forEach(record => {
                        const dateStr = record.date; // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å DB ‡∏ï‡∏£‡∏á ‡πÜ
                        
                        foodData[dateStr] = {
                            calories: parseInt(record.total_calories) || 0,
                            goalCalories: (Number.isFinite(parseInt(record.goal_calories)) && parseInt(record.goal_calories) > 0)
                                            ? parseInt(record.goal_calories)
                                            : (userTDEE || 2000),
                            diff: parseInt(record.diff) || 0,
                            foods: []
                        };
                        
                        console.log(`Date ${dateStr}: calories=${foodData[dateStr].calories}, goal=${foodData[dateStr].goalCalories}`);
                    });
                    
                    console.log('Final foodData:', foodData);
                } else {
                    console.log('No data found or error occurred, using demo data');
                    initializeDemoData();
                }

                updateTodaySummary();
                calculateStreak();
                renderCalendar();
                updateChart();

            } catch (error) {
                console.error('Error loading user data:', error);
                initializeDemoData();
            }
        }

        async function saveCalorieData(date, calories) {
            if (!currentUser) return;

            try {
                // The trigger will automatically set goal_calories and diff
                const { data, error } = await supabaseClient
                    .from('daily_calorie_summary')
                    .upsert({
                        line_user_id: currentUser.userId,
                        date: date,
                        total_calories: calories
                    }, {
                        onConflict: 'line_user_id,date'
                    });

                if (error) {
                    console.error('Error saving calorie data:', error);
                } else {
                    // Reload data to get updated goal_calories and diff from triggers
                    await loadUserData();
                }
            } catch (error) {
                console.error('Error saving to Supabase:', error);
            }
        }

        // Initialize demo data for testing
        function initializeDemoData() {
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const calories = Math.floor(Math.random() * 1000) + 1500;
                foodData[dateStr] = {
                    calories: calories,
                    goalCalories: userTDEE,
                    foods: [
                        { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î', calories: Math.floor(calories * 0.4) },
                        { name: '‡∏™‡πâ‡∏°‡∏ï‡∏≥', calories: Math.floor(calories * 0.3) },
                        { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ', calories: Math.floor(calories * 0.3) }
                    ]
                };
            }
        }

        // ‚úÖ helper: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ 'YYYY-MM-DD' ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ Asia/Bangkok ‡πÄ‡∏™‡∏°‡∏≠
        function toThaiDateString(dateObj) {
            const thai = new Date(dateObj.toLocaleString("en-US", { timeZone: "Asia/Bangkok" }));
            return thai.toISOString().split("T")[0];
        }

        // ‚úÖ Calendar functions (Final Version)
function renderCalendar() {
  const now = new Date();
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  document.getElementById("currentMonth").textContent =
    `${year} ${new Date(year, month).toLocaleDateString("th-TH", { month: "long" })}`;

  const firstDay = new Date(year, month, 1);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());

  const calendarGrid = document.getElementById("calendarGrid");
  calendarGrid.innerHTML = "";

  const today = new Date();
  const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);

    // ‚úÖ ‡πÉ‡∏ä‡πâ key ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞ Supabase
    const dateStr = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
      .toISOString()
      .slice(0, 10);

    const dayData = foodData[dateStr];
    const isCurrentMonth = date.getMonth() === month;
    const calendarDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const isToday = calendarDate.getTime() === todayDateOnly.getTime();
    const isFutureDate = calendarDate > todayDateOnly;

    let emoji = "";
    let bgColor = "bg-gray-100";

    if (dayData && isCurrentMonth && !isFutureDate) {
      const goalCalories = dayData.goalCalories || userTDEE;
      const percentage = (dayData.calories / goalCalories) * 100;
      if (percentage < 65) {
        emoji = "ü•∫";
        bgColor = "bg-yellow-100";
      } else if (percentage <= 85) {
        emoji = "ü§©";
        bgColor = "bg-green-100";
      } else if (percentage <= 100) {
        emoji = "ü•∞";
        bgColor = "bg-blue-100";
      } else {
        emoji = "üò≠";
        bgColor = "bg-red-100";
      }
    }

    if (isToday) bgColor = "custom-pink text-white";

    const dayElement = document.createElement("div");
    dayElement.className = `calendar-day p-1 sm:p-2 text-center rounded-lg cursor-pointer ${bgColor} ${
      isCurrentMonth ? "" : "opacity-30"
    }`;
    dayElement.innerHTML = `
      <div class="text-xs sm:text-sm font-semibold">${date.getDate()}</div>
      <div class="text-sm sm:text-lg">${emoji}</div>
    `;

    if (isCurrentMonth) {
      dayElement.onclick = () => selectDate(dateStr);
    }

    calendarGrid.appendChild(dayElement);
  }
}


        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function selectDate(dateStr) {
            const data = foodData[dateStr];
            if (data) {
                const goalCalories = data.goalCalories || userTDEE;
                const message = `${dateStr}\n‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.calories}\n‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${goalCalories}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getStatusText(data.calories, goalCalories)}`;
                
                // Create custom modal instead of alert
                showInfoModal(message);
            }
        }

        function showInfoModal(message) {
            // Create a simple info modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 m-4 max-w-sm w-full">
                    <div class="text-center">
                        <pre class="text-sm text-gray-700 whitespace-pre-wrap">${message}</pre>
                        <button onclick="this.closest('.fixed').remove()" class="mt-4 custom-pink text-white px-4 py-2 rounded-lg hover:opacity-80">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getStatusText(calories, goalCalories) {
            const percentage = (calories / goalCalories) * 100;
            if (percentage < 65) return '‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
            if (percentage <= 85) return '‡∏î‡∏µ‡∏°‡∏≤‡∏Å!';
            if (percentage <= 100) return '‡∏î‡∏µ';
            return '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
        }

        // Chart functions
function initializeChart() {
  const ctx = document.getElementById('calorieChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ',
          data: [],
          borderColor: '#C1272D',
          backgroundColor: 'rgba(193, 39, 45, 0.15)',
          pointBackgroundColor: '#FFFFFF',
          pointBorderColor: '#C1272D',
          pointRadius: 3,              // üîπ ‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
          pointHoverRadius: 5,
          borderWidth: 2,
          tension: 0.35,
          fill: true
        },
        {
          label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ TDEE',
          data: [],
          borderColor: 'rgba(255,255,255,0.4)',
          borderDash: [5, 5],
          borderWidth: 1,
          pointRadius: 0,
          tension: 0
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: true,
          labels: {
            color: '#FFFFFF',
            font: { size: 9.5, family: 'Inter', weight: 400 }, // üîπ ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
            boxWidth: 8,
            boxHeight: 8,
            padding: 10,
            usePointStyle: true
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleFont: { size: 9, family: 'Inter' },
          bodyFont: { size: 9, family: 'Inter' },
          titleColor: '#FFFFFF',
          bodyColor: '#FFFFFF',
          borderColor: '#C1272D',
          borderWidth: 1,
          cornerRadius: 6
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(255,255,255,0.1)' },
          ticks: {
            color: 'rgba(255,255,255,0.65)',
            font: { size: 9, family: 'Inter' }, // üîπ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
            padding: 6
          }
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.08)' },
          ticks: {
            color: 'rgba(255,255,255,0.7)',
            font: { size: 9, family: 'Inter' }, // üîπ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á
            callback: (v) => v.toFixed(0),
            padding: 4
          }
        }
      },
      layout: {
        padding: { top: 8, bottom: 8, left: 8, right: 8 }
      },
      animation: { duration: 700, easing: 'easeOutCubic' }
    }
  });

  updateChart();
}


        function updateChart() {
            // Check if chart exists before trying to update
            if (!chart) {
                console.log('Chart not initialized yet, skipping update');
                return;
            }
            
            const period = document.getElementById('chartPeriod').value;
            const days = {
                '1w': 7, '1m': 30, '3m': 90, 
                '6m': 180, '9m': 270, '1y': 365
            }[period];
            
            const labels = [];
            const calorieData = [];
            const tdeeData = [];
            
            // Use Thai timezone for chart
            const now = new Date();
            const today = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = toThaiDateString(date); // ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
                
                labels.push(date.toLocaleDateString('th-TH', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                
                const dayData = foodData[dateStr];
                calorieData.push(dayData ? dayData.calories : 0);
                tdeeData.push(dayData ? (dayData.goalCalories || userTDEE) : userTDEE);
            }
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = calorieData;
            chart.data.datasets[1].data = tdeeData;
            chart.update('none');
        }

        // Food management
        function showAddFoodModal() {
            document.getElementById('addFoodModal').classList.remove('hidden');
            document.getElementById('addFoodModal').classList.add('flex');
        }

        function hideAddFoodModal() {
            document.getElementById('addFoodModal').classList.add('hidden');
            document.getElementById('addFoodModal').classList.remove('flex');
            document.getElementById('foodName').value = '';
            document.getElementById('calories').value = '';
        }

        async function addFood(event) {
            event.preventDefault();
            
            const foodName = document.getElementById('foodName').value;
            const calories = parseInt(document.getElementById('calories').value);
            const now = new Date();
            const thaiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
            const today = thaiTime.toISOString().split('T')[0];
            
            if (!foodData[today]) {
                foodData[today] = { 
                    calories: 0, 
                    goalCalories: userTDEE,
                    foods: [] 
                };
            }
            
            foodData[today].foods.push({ name: foodName, calories: calories });
            foodData[today].calories += calories;
            
            // Save to Supabase
            await saveCalorieData(today, foodData[today].calories);
            
            updateTodaySummary();
            renderCalendar();
            updateChart();
            hideAddFoodModal();
        }

        function updateTodaySummary() {
            // Get today's date in Thai timezone (UTC+7)
            const now = new Date();
            const thaiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
            const today = thaiTime.toISOString().split('T')[0];
            const todayData = foodData[today] || { calories: 0, goalCalories: userTDEE };
            
            document.getElementById('todayCalories').textContent = todayData.calories.toLocaleString();
            document.getElementById('tdeeGoal').textContent = (todayData.goalCalories || userTDEE).toLocaleString();
            
            const goalCalories = todayData.goalCalories || userTDEE;
            const percentage = (todayData.calories / goalCalories) * 100;
            let emoji, status;
            
            if (percentage < 65) {
                emoji = 'üò∞';
                status = '‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
            } else if (percentage <= 85) {
                emoji = 'üéâ';
                status = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å!';
            } else if (percentage <= 100) {
                emoji = 'üòä';
                status = '‡∏î‡∏µ';
            } else {
                emoji = 'üò¢';
                status = '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
            }
            
            document.getElementById('moodEmoji').textContent = emoji;
            document.getElementById('statusText').textContent = status;
        }

        function calculateStreak() {
  let successDays = 0;
  const now = new Date();
  const thaiNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Bangkok" }));
  const year = thaiNow.getFullYear();
  const month = thaiNow.getMonth();
  const monthStart = new Date(year, month, 1);
  const monthEnd = new Date(year, month + 1, 0);
  const totalDaysInMonth = monthEnd.getDate();

  // üî• ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
  for (let day = 1; day <= totalDaysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
      .toISOString()
      .split("T")[0];
    const dayData = foodData[dateStr];
    if (dayData) {
      const goalCalories = dayData.goalCalories || userTDEE;
      const percentage = (dayData.calories / goalCalories) * 100;
      if (percentage >= 65 && percentage <= 100) {
        successDays++;
      }
    }
  }

  // ‡πÅ‡∏™‡∏î‡∏á progress üî•
  document.getElementById("streakCount").textContent = `${successDays}/${totalDaysInMonth}`;

  // üí¨ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏™‡∏∏‡∏î‡∏Å‡∏ß‡∏ô (‡∏™‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
  const ratio = (successDays / totalDaysInMonth) * 100;
  let messageSet = [];

  if (ratio >= 80) {
    // ‡∏ó‡∏≥‡∏î‡∏µ‡∏°‡∏≤‡∏Å
    messageSet = [
      "üíñ ‡πÇ‡∏≠‡πâ‡πÇ‡∏´! ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏à‡∏∞‡∏Å‡∏£‡∏≤‡∏ö‡∏•‡∏∞ ‡πÄ‡∏Å‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!",
      "üî• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏≠‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏¢‡∏¢!",
      "üéâ ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏à‡∏∞‡πÑ‡∏´‡∏• ‡∏î‡∏µ‡πÉ‡∏à‡πÅ‡∏ó‡∏ö‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î!",
      "üòé ‡∏ô‡∏µ‡πà‡∏°‡∏±‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ó‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡πà‡∏∞‡πÄ‡∏ô‡∏µ‡πà‡∏¢!",
      "üëè ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢~"
    ];
  } else if (ratio >= 50) {
    // ‡∏Å‡∏•‡∏≤‡∏á‡πÜ
    messageSet = [
      "üòâ ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡πÅ‡∏ï‡πà‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏∑‡πâ‡∏°‡∏û‡∏≠‡∏ô‡∏∞!",
      "üòè ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞‚Ä¶ ‡∏≠‡∏¢‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏ú‡πà‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ!",
      "üßê ‡πÄ‡∏≠‡πä‡∏∞ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏±‡∏á? ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà!",
      "üí™ ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞ ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!",
      "ü§ì ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏à‡∏∞‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡∏≤‡∏ô‡∏° (‡πÉ‡∏ô‡πÉ‡∏à)"
    ];
  } else if (ratio > 0) {
    // ‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢
    messageSet = [
      "üòÖ ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏£‡∏á‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞!",
      "üò§ ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á~",
      "üôÑ ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ‚Ä¶ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ñ‡∏≠‡∏∞!",
      "üò≠ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏π‡∏Å! ‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!",
      "üò¨ ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏ò‡∏≠‡∏ô‡∏∞ ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢!"
    ];
  } else {
    // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢
    messageSet = [
      "üò° ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏°‡∏≤!! ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏ô‡πÑ‡∏õ‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ö!",
      "üò≠ ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡∏£‡∏≠‡∏≠‡∏≠~ TT",
      "ü•≤ ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÄ‡∏´‡∏á‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏°‡∏ß‡∏´‡∏¥‡∏ß‡∏ô‡∏°",
      "üò© ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏ñ‡∏≠‡∏∞ ‡∏Ç‡∏≠‡∏£‡πâ‡∏≠‡∏á ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß!",
      "üíî ‡∏≠‡∏µ‡πÅ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÉ‡∏à‡πÄ‡∏ò‡∏≠‡∏™‡∏±‡∏Å‡∏ô‡∏¥‡∏î‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏î‡∏µ..."
    ];
  }

  // üåÄ ‡∏™‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  const message = messageSet[Math.floor(Math.random() * messageSet.length)];
  const msgEl = document.getElementById("ecalMessage");
  msgEl.textContent = message;
}

        // Initialize app
        async function initializeApp() {
            // Initialize chart first before loading data
            initializeChart();
            await initializeLIFF();
            renderCalendar();
            updateTodaySummary();
            calculateStreak();
        }

        // Start the app
        initializeApp();
    </script>

    <script>
function smoothGo(url) {
  document.body.classList.add("fade-out");
  setTimeout(() => {
    location.href = url;
  }, 250);
}
</script>

    
  <a href="https://liff.line.me/2007859046-BpXDWpXe"
   class="fixed bottom-6 right-6 
          bg-[#C1272D] text-white 
          w-14 h-14 flex items-center justify-center 
          rounded-full shadow-md 
          hover:bg-[#a01f24] 
          text-3xl z-50 transition-all duration-300">
  <i class="fi fi-rr-home text-white text-3xl"></i>
</a>
  

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ffdbe7328cd026',t:'MTc2MDcwNDc2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>










