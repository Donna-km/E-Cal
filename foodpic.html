<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Calorie Tracker</title>
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-thin-rounded/css/uicons-thin-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* üåà ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏•‡∏±‡∏Å */
    body {
      background: #000000 !important;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #FFFFFF !important;
      min-height: 100vh;
      margin: 0;
      padding: 16px;
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô input file ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á */
    .file-input {
      display: none;
    }

    /* üå∏ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å */
    .container {
      max-width: 420px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 24px;
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px rgba(255, 57, 116, 0.2);
    }

    /* üî≤ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î no-frame */
    .container.no-frame {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    /* üíñ ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß */
    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    .header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: #fff;
    }
    .header i {
      font-size: 64px;
      color: #FFECD0;
      margin-top: 10px;
    }

    /* üîò ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö */
    .btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.25s ease;
      margin-bottom: 12px;
    }

    button, .btn, [type="button"], [type="submit"],
    .btn-primary, .btn-secondary, .btn-success, .btn-danger {
      background-color: #C1272D !important;
      color: #FFFFFF !important;
      border: none !important;
    }

    button:hover, .btn:hover {
      background-color: #a01f24 !important;
    }

    .btn-primary {
      background-color: #FFECD0 !important;
      color: #FF3974 !important;
    }
    .btn-primary:hover {
      background-color: #FFE4B8 !important;
      box-shadow: 0 6px 16px rgba(255, 236, 208, 0.4);
    }

    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.15) !important;
      color: #FFFFFF !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }
    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.25) !important;
    }

    .btn-success {
      background-color: #FF3974 !important;
      color: white !important;
    }
    .btn-success:hover {
      background-color: #e3366f !important;
    }

    .btn-danger {
      background: rgba(255, 255, 255, 0.1) !important;
      color: white !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }
    .btn-danger:hover {
      background: rgba(255, 255, 255, 0.25) !important;
    }

    /* üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á */
    .preview-container {
      text-align: center;
      margin: 20px 0;
    }
    .preview-image {
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin-bottom: 16px;
    }

    /* üì∏ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ */
    .food-image-container {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .result-food-image {
      width: 100%;
      object-fit: cover;
    }

    /* üî¥ Bubble ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    .calorie-bubble {
      position: absolute;
      top: 16px;
      left: 16px;
      background: #C1272D !important;
      color: #FFFFFF !important;
      padding: 6px 14px;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .macro-bubbles {
      position: absolute;
      right: 16px;
      top: 80px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .macro-bubble {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: #C1272D !important;
      color: #FFFFFF !important;
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      justify-content: center !important;
      text-align: center !important;
      line-height: 1.2 !important;
      font-weight: 600 !important;
      font-size: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .macro-bubble span,
    .macro-bubble div {
      display: block !important;
      text-align: center !important;
    }

    /* üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ */
    .fun-message {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.10);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      text-align: center;
      width: 90%;
      font-size: 14px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    }
    .fun-message strong {
      color: #FFECD0;
      display: block;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    /* üîÑ Loading */
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.25);
      border-top: 3px solid #FF3974;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* üîî Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #000000 !important;
      color: #FFFFFF !important;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      border: 1px solid #C1272D !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    .toast.show {
      opacity: 1;
    }

    .toast-error {
      background-color: #e9e2d0 !important;
      color: #cc1e0f !important;
      border: 1px solid #cc1e0f !important;
    }

    .toast-success {
      background-color: #ffffff !important;
      color: #cc1e0f !important;
      border: 1px solid #cc1e0f !important;
    }

    /* ü™ü Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      background: #000000 !important;
      color: #FFFFFF !important;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      border: 1px solid #C1272D !important;
      width: 92%;
      max-width: 420px;
    }
    .modal-header {
      padding: 14px 18px;
      background: #C1272D;
      color: #FFFFFF;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-body {
      padding: 16px 18px;
    }
    .modal-footer {
      padding: 14px 18px;
      background: #111827;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal label {
      color: #FFECD0;
      font-weight: 600;
      font-size: 14px;
    }
    .modal .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #C1272D;
      margin: 6px 0 12px;
      background-color: #000000;
      color: #FFFFFF;
    }
    .modal .note {
      font-size: 12px;
      color: #9CA3AF;
      margin-top: -8px;
      margin-bottom: 8px;
    }
    .modal-close {
      background: transparent;
      border: 0;
      font-size: 20px;
      color: #FFFFFF;
      cursor: pointer;
    }
    .btn-outline {
      background:#000000 !important;
      color:#FFECD0 !important;
      border:1px solid #C1272D !important;
    }
    .btn-primary-red {
      background:#C1272D !important;
      color:#fff !important;
      border:1px solid #C1272D !important;
    }

    /* ===== Center buttons on result page ===== */
    #resultPage .button-group {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      flex-wrap: nowrap;
      gap: 10px;
      margin-top: 16px;
    }
    #resultPage .button-group .btn {
      width: auto !important;
      flex: 1 1 auto;
      min-width: 100px;
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å) -->
    <div id="cameraPage">
      <div class="header">
        <h1 style="text-align:center; color:#FFFFFF;">
          Smart Scan
          <br>
          <i class="fi fi-tr-camera-viewfinder"
             style="font-size:64px; color:#FFFFFF; margin-top:18px; display:block;"></i>
        </h1>
      </div>

      <input type="file" id="cameraInput" class="file-input"
             accept="image/*" capture="environment" onchange="previewImage(event)">
      <input type="file" id="galleryInput" class="file-input"
             accept="image/*" onchange="previewImage(event)">

      <button class="btn btn-primary" onclick="openCamera()">
        Take Photo
      </button>
      <button class="btn btn-secondary" onclick="openGallery()">
        Choose Image
      </button>

      <div id="previewContainer" class="preview-container hidden">
        <img id="previewImage" class="preview-image" alt="Preview">
        <button class="btn btn-success" onclick="submitPhoto()">
          ‚ú® Analyze Food
        </button>
        <button class="btn btn-secondary" onclick="goHome()">
          ‚Üê Cancel
        </button>
      </div>
    </div>

    <!-- ===== Loading Page (Scan Animation) ===== -->
    <div id="loadingPage" class="hidden flex flex-col items-center justify-center min-h-screen bg-transparent text-center">
      <div id="scanAreaFood"
           class="relative mx-auto mb-6 overflow-hidden rounded-2xl shadow-xl border border-[#FF3974]/30"
           style="max-width:320px; aspect-ratio:1/1;">
        <!-- üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <img id="scanImageFood"
             src="https://via.placeholder.com/320x320?text=Analyzing+Food..."
             alt="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£..."
             class="w-full h-full object-cover rounded-2xl opacity-95 transition-all duration-500 ease-in-out">
        <!-- üî¥ ‡πÄ‡∏™‡πâ‡∏ô‡∏™‡πÅ‡∏Å‡∏ô -->
        <div class="scan-line"></div>
      </div>
      <p class="text-[#FF3974] font-semibold animate-pulse mt-2">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...
      </p>

      <style>
        .scan-line {
          position: absolute;
          top: -10%;
          left: 0;
          width: 100%;
          height: 6px;
          background: linear-gradient(
              to bottom,
              rgba(255, 255, 255, 0) 0%,
              rgba(255, 57, 116, 0.9) 50%,
              rgba(255, 255, 255, 0) 100%
          );
          animation: scanMove 1.8s linear infinite;
          border-radius: 6px;
          box-shadow: 0 0 16px rgba(255, 57, 116, 0.8);
        }
        @keyframes scanMove {
          0% { top: -10%; }
          50% { top: 100%; }
          100% { top: -10%; }
        }
      </style>
    </div>

    <!-- ===== ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ===== -->
    <div id="resultPage" class="hidden">
      <div class="food-image-container" style="position: relative; margin: 0; border-radius: 0; overflow: hidden;">
        <img id="resultFoodImage" class="result-food-image" alt="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"
             style="width: 100%; height: 100vh; object-fit: cover; display: block;">
        <div id="resultContent"></div>
      </div>

      <div class="question-section" style="text-align: center; margin: 20px 0; padding: 0 20px;">
        <p class="question-text"
           style="font-size: 11px; color: #d7d3ca; font-style: italic; margin-bottom: 14px;">
          *‡∏ú‡∏•‡∏ô‡∏µ‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì 300 g*
        </p>
        <div class="button-group">
          <button class="btn btn-secondary" onclick="openEditModal()">‚úèÔ∏è Edit</button>
          <button class="btn btn-success" onclick="saveToDatabase()">‚úÖ Save</button>
          <button class="btn btn-danger" onclick="goHome()">‚ùå Skip</button>
        </div>
      </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
    <div id="successPage" class="hidden">
      <div class="header">
        <h1>
          <i class="fi fi-tr-camera-viewfinder" style="margin-right:8px;color:#cc1e0f;"></i>
          Saved Successfully
        </h1>
        <p style="color: #cc1e0f; font-size: 14px; margin-top: 8px;">
          Your food data has been recorded
        </p>
      </div>
      <button class="btn btn-primary" onclick="goHome()">
        üè† Back to Home
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- ====== Edit Popup ====== -->
  <div id="editModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
        <button class="modal-close" onclick="closeEditModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <label>üçΩÔ∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
        <input id="editDish" class="input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß">
        <label>‚öñÔ∏è ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏Å‡∏£‡∏±‡∏°)</label>
        <input id="editAmount" class="input" type="number" placeholder="300">
        <div class="note">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà 300 g</div>
        <label>üßÇ ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="editNote" class="input" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏û‡∏£‡∏¥‡∏Å, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary-red" onclick="reAnalyze()">üîÅ Re-Analyze</button>
      </div>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Home -->
  <a id="homeButton"
     href="https://liff.line.me/2007859046-BpXDWpXe"
     class="fixed bottom-6 right-6 bg-[#FF3974] text-white
            w-14 h-14 flex items-center justify-center
            rounded-full shadow-md hover:bg-pink-600 text-3xl
            z-[99999] transition">
    <i class="fi fi-rr-home text-white"></i>
  </a>

  <script>
    // ========= Global State =========
    let currentUser = null;
    let analysisResult = null;
    let selectedImage = null;
    window.selectedImage = null; // ‡πÉ‡∏´‡πâ script ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ

    // ‡πÇ‡∏´‡∏•‡∏î LINE ID ‡∏à‡∏≤‡∏Å storage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    const savedLineId =
      localStorage.getItem('line_user_id') ||
      sessionStorage.getItem('line_user_id');
    if (savedLineId) {
      currentUser = { userId: savedLineId };
      console.log('üîÅ Loaded stored LINE ID:', savedLineId);
    }

    // ========= LIFF Initialize =========
    async function initializeLIFF() {
      const liffId = "2007859046-doqQg8qv"; // ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á

      if (liffId === "YOUR_LIFF_ID") {
        // demo mode
        console.log("Running in demo mode - no LIFF ID configured");
        currentUser = {
          userId: "demo_user_" + Date.now(),
          displayName: "Demo User"
        };
        showToast("Running in demo mode", "success");
        return;
      }

      try {
        await liff.init({ liffId });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentUser = {
          userId: profile.userId,
          displayName: profile.displayName
        };

        if (profile?.userId) {
          localStorage.setItem('line_user_id', profile.userId);
          sessionStorage.setItem('line_user_id', profile.userId);
        }

        console.log("LINE user logged in:", currentUser);
        showToast("LINE login successful!", "success");
      } catch (error) {
        console.error("LIFF initialization failed:", error);
        // Fallback demo mode
        currentUser = {
          userId: "demo_user_" + Date.now(),
          displayName: "Demo User"
        };
        showToast("Using demo mode", "success");
      }
    }

    // ========= Supabase Initialize =========
    const supabaseUrl = 'https://lvtdqeerzxpznnayccmb.supabase.co';
    const supabaseKey =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
    let supabase = null;

    try {
      supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    } catch (error) {
      console.log("Supabase not configured - demo mode");
    }

    // ========= Page Navigation =========
    function toggleHomeButton(pageId) {
      const homeBtn = document.getElementById('homeButton');
      if (!homeBtn) return;
      if (pageId === 'cameraPage') homeBtn.classList.remove('hidden');
      else homeBtn.classList.add('hidden');
    }

    function showPage(pageId) {
      const pages = ['cameraPage', 'loadingPage', 'resultPage', 'successPage'];
      pages.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === pageId) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });
      toggleHomeButton(pageId);
    }

    function goHome() {
      showPage('cameraPage');
      analysisResult = null;
      selectedImage = null;
      window.selectedImage = null;
      document.getElementById('cameraInput').value = '';
      document.getElementById('galleryInput').value = '';
      document.getElementById('previewContainer').classList.add('hidden');
      document.querySelector('.container').classList.remove('no-frame');
    }

    // ========= Camera & Gallery =========
    function openCamera() {
      showToast('Opening camera...', 'success');
      setTimeout(() => {
        const cameraInput = document.getElementById('cameraInput');
        cameraInput.value = '';
        const event = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        cameraInput.dispatchEvent(event);
      }, 100);
    }

    function openGallery() {
      showToast('Opening gallery...', 'success');
      setTimeout(() => {
        const galleryInput = document.getElementById('galleryInput');
        galleryInput.value = '';
        const event = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        galleryInput.dispatchEvent(event);
      }, 100);
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (!file) {
        showToast('No image selected', 'error');
        return;
      }

      selectedImage = file;
      window.selectedImage = file; // ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ

      showToast('Image selected successfully!', 'success');

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.getElementById('previewImage');
        img.src = e.target.result;
        document.getElementById('previewContainer').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }

    // ========= Stable showFoodLoading =========
    async function showFoodLoading() {
      const cam = document.getElementById("cameraPage");
      const lb = document.getElementById("loadingPage");
      const img = document.getElementById("scanImageFood");

      if (cam) cam.classList.add("hidden");
      if (lb) lb.classList.remove("hidden");

      const file = selectedImage || window.selectedImage || null;
      let src = "https://via.placeholder.com/320x320?text=Analyzing+Food...";

      if (file instanceof File) {
        src = URL.createObjectURL(file);
      }

      const loadImage = () => {
        return new Promise((resolve) => {
          if (!img) return resolve(false);
          img.onload = () => resolve(true);
          img.onerror = () => resolve(false);
          img.src = src;
        });
      };

      let loaded = false;
      for (let attempt = 1; attempt <= 3; attempt++) {
        console.log(`üîÅ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ scan ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${attempt}`);
        const ok = await loadImage();
        await new Promise(r => setTimeout(r, 300));
        if (ok && img && img.naturalHeight > 0) {
          loaded = true;
          console.log("‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          break;
        }
      }

      if (!loaded && img) {
        console.warn("üö´ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ placeholder ‡πÅ‡∏ó‡∏ô");
        img.src = "https://via.placeholder.com/320x320?text=Analyzing+Food...";
      }

      if (file instanceof File) {
        setTimeout(() => {
          try { URL.revokeObjectURL(src); } catch (e) {}
        }, 5000);
      }
    }

    // ========= Submit Photo =========
    async function submitPhoto() {
      if (!selectedImage) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      showPage('loadingPage');
      await showFoodLoading();

      try {
        const formData = new FormData();
        formData.append('image', selectedImage);

        if (currentUser && currentUser.userId) {
          formData.append('line_user_id', currentUser.userId);
        }
        formData.append('dish', '');
        formData.append('amount', '');
        formData.append('note', '');

        const response = await fetch(
          'https://primary-production-49d9.up.railway.app/webhook/ecal-image',
          { method: 'POST', body: formData }
        );

        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        console.log('Webhook response:', data);

        if (Array.isArray(data) && data.length > 0) {
          analysisResult = data[0];
        } else if (data.output) {
          analysisResult = data;
        } else {
          analysisResult = {
            output: data,
            date: new Date().toISOString().split('T')[0]
          };
        }

        if (!analysisResult.date) {
          analysisResult.date = new Date().toISOString().split('T')[0];
        }

        displayResult(analysisResult);
        showPage('resultPage');
      } catch (error) {
        console.error('Error analyzing image:', error);
        // Data ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á fallback
        analysisResult = {
          output: {
            dish: "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏ó‡∏™‡∏ï‡πå‡πÑ‡∏Ç‡πà‡∏•‡∏≤‡∏ß‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï‡∏ñ‡∏±‡πà‡∏ß‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ",
            calories: 480,
            protein: 22,
            fat: 20,
            carbs: 50,
            tip_th: "‡∏≠‡∏¢‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏¥‡∏ß‡∏°‡∏≤‡∏Å ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏•‡∏≤‡∏ß‡∏≤‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÄ‡∏•‡∏≠‡∏∞‡πÄ‡∏ó‡∏≠‡∏∞! üòÜüî•üç≥ü•ëüçì",
            healthy_score: 6,
            healthy_reason: "‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏Å‡∏¥‡∏ô‡∏û‡∏≠‡∏î‡∏µ ‡πÜ"
          },
          date: new Date().toISOString().split('T')[0]
        };
        displayResult(analysisResult);
        showPage('resultPage');
        showToast('‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'info');
      }
    }

    // ========= Display Result (‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö) =========
    function displayResult(result) {
      const output = (result && result.output) ? result.output : result;
      const resultImage = document.getElementById('resultFoodImage');
      const previewImage = document.getElementById('previewImage');

      if (resultImage && previewImage && previewImage.src) {
        resultImage.src = previewImage.src;
      }

      const container = document.querySelector('.container');
      if (container) container.classList.add('no-frame');

      const resultContent = document.getElementById('resultContent');
      if (resultContent) {
        const cal = output.calories ?? 0;
        const pro = output.protein ?? 0;
        const fat = output.fat ?? 0;
        const carb = output.carbs ?? 0;

        resultContent.innerHTML = `
          <div class="calorie-bubble">${cal} Cal</div>
          <div class="macro-bubbles">
            <div class="macro-bubble">${pro} g<br>Protein</div>
            <div class="macro-bubble">${fat} g<br>Fat</div>
            <div class="macro-bubble">${carb} g<br>Carbs</div>
          </div>
          <div class="fun-message">
            <strong>${output.dish || ''}</strong><br>
            ${output.tip_th || ''}

            ${output.healthy_score ? `
              <div class="mt-3 text-left w-full">
                <div class="text-xs text-[#FFECD0]/90 mb-1">
                  Healthy Score: ${output.healthy_score}/10
                  ${output.healthy_reason ? ` - ${output.healthy_reason}` : ""}
                </div>
                <div class="w-full h-2 rounded-full bg-white/20 overflow-hidden">
                  <div style="width:${output.healthy_score * 10}%; background:#FFECD0; height:100%;"
                       class="transition-all duration-500"></div>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
      const resultPage = document.getElementById('resultPage');
      if (resultPage) {
        let qs = resultPage.querySelector('.question-section');
        if (!qs) {
          qs = document.createElement('div');
          qs.className = 'question-section';
          resultPage.appendChild(qs);
        }
        qs.innerHTML = `
          <p class="question-text"
             style="font-size: 11px; color: #d7d3ca; font-style: italic; margin: 14px 0;">
            *‡∏ú‡∏•‡∏ô‡∏µ‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì 300 g*
          </p>
          <div class="button-group">
            <button class="btn btn-secondary" onclick="openEditModal()">‚úèÔ∏è Edit</button>
            <button class="btn btn-success" onclick="saveToDatabase()">‚úÖ Save</button>
            <button class="btn btn-danger" onclick="goHome()">‚ùå Skip</button>
          </div>
        `;
      }

      // Prefill modal
      const d = document.getElementById('editDish');
      const a = document.getElementById('editAmount');
      const n = document.getElementById('editNote');
      if (d) d.value = output?.dish || '';
      if (a) a.value = 300;
      if (n) n.value = '';
    }

    // ========= Edit Modal =========
    function openEditModal() {
      const m = document.getElementById('editModal');
      if (m) m.classList.add('show');
    }

    function closeEditModal() {
      const m = document.getElementById('editModal');
      if (m) m.classList.remove('show');
    }

    // ========= Re-Analyze =========
    async function reAnalyze() {
      try {
        const name = (document.getElementById('editDish')?.value || '').trim();
        const amount = parseInt(document.getElementById('editAmount')?.value) || 300;
        const note = (document.getElementById('editNote')?.value || '').trim();

        closeEditModal();
        showPage('loadingPage');
        await showFoodLoading();

        const formData = new FormData();
        formData.append('dish', name);
        formData.append('amount', amount);
        formData.append('note', note);

        const lineId =
          currentUser?.userId ||
          localStorage.getItem('line_user_id') ||
          sessionStorage.getItem('line_user_id');
        if (lineId) formData.append('line_user_id', lineId);

        if (selectedImage instanceof File) {
          formData.append('image', selectedImage);
        } else {
          const src =
            document.getElementById('resultFoodImage')?.src ||
            document.getElementById('previewImage')?.src;
          if (src) {
            try {
              const blob = await fetch(src).then(r => r.blob());
              formData.append('image', blob, 'food.jpg');
            } catch (e) {
              console.warn('‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', e);
            }
          }
        }

        const res = await fetch(
          'https://primary-production-49d9.up.railway.app/webhook/ecal-image',
          { method: 'POST', body: formData }
        );

        const data = await res.json().catch(() => ({}));
        console.log('üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ webhook (reAnalyze):', [...formData.entries()]);

        analysisResult = Array.isArray(data)
          ? data[0]
          : data?.output
          ? data
          : { output: data };

        if (!analysisResult.date) {
          analysisResult.date = new Date().toISOString().split('T')[0];
        }

        displayResult(analysisResult);
        showPage('resultPage');
      } catch (err) {
        console.error('‚ùå reAnalyze error:', err);
        showToast('Re-Analyze failed', 'error');
        showPage('resultPage');
      }
    }

    // ========= Save to Database =========
    async function saveToDatabase() {
      if (!analysisResult || !currentUser) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        return;
      }

      try {
        const editedDish = document.getElementById('editDish')?.value?.trim();
        const editedAmount = parseInt(document.getElementById('editAmount')?.value) || null;
        const editedNote = document.getElementById('editNote')?.value?.trim();

        if (analysisResult?.output) {
          const out = analysisResult.output;

          if (editedDish) out.dish = editedDish;

          if (editedAmount && out.calories != null) {
            const baseCal = parseFloat(String(out.calories).replace(/[^0-9.]/g, '')) || 0;
            const basePro = parseFloat(String(out.protein).replace(/[^0-9.]/g, '')) || 0;
            const baseFat = parseFloat(String(out.fat).replace(/[^0-9.]/g, '')) || 0;
            const baseCarb = parseFloat(String(out.carbs).replace(/[^0-9.]/g, '')) || 0;

            const ratio = editedAmount / 300;
            out.calories = Math.round(baseCal * ratio);
            out.protein = Math.round(basePro * ratio);
            out.fat = Math.round(baseFat * ratio);
            out.carbs = Math.round(baseCarb * ratio);
          }
          if (editedNote) out.note = editedNote;
        }

        const out = analysisResult.output;
        const foodLog = {
          line_userid: currentUser.userId,
          date: analysisResult.date,
          food_name: out.dish,
          calories: out.calories,
          protein_g: out.protein,
          fat_g: out.fat,
          carbs_g: out.carbs,
          created_at: new Date().toISOString()
        };

        if (supabase) {
          const { error } = await supabase
            .from('food_logs')
            .insert([foodLog]);
          if (error) throw error;
        }

        console.log('Food log saved:', foodLog);
        showPage('successPage');
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
      } catch (error) {
        console.error('Error saving to database:', error);
        showPage('successPage');
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Demo Mode)', 'success');
      }
    }

    // ========= Toast =========
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.className = `toast ${
        type === 'error' ? 'toast-error' : 'toast-success'
      } show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ========= Init on Load =========
    window.addEventListener('load', () => {
      initializeLIFF();
      showPage('cameraPage');
    });
  </script>
</body>
</html>
