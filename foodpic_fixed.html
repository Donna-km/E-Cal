<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>E‚ÄëCal ‚Äì Food & Body Vision</title>
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-thin-rounded/css/uicons-thin-rounded.css">
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
<style>
  /* Reset + Base */
  * { box-sizing: border-box; margin:0; padding:0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Prompt', sans-serif;
         background: linear-gradient(180deg,#fafafa 0%, #f2f2f2 100%);
         color:#2c3e50; min-height:100vh; padding:16px; }
  .hidden{display:none}

  /* Container card */
  .container { max-width: 420px; margin: 0 auto; background:#fff; border-radius:20px;
               padding:24px; box-shadow:0 8px 24px rgba(0,0,0,.08); }

  .header { text-align:center; margin-bottom:18px; }
  .header h1 { color:#cc1e0f; font-size:22px; font-weight:700; }
  .header i { font-size:64px; color:#cc1e0f; margin-top:8px; display:block; }

  /* Mode toggle */
  .mode-toggle { display:flex; justify-content:center; gap:12px; margin:12px 0 20px; }
  .mode-btn { border:0; border-radius:9999px; padding:12px 18px; font-weight:600;
              background:#fff; color:#cc1e0f; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.06);
              transition:all .2s ease; display:flex; align-items:center; gap:8px; }
  .mode-btn.active { background: linear-gradient(180deg,#e63b2e 0%, #cc1e0f 100%); color:#fff;
                     box-shadow:0 6px 16px rgba(204,30,15,.35); }
  .mode-btn:hover { transform: translateY(-1px); }

  /* Buttons */
  .btn { width:100%; padding:16px 20px; border:0; border-radius:14px; font-weight:700;
         cursor:pointer; transition:all .2s ease; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:12px; }
  .btn-primary { background: linear-gradient(180deg,#e63b2e 0%, #cc1e0f 100%); color:#fff; box-shadow:0 6px 18px rgba(204,30,15,.3); }
  .btn-primary:hover { transform: translateY(-1px); box-shadow:0 8px 22px rgba(204,30,15,.4); }
  .btn-secondary { background:#fff; color:#cc1e0f; border:1.5px solid #cc1e0f; box-shadow:0 2px 8px rgba(0,0,0,.06); }
  .btn-secondary:hover { background:#fff5f4; transform: translateY(-1px); }

  .file-input{display:none !important}

  /* Preview */
  .preview-container{ text-align:center; margin:16px 0; }
  .preview-image{ max-width:100%; max-height:300px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,.12); }

  /* Loading */
  .loading{ text-align:center; padding:40px 20px; }
  .spinner{ width:36px; height:36px; border-radius:50%; border:3px solid #f3d8d6; border-top-color:#cc1e0f; animation:spin 1s linear infinite; margin:0 auto 12px; }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading p{ color:#cc1e0f; }

  /* Toast */
  .toast{ position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#fff; color:#cc1e0f;
          border:1px solid rgba(204,30,15,.6); padding:12px 16px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); opacity:0; transition:opacity .25s ease; z-index:9999; }
  .toast.show{opacity:1}

  /* Body Result */
  .result-container{ max-width:420px; margin:0 auto; background:#fff; border-radius:20px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
  .photo-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
  .analyzed-photo{ width:100%; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,.12); }
  .overlay-wrap{ position:relative; }
  .overlay{ position:absolute; inset:0; pointer-events:none; }
  .overlay-label{ position:absolute; background:rgba(255,255,255,.9); color:#cc1e0f; font-size:12px;
                  padding:4px 6px; border-radius:6px; font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,.12); }
  .body-summary{ margin-top:16px; padding:12px; background:#fff5f5; border-radius:14px; box-shadow: inset 0 1px 2px rgba(204,30,15,.15); }
  .body-summary h3{ color:#cc1e0f; margin-bottom:6px; }
  .metrics{ display:flex; gap:12px; justify-content:center; }
  .metrics .chip{ background:#fff; border:1px solid #f3d8d6; border-radius:9999px; padding:6px 10px; color:#cc1e0f; font-weight:700; }

  @media (min-width: 460px){
    .photo-grid{ grid-template-columns:1fr 1fr; }
  }
</style>
</head>
<body>

  <div class="container">
    <!-- Camera Page -->
    <div id="cameraPage">
      <div class="header">
        <h1>Food Tracker</h1>
        <i class="fi fi-tr-camera-viewfinder"></i>
      </div>

      <!-- Mode toggle -->
      <div class="mode-toggle">
        <button id="btnFood" class="mode-btn active" onclick="setMode('food')"><i class="fi fi-rr-salad"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        <button id="btnBody" class="mode-btn" onclick="setMode('body')"><i class="fi fi-rr-user-crown"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á</button>
      </div>

      <!-- Inputs (single camera input shared) -->
      <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="environment"
             onchange="mode === 'body' ? previewBodyImage(event) : previewImage(event)">
      <input type="file" id="galleryInput" class="file-input" accept="image/*" onchange="previewImage(event)">

      <!-- Action buttons -->
      <button class="btn btn-primary" onclick="openCamera()">Take Photo</button>
      <button class="btn btn-secondary" onclick="openGallery()">Choose Image</button>

      <!-- Preview (food mode) -->
      <div id="previewContainer" class="preview-container hidden">
        <img id="previewImage" class="preview-image" alt="preview">
      </div>
    </div>

    <!-- Food Loading (kept simple placeholder) -->
    <div id="loadingPage" class="hidden">
      <div class="loading">
        <div class="spinner"></div>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
      </div>
    </div>

    <!-- Body Loading -->
    <div id="loadingBodyPage" class="hidden">
      <div class="loading">
        <div class="spinner"></div>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
        <p style="font-size:13px;color:#7a7a7a;">E‚ÄëCal AI Coach: Body Fat / Muscle / Score</p>
      </div>
    </div>

    <!-- Body Result -->
    <div id="resultBodyPage" class="hidden">
      <div class="result-container">
        <div class="photo-grid">
          <div class="overlay-wrap">
            <img id="bodyImageFront" class="analyzed-photo" alt="Front body">
            <div class="overlay" id="overlayFront"></div>
          </div>
          <div class="overlay-wrap">
            <img id="bodyImageSide" class="analyzed-photo" alt="Side body">
            <div class="overlay" id="overlaySide"></div>
          </div>
        </div>
        <div class="body-summary">
          <h3>Body Score: <span id="bodyScore">‚Äì</span>/10</h3>
          <div class="metrics">
            <div class="chip">Body Fat: <span id="bodyFat">‚Äì</span>%</div>
            <div class="chip">Muscle: <span id="muscleMass">‚Äì</span>%</div>
          </div>
          <p id="bodyFocus" style="margin-top:8px;font-weight:600;color:#333;"></p>
          <p id="bodyTip" style="margin-top:4px;"></p>
        </div>
        <button class="btn btn-secondary" onclick="goHome()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">Hello</div>

<script>
  // ===== Globals =====
  let currentUser = null;
  let analysisResult = null;
  let selectedImage = null;

  // Body mode globals
  let mode = 'food';
  let bodyImages = { front: null, side: null };
  let bodyStep = 'front';

  // ===== UI Helpers =====
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 1200);
  }

  function goHome(){
    document.getElementById('resultBodyPage').classList.add('hidden');
    document.getElementById('loadingBodyPage').classList.add('hidden');
    document.getElementById('loadingPage').classList.add('hidden');
    document.getElementById('cameraPage').classList.remove('hidden');
  }

  // ===== Mode Toggle =====
  function setMode(newMode){
    mode = newMode;
    document.getElementById('btnFood').classList.toggle('active', mode === 'food');
    document.getElementById('btnBody').classList.toggle('active', mode === 'body');
    showToast(mode === 'food' ? 'üç± ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£' : 'üí™ ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á');
  }

  // ===== Camera & Gallery =====
  function openCamera(){
    if (mode === 'body'){
      bodyStep = 'front';
      showToast('üì∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤');
    } else {
      showToast('Opening camera...', 'success');
    }
    setTimeout(()=>{
      const cameraInput = document.getElementById('cameraInput');
      cameraInput.value = '';
      cameraInput.dispatchEvent(new MouseEvent('click', {view:window, bubbles:true, cancelable:true}));
    }, 120);
  }

  function openGallery(){
    const galleryInput = document.getElementById('galleryInput');
    galleryInput.value = '';
    galleryInput.dispatchEvent(new MouseEvent('click', {view:window, bubbles:true, cancelable:true}));
  }

  // ===== Food (existing) preview =====
  function previewImage(event){
    const file = event.target.files[0];
    if (!file){ showToast('No image selected'); return; }
    selectedImage = file;
    const reader = new FileReader();
    reader.onload = (e)=>{
      document.getElementById('previewImage').src = e.target.result;
      document.getElementById('previewContainer').classList.remove('hidden');
      // Your existing food analyze flow continues...
    };
    reader.readAsDataURL(file);
  }

  // ===== Body: 2-step capture =====
  function previewBodyImage(event){
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      if (bodyStep === 'front'){
        bodyImages.front = reader.result;
        showToast('‚úÖ ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á');
        bodyStep = 'side';
        setTimeout(()=>{
          const cameraInput = document.getElementById('cameraInput');
          cameraInput.value='';
          cameraInput.dispatchEvent(new MouseEvent('click', {view:window, bubbles:true, cancelable:true}));
        }, 250);
      } else {
        bodyImages.side = reader.result;
        showToast('‚úÖ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏°‡∏∏‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...');
        analyzeBodyImages();
      }
    };
    reader.readAsDataURL(file);
  }

  function showBodyLoading(){
    document.getElementById('cameraPage').classList.add('hidden');
    document.getElementById('loadingBodyPage').classList.remove('hidden');
  }

  async function analyzeBodyImages(){
    showBodyLoading();
    try {
      const lineUserId = localStorage.getItem('line_user_id') || window.lineUserId || null;
      if (!lineUserId){ alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö LINE User ID'); goHome(); return; }

      const resp = await fetch('https://primary-production-49d9.up.railway.app/webhook-test/body', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          mode:'body',
          line_user_id: lineUserId,
          images: [bodyImages.front, bodyImages.side]
        })
      });
      const result = await resp.json();
      showBodyResult(result);
    } catch (e){
      console.error(e);
      alert('‚ùå ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      goHome();
    }
  }

  // ===== Render Body Result =====
  function showBodyResult(result){
    document.getElementById('loadingBodyPage').classList.add('hidden');
    document.getElementById('resultBodyPage').classList.remove('hidden');

    // show images from captured data (front+side)
    document.getElementById('bodyImageFront').src = bodyImages.front;
    document.getElementById('bodyImageSide').src = bodyImages.side;

    // numbers
    document.getElementById('bodyScore').textContent = (result.body_score ?? '‚Äì');
    document.getElementById('bodyFat').textContent = (result.body_fat ?? '‚Äì');
    document.getElementById('muscleMass').textContent = (result.muscle_mass ?? '‚Äì');
    document.getElementById('bodyFocus').textContent = result.focus || '';
    document.getElementById('bodyTip').textContent = result.tip_th ? ('‡πÇ‡∏Ñ‡πâ‡∏ä‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ' + result.tip_th) : '';

    // labels: place half on front and half on side
    const overF = document.getElementById('overlayFront');
    const overS = document.getElementById('overlaySide');
    overF.innerHTML = '';
    overS.innerHTML = '';

    const labels = Array.isArray(result.labels) ? result.labels : [];
    const mid = Math.ceil(labels.length/2);
    const frontLabels = labels.slice(0, mid);
    const sideLabels  = labels.slice(mid);

    frontLabels.forEach(l=> addLabel(overF, l));
    sideLabels.forEach(l=> addLabel(overS, l));
  }

  function addLabel(container, l){
    const d = document.createElement('div');
    d.className = 'overlay-label';
    d.textContent = `${l.part}: ${l.description}`;
    const x = Math.min(95, Math.max(5, Number(l.x || 50)));
    const y = Math.min(95, Math.max(5, Number(l.y || 50)));
    d.style.left = x + '%';
    d.style.top  = y + '%';
    container.appendChild(d);
  }
</script>
</body>
</html>
