<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weight Tracker</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <style>
        body {
            box-sizing: border-box;
        }
        
        .gradient-bg {
            background: #000000;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .weight-card {
            transition: all 0.3s ease;
        }
        
        .weight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.15);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full gradient-bg font-sans">
  <main class="min-h-full p-4"><!-- Header (Hidden) -->
   <header class="hidden text-center mb-6 rounded-2xl p-6 border-2" style="background-color: #000000; border-color: #C1272D;">
    <div class="flex items-center justify-center mb-2">
     <svg class="w-8 h-8 mr-2" style="color: #C1272D;" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
     </svg>
     <h1 id="app-title" class="text-2xl font-bold" style="color: #FFFFFF;">Weight Tracker</h1>
    </div>
    <p id="welcome-message" style="color: #FFFFFF;">Track your progress</p>
    <div id="user-info" class="mt-2 text-sm" style="color: #FFFFFF;"></div>
    <div class="mt-3 text-center">
     <div class="inline-flex items-center px-3 py-1 rounded-full text-xs" style="background-color: rgba(193, 39, 45, 0.2); color: #C1272D;">
      <svg class="w-3 h-3 mr-1" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
      </svg> เชื่อมต่อ Supabase Database + Storage
     </div>
    </div>
   </header><!-- Loading State -->
   <div id="loading-state" class="text-center py-8">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p style="color: #ffffff;">กำลังเชื่อมต่อ LINE...</p>
   </div><!-- Navigation -->
   <nav id="main-nav" class="hidden mb-6">
    <div class="glass-effect rounded-2xl p-2 flex space-x-2"><button id="nav-home" class="nav-btn flex-1 py-2 px-4 rounded-xl font-medium transition-all duration-200 shadow-lg" style="background-color: #C1272D; color: #ffffff;">
      <svg class="w-4 h-4 mx-auto mb-1" fill="currentColor" viewbox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg>
      <div class="text-xs">
       หน้าหลัก
      </div></button> <button id="nav-gallery" class="nav-btn flex-1 py-2 px-4 rounded-xl font-medium transition-all duration-200" style="color: #ffffff; background-color: rgba(255, 255, 255, 0.3);">
      <svg class="w-4 h-4 mx-auto mb-1" fill="currentColor" viewbox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
      </svg>
      <div class="text-xs">
       แกลเลอรี่
      </div></button>
    </div>
   </nav><!-- Main Content -->
   <div id="main-content" class="hidden"><!-- Home Page -->
    <div id="home-page"><!-- Add Weight Form -->
     <div class="glass-effect rounded-2xl p-6 mb-6 fade-in">
      <h2 class="text-lg font-semibold mb-4 flex items-center" style="color: #ffffff;">
       <svg class="w-5 h-5 mr-2" style="color: #ffffff;" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
       </svg> เพิ่มน้ำหนักใหม่</h2>
      <form id="weight-form" class="space-y-4">
       <div><label for="weight-input" class="block text-sm font-medium mb-2" style="color: #ffffff;">น้ำหนัก (กก.)</label> <input type="number" id="weight-input" step="0.1" min="0" max="999.9" class="w-full px-4 py-3 rounded-xl placeholder-gray-400 focus:outline-none focus:ring-2 focus:border-transparent" style="background-color: #000000; border: 2px solid #C1272D; color: #FFFFFF; --tw-ring-color: #C1272D;" placeholder="เช่น 65.5" required>
       </div>
       <div><label for="note-input" class="block text-sm font-medium mb-2" style="color: #ffffff;">หมายเหตุ (ไม่บังคับ)</label> <textarea id="note-input" rows="2" class="w-full px-4 py-3 rounded-xl placeholder-gray-400 focus:outline-none focus:ring-2 focus:border-transparent resize-none" style="background-color: #000000; border: 2px solid #C1272D; color: #FFFFFF; --tw-ring-color: #C1272D;" placeholder="เช่น หลังออกกำลังกาย"></textarea>
       </div>
       <div><label for="photo-upload" class="block text-sm font-medium mb-2" style="color: #ffffff;">อัปโหลดรูปภาพ (ไม่บังคับ)</label>
        <div class="relative"><input type="file" id="photo-upload" accept="image/*" class="hidden"> <button type="button" id="photo-upload-btn" class="w-full px-4 py-3 rounded-xl transition-all duration-200 flex items-center justify-center" style="background-color: #000000; border: 2px solid #C1272D; color: #FFFFFF;" onmouseover="this.style.backgroundColor='#1a1a1a'" onmouseout="this.style.backgroundColor='#000000'">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewbox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
          </svg> เลือกรูปภาพ </button>
        </div>
        <div id="photo-preview" class="hidden mt-3">
         <div class="relative inline-block"><img id="preview-image" class="w-20 h-20 object-cover rounded-lg border-2 border-white/30"> <button type="button" id="remove-photo" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
           <svg class="w-3 h-3" fill="currentColor" viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
           </svg></button>
         </div>
        </div>
       </div><button type="submit" id="add-weight-btn" class="w-full font-semibold py-3 px-6 rounded-xl transition-all duration-200 flex items-center justify-center" style="background-color: #C1272D; color: #ffffff;" onmouseover="this.style.backgroundColor='#a01f24'" onmouseout="this.style.backgroundColor='#C1272D'">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewbox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
        </svg><span id="add-button-text">Add Weight</span> </button>
      </form>
     </div><!-- Progress Chart -->
     <div class="glass-effect rounded-2xl p-6 mb-6 fade-in">
      <h2 class="text-lg font-semibold mb-4 flex items-center" style="color: #ffffff;">
       <svg class="w-5 h-5 mr-2" style="color: #ffffff;" fill="currentColor" viewbox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
       </svg> กราฟความคืบหน้า</h2>
      <div id="chart-container" class="relative">
       <canvas id="weight-chart" class="w-full" style="max-height: 300px;"></canvas>
       <div id="chart-empty" class="hidden text-center py-8 text-gray-500">
        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="currentColor" viewbox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
        </svg>
        <p class="text-sm">ต้องมีข้อมูลอย่างน้อย 2 จุดเพื่อแสดงกราฟ</p>
       </div>
      </div>
      <div id="progress-stats" class="mt-4 grid grid-cols-2 gap-4"><!-- Stats will be inserted here -->
      </div>
     </div><!-- Weight History -->
     <div class="glass-effect rounded-2xl p-6 fade-in">
      <h2 class="text-lg font-semibold mb-4 flex items-center" style="color: #ffffff;">
       <svg class="w-5 h-5 mr-2" style="color: #ffffff;" fill="currentColor" viewbox="0 0 24 24"><path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H19V1h-2v1H7V1H5v1H4.5C3.11 2 2 3.11 2 4.5v15C2 20.89 3.11 22 4.5 22h15c1.39 0 2.5-1.11 2.5-2.5v-15C22 3.11 20.89 2 19.5 2z" />
       </svg> ประวัติน้ำหนัก</h2>
      <div id="weight-list" class="space-y-3"><!-- Weight records will be inserted here -->
      </div>
      <div id="empty-state" class="text-center py-8 text-gray-500">
       <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
       </svg>
       <p>ยังไม่มีข้อมูลน้ำหนัก</p>
       <p class="text-sm mt-1">เริ่มบันทึกน้ำหนักของคุณเลย!</p>
      </div>
     </div>
    </div><!-- Gallery Page -->
    <div id="gallery-page" class="hidden">
     <div class="glass-effect rounded-2xl p-6 mb-6 fade-in">
      <h2 class="text-lg font-semibold mb-4 flex items-center" style="color: #ffffff;">
       <svg class="w-5 h-5 mr-2" style="color: #ffffff;" fill="currentColor" viewbox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
       </svg> แกลเลอรี่รูปภาพ</h2><!-- Gallery Grid -->
      <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"><!-- Gallery items will be inserted here -->
      </div><!-- Empty Gallery State -->
      <div id="gallery-empty" class="hidden text-center py-8 text-white/60">
       <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="currentColor" viewbox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
       </svg>
       <p>ยังไม่มีรูปภาพ</p>
       <p class="text-sm mt-1">เพิ่มรูปภาพในหน้าหลักเพื่อดูในแกลเลอรี่</p>
      </div>
     </div>
    </div>
   </div><!-- Image Modal -->
   <div id="image-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full"><button id="close-modal" class="absolute -top-10 right-0 text-white hover:text-gray-300 transition-colors">
      <svg class="w-8 h-8" fill="currentColor" viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
      </svg></button> <img id="modal-image" class="max-w-full max-h-full object-contain rounded-lg">
     <div id="modal-info" class="absolute bottom-0 left-0 right-0 bg-black/60 text-white p-4 rounded-b-lg"><!-- Image info will be inserted here -->
     </div>
    </div>
   </div><!-- Error State -->
   <div id="error-state" class="hidden text-center py-8">
    <svg class="w-16 h-16 mx-auto mb-4 text-white/60" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
    </svg>
    <p class="text-white mb-4">ไม่สามารถเชื่อมต่อได้</p><button id="retry-btn" class="font-semibold py-2 px-6 rounded-xl transition-all duration-200" style="background-color: #C1272D; color: #ffffff;" onmouseover="this.style.backgroundColor='#a01f24'" onmouseout="this.style.backgroundColor='#C1272D'"> ลองใหม่ </button>
   </div>
  </main>
  <script>
        // Configuration
        const defaultConfig = {
            app_title: "Weight Tracker",
            welcome_message: "Track your progress",
            add_button_text: "Add Weight"
        };

        // Supabase Configuration
        const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
        let supabase = null;

        let currentUser = null;
        let weightRecords = [];
        let isLoading = false;
        let isDemoMode = false; // Set to true for demo mode
        let selectedImageData = null;
        let currentPage = 'home';
        let currentFilter = 'all';

        // Demo data for testing
        const demoData = [
            { __backendId: 'demo1', line_user_id: 'demo_user', record_date: '2024-01-01', weight: 70.5, note: 'เริ่มต้นปีใหม่', created_at: '2024-01-01T10:00:00Z' },
            { __backendId: 'demo2', line_user_id: 'demo_user', record_date: '2024-01-08', weight: 69.8, note: 'สัปดาห์แรก', created_at: '2024-01-08T10:00:00Z' },
            { __backendId: 'demo3', line_user_id: 'demo_user', record_date: '2024-01-15', weight: 69.2, note: 'ลดได้อีก!', created_at: '2024-01-15T10:00:00Z' },
            { __backendId: 'demo4', line_user_id: 'demo_user', record_date: '2024-01-22', weight: 68.9, note: 'ใกล้เป้าหมายแล้ว', created_at: '2024-01-22T10:00:00Z' },
            { __backendId: 'demo5', line_user_id: 'demo_user', record_date: '2024-01-29', weight: 68.5, note: 'เป้าหมายสำเร็จ!', created_at: '2024-01-29T10:00:00Z' }
        ];

        // Supabase Integration
        function initializeSupabase() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                console.warn('Supabase credentials not configured, using demo mode');
                isDemoMode = true;
                return;
            }
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                isDemoMode = true;
            }
        }

        // Supabase Storage Functions
        async function uploadImageToStorage(file) {
            if (!supabase || isDemoMode) {
                // Demo mode - return Base64 data URL
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            try {
                const fileName = `${currentUser.userId}/${Date.now()}_${file.name}`;
                
                const { data, error } = await supabase.storage
                    .from('weight')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error('Storage upload error:', error);
                    throw error;
                }

                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('weight')
                    .getPublicUrl(fileName);

                return publicUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        async function deleteImageFromStorage(imageUrl) {
            if (!supabase || isDemoMode || !imageUrl || imageUrl.startsWith('data:')) {
                return; // Skip for demo mode or Base64 images
            }

            try {
                // Extract file path from URL
                const urlParts = imageUrl.split('/');
                const bucketIndex = urlParts.findIndex(part => part === 'weight');
                if (bucketIndex === -1) return;

                const filePath = urlParts.slice(bucketIndex + 1).join('/');
                
                const { error } = await supabase.storage
                    .from('weight')
                    .remove([filePath]);

                if (error) {
                    console.error('Storage delete error:', error);
                }
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }

        // Supabase Database Functions
        async function loadWeightRecords() {
            if (isDemoMode || !supabase || !currentUser) {
                weightRecords = [...demoData].sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
                renderWeightList();
                renderChart();
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('user_weight_log')
                    .select('*')
                    .eq('line_user_id', currentUser.userId)
                    .order('record_date', { ascending: false });

                if (error) {
                    console.error('Error loading weight records:', error);
                    showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
                    return;
                }

                weightRecords = data.map(record => ({
                    __backendId: record.id.toString(),
                    line_user_id: record.line_user_id,
                    record_date: record.record_date,
                    weight: parseFloat(record.weight),
                    note: record.note,
                    image_url: record.image_url,
                    created_at: record.created_at
                }));

                renderWeightList();
                renderChart();
            } catch (error) {
                console.error('Error loading weight records:', error);
                showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
            }
        }

        async function saveWeightRecord(recordData) {
            if (isDemoMode || !supabase) {
                // Demo mode - add to local array
                const newRecord = {
                    ...recordData,
                    __backendId: 'demo_' + Date.now()
                };
                weightRecords.unshift(newRecord);
                renderWeightList();
                renderChart();
                return { success: true };
            }

            try {
                const { data, error } = await supabase
                    .from('user_weight_log')
                    .insert([{
                        line_user_id: recordData.line_user_id,
                        record_date: recordData.record_date,
                        weight: recordData.weight,
                        note: recordData.note,
                        image_url: recordData.image_url
                    }])
                    .select();

                if (error) {
                    console.error('Error saving weight record:', error);
                    return { success: false, error: error.message };
                }

                // Reload records to get updated data
                await loadWeightRecords();
                return { success: true, data };
            } catch (error) {
                console.error('Error saving weight record:', error);
                return { success: false, error: error.message };
            }
        }

        async function deleteWeightRecord(recordId) {
            if (isDemoMode || !supabase) {
                // Demo mode - remove from local array
                weightRecords = weightRecords.filter(r => r.__backendId !== recordId);
                renderWeightList();
                renderChart();
                return { success: true };
            }

            try {
                // Find the record to get image URL before deleting
                const record = weightRecords.find(r => r.__backendId === recordId);
                
                const { error } = await supabase
                    .from('user_weight_log')
                    .delete()
                    .eq('id', parseInt(recordId));

                if (error) {
                    console.error('Error deleting weight record:', error);
                    return { success: false, error: error.message };
                }

                // Delete associated image from storage
                if (record && record.image_url) {
                    await deleteImageFromStorage(record.image_url);
                }

                // Reload records to get updated data
                await loadWeightRecords();
                return { success: true };
            } catch (error) {
                console.error('Error deleting weight record:', error);
                return { success: false, error: error.message };
            }
        }

        // LIFF Integration
        async function initializeLIFF() {
            if (isDemoMode) {
                // Demo mode - skip LIFF
                currentUser = {
                    userId: 'demo_user',
                    displayName: 'Demo User',
                    pictureUrl: null
                };

                document.getElementById('user-info').innerHTML = `
                    <div class="flex items-center justify-center">
                        <div class="w-6 h-6 bg-white/30 rounded-full mr-2 flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        <span>สวัสดี Demo User <span class="text-xs bg-white/20 px-2 py-1 rounded-full ml-2">DEMO</span></span>
                    </div>
                `;

                showMainContent();
                return;
            }

            try {
                await liff.init({ liffId: "2007859046-pXkDKWkv" });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                currentUser = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };

                document.getElementById('user-info').innerHTML = `
                    <div class="flex items-center justify-center">
                        ${profile.pictureUrl ? `<img src="${profile.pictureUrl}" class="w-6 h-6 rounded-full mr-2">` : ''}
                        <span>สวัสดี ${profile.displayName}</span>
                    </div>
                `;

                showMainContent();
                
                // Load weight records after LIFF initialization
                await loadWeightRecords();
                
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                showErrorState();
            }
        }

        // Data SDK Integration
        const dataHandler = {
            onDataChanged(data) {
                weightRecords = data.sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
                renderWeightList();
                renderChart();
            }
        };

        async function initializeDataSDK() {
            if (isDemoMode) {
                // Demo mode - use demo data
                weightRecords = [...demoData].sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
                renderWeightList();
                renderChart();
                return;
            }

            try {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error('Data SDK initialization failed:', result.error);
                }
            } catch (error) {
                console.error('Data SDK error:', error);
            }
        }

        // UI Functions
        function showMainContent() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
        }

        function showErrorState() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('main-nav').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        // Navigation functions
        function showPage(page) {
            currentPage = page;
            
            // Hide all pages
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('gallery-page').classList.add('hidden');
            
            // Show selected page
            document.getElementById(page + '-page').classList.remove('hidden');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('shadow-lg');
                btn.style.backgroundColor = '';
                btn.style.color = '#ffffff';
            });
            
            const activeBtn = document.getElementById('nav-' + page);
            activeBtn.classList.add('shadow-lg');
            activeBtn.style.backgroundColor = '#C1272D';
            activeBtn.style.color = '#ffffff';
            
            // Render gallery if switching to gallery page
            if (page === 'gallery') {
                renderGallery();
            }
        }

        // Gallery functions
        function renderGallery() {
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryEmpty = document.getElementById('gallery-empty');
            
            // Filter records with images and sort by date (newest first)
            let filteredRecords = weightRecords
                .filter(record => record.image_url)
                .sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
            
            if (filteredRecords.length === 0) {
                galleryGrid.innerHTML = '';
                galleryEmpty.classList.remove('hidden');
                return;
            }
            
            galleryEmpty.classList.add('hidden');
            
            galleryGrid.innerHTML = filteredRecords.map(record => {
                const date = new Date(record.record_date);
                const formattedDate = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                return `
                    <div class="gallery-item cursor-pointer group" onclick="openImageModal('${record.__backendId}')">
                        <div class="relative aspect-square overflow-hidden rounded-lg bg-white/10 border border-white/20">
                            <img 
                                src="${record.image_url}" 
                                alt="Weight photo" 
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
                            >
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-200"></div>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
                                <div class="text-white text-xs font-medium">${record.weight} กก.</div>
                                <div class="text-white/80 text-xs">${formattedDate}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openImageModal(recordId) {
            const record = weightRecords.find(r => r.__backendId === recordId);
            if (!record || !record.image_url) return;
            
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const modalInfo = document.getElementById('modal-info');
            
            const date = new Date(record.record_date);
            const formattedDate = date.toLocaleDateString('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            modalImage.src = record.image_url;
            modalInfo.innerHTML = `
                <div>
                    <div class="text-lg font-semibold">${record.weight} กก.</div>
                    <div class="text-sm text-white/80">${formattedDate}</div>
                    ${record.note ? `<div class="text-sm text-white/90 mt-1">${record.note}</div>` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function renderChart() {
            const canvas = document.getElementById('weight-chart');
            const chartEmpty = document.getElementById('chart-empty');
            const progressStats = document.getElementById('progress-stats');

            if (weightRecords.length < 2) {
                canvas.classList.add('hidden');
                chartEmpty.classList.remove('hidden');
                progressStats.innerHTML = '';
                return;
            }

            canvas.classList.remove('hidden');
            chartEmpty.classList.add('hidden');

            // Sort records by date for chart
            const sortedRecords = [...weightRecords].sort((a, b) => new Date(a.record_date) - new Date(b.record_date));
            
            // Calculate stats
            const firstWeight = sortedRecords[0].weight;
            const lastWeight = sortedRecords[sortedRecords.length - 1].weight;
            const weightChange = lastWeight - firstWeight;
            const maxWeight = Math.max(...sortedRecords.map(r => r.weight));
            const minWeight = Math.min(...sortedRecords.map(r => r.weight));

            // Render stats
            progressStats.innerHTML = `
                <div class="rounded-lg p-2 text-center border border-white/30 shadow-lg backdrop-blur-sm" style="background-color: #C1272D;">
                    <div class="text-white text-xs font-medium mb-1">การเปลี่ยนแปลง</div>
                    <div class="text-white font-bold text-sm">
                        ${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)} กก.
                    </div>
                </div>
                <div class="rounded-lg p-2 text-center border border-white/30 shadow-lg backdrop-blur-sm" style="background-color: #C1272D;">
                    <div class="text-white text-xs font-medium mb-1">ช่วงน้ำหนัก</div>
                    <div class="text-white font-bold text-sm">
                        ${minWeight.toFixed(1)} - ${maxWeight.toFixed(1)} กก.
                    </div>
                </div>
            `;

            // Draw chart
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = 300 * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            const padding = 40;
            const chartWidth = rect.width - padding * 2;
            const chartHeight = 300 - padding * 2;

            // Clear canvas
            ctx.clearRect(0, 0, rect.width, 300);

            // Calculate scales
            const minY = minWeight - 1;
            const maxY = maxWeight + 1;
            const yRange = maxY - minY;

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }

            // Draw weight line
            ctx.strokeStyle = '#C1272D';
            ctx.lineWidth = 3;
            ctx.beginPath();

            sortedRecords.forEach((record, index) => {
                const x = padding + (chartWidth / (sortedRecords.length - 1)) * index;
                const y = padding + chartHeight - ((record.weight - minY) / yRange) * chartHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Draw data points
            ctx.fillStyle = '#ff9114';
            sortedRecords.forEach((record, index) => {
                const x = padding + (chartWidth / (sortedRecords.length - 1)) * index;
                const y = padding + chartHeight - ((record.weight - minY) / yRange) * chartHeight;

                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();

                // Draw weight labels
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(record.weight.toFixed(1), x, y - 15);
            });

            // Draw Y-axis labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 5; i++) {
                const value = maxY - (yRange / 5) * i;
                const y = padding + (chartHeight / 5) * i + 4;
                ctx.fillText(value.toFixed(1), padding - 10, y);
            }

            // Draw X-axis labels (dates)
            ctx.textAlign = 'center';
            sortedRecords.forEach((record, index) => {
                if (index % Math.ceil(sortedRecords.length / 4) === 0 || index === sortedRecords.length - 1) {
                    const x = padding + (chartWidth / (sortedRecords.length - 1)) * index;
                    const date = new Date(record.record_date);
                    const label = date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
                    ctx.fillText(label, x, 300 - 10);
                }
            });
        }

        function renderWeightList() {
            const weightList = document.getElementById('weight-list');
            const emptyState = document.getElementById('empty-state');

            if (weightRecords.length === 0) {
                weightList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            weightList.innerHTML = weightRecords.map(record => {
                const date = new Date(record.record_date);
                const formattedDate = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const deleteButton = isDemoMode ? '' : `
                    <button 
                        onclick="deleteWeight('${record.__backendId}')" 
                        class="text-white/60 hover:text-white transition-colors"
                        title="ลบ"
                    >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                `;

                return `
                    <div class="weight-card bg-white/10 rounded-xl p-4 border border-white/20">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-start space-x-3">
                                ${record.image_url ? `
                                    <img src="${record.image_url}" class="w-12 h-12 object-cover rounded-lg border border-white/30" alt="Weight photo">
                                ` : ''}
                                <div>
                                    <div class="text-white font-semibold text-lg">${record.weight} กก.</div>
                                    <div class="text-white/70 text-sm">${formattedDate}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${deleteButton}
                            </div>
                        </div>
                        ${record.note ? `<div class="text-white/80 text-sm mt-2">${record.note}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function addWeight(event) {
            event.preventDefault();
            
            if (isLoading || weightRecords.length >= 999) {
                if (weightRecords.length >= 999) {
                    showToast('ถึงขิดจำกัด 999 รายการแล้ว กรุณาลบข้อมูลเก่าก่อน', 'error');
                }
                return;
            }

            const weightInput = document.getElementById('weight-input');
            const noteInput = document.getElementById('note-input');
            const submitBtn = document.getElementById('add-weight-btn');

            const weight = parseFloat(weightInput.value);
            if (!weight || weight <= 0) {
                showToast('กรุณาใส่น้ำหนักที่ถูกต้อง', 'error');
                return;
            }

            isLoading = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <div class="loading-spinner mr-2"></div>
                กำลังบันทึก...
            `;

            try {
                const newRecord = {
                    line_user_id: currentUser.userId,
                    record_date: new Date().toISOString().split('T')[0],
                    weight: weight,
                    note: noteInput.value.trim() || null,
                    image_url: selectedImageData,
                    created_at: new Date().toISOString()
                };

                const result = await saveWeightRecord(newRecord);
                
                if (result.success) {
                    showToast(isDemoMode ? 'บันทึกน้ำหนักเรียบร้อย! (โหมดเดโม)' : 'บันทึกน้ำหนักเรียบร้อย!', 'success');
                } else {
                    showToast('เกิดข้อผิดพลาดในการบันทึก: ' + (result.error || 'Unknown error'), 'error');
                    return;
                }

                weightInput.value = '';
                noteInput.value = '';
                clearPhotoPreview();
                
            } catch (error) {
                console.error('Error adding weight:', error);
                showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
            } finally {
                isLoading = false;
                submitBtn.disabled = false;
                const config = window.elementSdk?.config || defaultConfig;
                submitBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    ${config.add_button_text || defaultConfig.add_button_text}
                `;
                submitBtn.style.backgroundColor = '#C1272D';
                submitBtn.style.color = '#ffffff';
            }
        }

        async function deleteWeight(recordId) {
            const record = weightRecords.find(r => r.__backendId === recordId);
            if (!record) return;

            const deleteBtn = event.target.closest('button');
            const originalContent = deleteBtn.innerHTML;
            
            deleteBtn.innerHTML = `
                <div class="loading-spinner"></div>
            `;
            deleteBtn.disabled = true;

            try {
                const result = await deleteWeightRecord(recordId);
                
                if (result.success) {
                    showToast('ลบข้อมูลเรียบร้อย', 'success');
                } else {
                    showToast('เกิดข้อผิดพลาดในการลบ: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error deleting weight:', error);
                showToast('เกิดข้อผิดพลาดในการลบ', 'error');
            } finally {
                deleteBtn.innerHTML = originalContent;
                deleteBtn.disabled = false;
            }
        }

        // Photo handling functions
        async function handlePhotoUpload() {
            const fileInput = document.getElementById('photo-upload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // Check file size (max 10MB for storage)
            if (file.size > 10 * 1024 * 1024) {
                showToast('ไฟล์รูปภาพต้องมีขนาดไม่เกิน 10MB', 'error');
                return;
            }
            
            try {
                // Show loading state
                const uploadBtn = document.getElementById('photo-upload-btn');
                const originalContent = uploadBtn.innerHTML;
                uploadBtn.innerHTML = `
                    <div class="loading-spinner mr-2"></div>
                    กำลังอัปโหลด...
                `;
                uploadBtn.disabled = true;
                
                // Upload to storage and get URL
                selectedImageData = await uploadImageToStorage(file);
                showPhotoPreview(selectedImageData);
                
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
                
            } catch (error) {
                console.error('Error uploading photo:', error);
                showToast('เกิดข้อผิดพลาดในการอัปโหลดรูป', 'error');
                
                const uploadBtn = document.getElementById('photo-upload-btn');
                uploadBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                    </svg>
                    เลือกรูปภาพ
                `;
                uploadBtn.disabled = false;
            }
        }
        
        function showPhotoPreview(imageData) {
            const preview = document.getElementById('photo-preview');
            const previewImage = document.getElementById('preview-image');
            const uploadBtn = document.getElementById('photo-upload-btn');
            
            previewImage.src = imageData;
            preview.classList.remove('hidden');
            
            uploadBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                รูปภาพถูกเลือกแล้ว
            `;
            uploadBtn.classList.add('bg-green-500/20', 'border-green-400/50');
        }
        
        function clearPhotoPreview() {
            const preview = document.getElementById('photo-preview');
            const uploadBtn = document.getElementById('photo-upload-btn');
            const fileInput = document.getElementById('photo-upload');
            
            selectedImageData = null;
            preview.classList.add('hidden');
            fileInput.value = '';
            
            uploadBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                </svg>
                เลือกรูปภาพ
            `;
            uploadBtn.classList.remove('bg-green-500/20', 'border-green-400/50');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Element SDK Integration
        async function onConfigChange(config) {
            document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('add-button-text').textContent = config.add_button_text || defaultConfig.add_button_text;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                ["add_button_text", config.add_button_text || defaultConfig.add_button_text]
            ]);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            initializeSupabase();

            // Initialize Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }

            // Initialize Data SDK (for demo mode fallback)
            await initializeDataSDK();

            // Initialize LIFF
            await initializeLIFF();

            // Form submission
            document.getElementById('weight-form').addEventListener('submit', addWeight);

            // Photo upload handlers
            document.getElementById('photo-upload-btn').addEventListener('click', () => {
                document.getElementById('photo-upload').click();
            });
            
            document.getElementById('photo-upload').addEventListener('change', handlePhotoUpload);
            
            document.getElementById('remove-photo').addEventListener('click', clearPhotoPreview);

            // Retry button
            document.getElementById('retry-btn').addEventListener('click', () => {
                location.reload();
            });

            // Navigation event listeners
            document.getElementById('nav-home').addEventListener('click', () => showPage('home'));
            document.getElementById('nav-gallery').addEventListener('click', () => showPage('gallery'));

            // Image modal event listeners
            document.getElementById('close-modal').addEventListener('click', closeImageModal);
            document.getElementById('image-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('image-modal')) {
                    closeImageModal();
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('image-modal').classList.contains('hidden')) {
                    closeImageModal();
                }
            });

            // Redraw chart on window resize
            window.addEventListener('resize', () => {
                if (weightRecords.length >= 2) {
                    setTimeout(renderChart, 100);
                }
            });
        });
    </script>
   <a href="https://liff.line.me/2007859046-BpXDWpXe"
   class="fixed bottom-6 right-6 bg-[#FF3974] text-white 
          w-14 h-14 flex items-center justify-center 
          rounded-full shadow-md hover:bg-pink-600 text-3xl z-50 transition">
   <i class="fi fi-rr-home"></i>
</a>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99c6e85654cad017',t:'MTc2Mjc5MTk0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

