<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Tracking Dashboard</title>
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .glass-header {
            background: #000000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-red {
            background: #C1272D;
            transition: all 0.3s ease;
        }
        
        .btn-red:hover {
            background: #a01f24;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(193, 39, 45, 0.4);
        }
        
        .delete-btn {
            background: rgba(220, 38, 38, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: rgba(185, 28, 28, 0.9);
            transform: scale(1.05);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #C1272D;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stat-card {
            transition: transform 0.2s ease-in-out;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
  <style>
.fade-out {
  opacity: 0;
  transition: opacity 0.25s ease-in-out;
}
</style>

  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="min-h-screen" style="background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);"><!-- Header -->
  <header class="glass-header text-white p-4 sticky top-0 z-50">
   <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div class="flex items-center space-x-3">
     <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center"><span class="text-lg">üçΩÔ∏è</span>
     </div>
     <h1 class="text-xl font-semibold">Food Dashboard</h1>
    </div>
    <div class="flex items-center space-x-2">
     <div class="w-9 h-9 bg-white bg-opacity-20 rounded-full overflow-hidden flex items-center justify-center border border-white/20">
    <img id="userProfilePic" class="w-full h-full object-cover hidden" alt="Profile" />
    <span class="text-sm text-white" id="userInitial"></span>
</div>
<span class="text-sm" id="userName">Loading...</span>
    </div>
   </div>
  </header><!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center z-40" style="background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);">
   <div class="text-center">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-white font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
   </div>
  </div><!-- Error Screen -->
  <div id="errorScreen" class="hidden fixed inset-0 flex items-center justify-center z-40" style="background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);">
   <div class="text-center p-6 glass-effect rounded-xl max-w-md">
    <div class="text-6xl mb-4">
     ‚ö†Ô∏è
    </div>
    <h2 class="text-xl font-semibold text-white mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
    <p class="text-gray-300 mb-4" id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p><button onclick="location.reload()" class="btn-red text-white px-6 py-2 rounded-lg transition-all"> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà </button>
   </div>
  </div>
  
<!-- Main Content -->
<main id="mainContent" class="hidden max-w-6xl mx-auto p-4 pb-20">
  <!-- Time Period Selector -->
  <div class="mb-6">
    <div class="glass-effect rounded-xl p-4">
      <div class="flex flex-wrap gap-2">

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
        <button 
          class="period-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 
                 btn-red text-white shadow-lg flex items-center gap-2"
          data-period="daily">
            <i class="fi fi-rr-calendar-lines-pen"></i> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        </button>

        <!-- ‡∏õ‡∏∏‡πà‡∏° Dashboard (‡πÅ‡∏Å‡πâ onclick + fade transition) -->
        <a 
          onclick="smoothGo('https://liff.line.me/2007859046-WDvlrevQ')" 
          class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 
                 text-white shadow-lg flex items-center gap-2
                 border border-[#C1272D] bg-black hover:bg-black/70 cursor-pointer">

          <i class="fi fi-rr-chart-line-up text-white"></i>
          <span>Dashboard</span>
        </a>

      </div>
    </div>
  </div>

   </div><!-- Daily Donut Chart -->
   <div class="mb-6">
    <div class="glass-effect rounded-xl p-6">
     <h3 class="text-lg font-bold text-white mb-4">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
     <div class="relative" style="height: 250px;">
      <canvas id="dailyDonutChart"></canvas>
      <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
       <div class="text-sm text-gray-300" id="donutLabel">
        Remaining
       </div>
       <div class="text-4xl font-bold text-white" id="remainingCalories">
        0
       </div>
       <div class="text-xs text-gray-400">
        kcal
       </div>
      </div>
     </div>
    </div>
   </div><!-- Warnings Box for All Periods -->
   <div id="warningsBox" class="hidden mb-6">
    <div class="glass-effect rounded-xl p-5 border border-yellow-500/30">
     <div class="flex items-start space-x-3">
      <div class="text-3xl" id="warningIcon">
      
      </div>
      <div class="flex-1">
       <h4 class="font-bold text-red-300 mb-2 text-lg" id="warningTitle">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h4>
       <div class="text-sm text-gray-200" id="warningContent"><!-- Warning messages will be inserted here -->
       </div>
      </div>
     </div>
    </div>
   </div><!-- Stats Cards -->
   <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="glass-effect rounded-xl p-4 stat-card">
     <div class="flex items-center justify-between mb-2"><span class="text-2xl">üî•</span> <span class="text-xs text-gray-400">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
     </div>
     <div class="text-2xl font-bold text-white" id="totalCalories">
      0
     </div>
     <div class="text-sm text-gray-300">
      ‡∏à‡∏≤‡∏Å <span id="tdeeValue">0</span> kcal
     </div>
     <div class="w-full bg-gray-700/50 rounded-full h-2 mt-2">
      <div class="h-2 rounded-full transition-all duration-300" id="calorieProgress" style="width: 0%; background: linear-gradient(90deg, #ff6b6b 0%, #ff8e53 100%);"></div>
     </div>
    </div>
    <div class="glass-effect rounded-xl p-4 stat-card">
     <div class="flex items-center justify-between mb-2"><span class="text-2xl">üçñ</span> <span class="text-xs text-gray-400">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span>
     </div>
     <div class="text-2xl font-bold text-white" id="totalProtein">
      0g
     </div>
     <div class="text-sm text-gray-300">
      ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ <span id="proteinGoal">0g</span>
     </div>
     <div class="w-full bg-gray-700/50 rounded-full h-2 mt-2">
      <div class="h-2 rounded-full transition-all duration-300" id="proteinProgress" style="width: 0%; background: linear-gradient(90deg, #f87171 0%, #fb923c 100%);"></div>
     </div>
    </div>
    <div class="glass-effect rounded-xl p-4 stat-card">
     <div class="flex items-center justify-between mb-2"><span class="text-2xl">üçû</span> <span class="text-xs text-gray-400">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö</span>
     </div>
     <div class="text-2xl font-bold text-white" id="totalCarbs">
      0g
     </div>
     <div class="text-sm text-gray-300">
      ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ <span id="carbsGoal">0g</span>
     </div>
     <div class="w-full bg-gray-700/50 rounded-full h-2 mt-2">
      <div class="h-2 rounded-full transition-all duration-300" id="carbsProgress" style="width: 0%; background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);"></div>
     </div>
    </div>
    <div class="glass-effect rounded-xl p-4 stat-card">
     <div class="flex items-center justify-between mb-2"><span class="text-2xl">ü•ë</span> <span class="text-xs text-gray-400">‡πÑ‡∏ü‡∏ï‡πå</span>
     </div>
     <div class="text-2xl font-bold text-white" id="totalFat">
      0g
     </div>
     <div class="text-sm text-gray-300">
      ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ <span id="fatGoal">0g</span>
     </div>
     <div class="w-full bg-gray-700/50 rounded-full h-2 mt-2">
      <div class="h-2 rounded-full transition-all duration-300" id="fatProgress" style="width: 0%; background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);"></div>
     </div>
    </div>
   </div><!-- Recent Food Logs -->
   <div class="glass-effect rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div id="foodLogsList" class="space-y-3">
     <div class="text-center text-gray-400 py-8">
      <div class="text-4xl mb-2">
       üçΩÔ∏è
      </div>
      <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
     </div>
    </div>
   </div>
  </main>
  <script>
        // Configuration
        const LIFF_ID = "2007859046-7NZV6xZG"; // Replace with your actual LIFF ID
        const SUPABASE_URL = "https://lvtdqeerzxpznnayccmb.supabase.co"; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM"; // Replace with your Supabase anon key

        // Initialize Supabase
        let supabase = null;
        if (SUPABASE_URL !== "YOUR_SUPABASE_URL" && SUPABASE_ANON_KEY !== "YOUR_SUPABASE_ANON_KEY") {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Global variables
        let currentUserId = null;
        let currentPeriod = 'daily';
        let userProfile = null;
        let allFoodLogs = []; // Store all logs for filtering
        let activeDate = null; // YYYY-MM-DD ‡∏à‡∏≤‡∏Å DB ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô


        // Initialize the application
        async function initApp() {
            try {
                // Check if we have real credentials or use demo mode
                if (LIFF_ID === "YOUR_LIFF_ID" || SUPABASE_URL === "YOUR_SUPABASE_URL") {
                    console.log('Using demo mode - credentials not configured');
                    await initDemoMode();
                    return;
                }

                // Initialize LIFF
                await liff.init({ liffId: LIFF_ID });

                // Check if user is logged in
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // Get user profile from LINE
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                // Update UI with user info
                document.getElementById("userName").textContent = profile.displayName;

if (profile.pictureUrl) {
    const img = document.getElementById("userProfilePic");
    img.src = profile.pictureUrl;
    img.classList.remove("hidden");

    document.getElementById("userInitial").classList.add("hidden");
} else {
    document.getElementById("userInitial").textContent = profile.displayName.charAt(0);
}


                // Load user data
                await loadUserData();
                await loadFoodLogs();

                // Hide loading screen and show main content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error('Initialization error:', error);
                // If real credentials fail, try demo mode
                console.log('Real connection failed, switching to demo mode');
                await initDemoMode();
            }
        }

        // Initialize demo mode with sample data
        async function initDemoMode() {
            // Simulate loading delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Set demo user info
            document.getElementById('userName').textContent = 'Demo User';
            document.getElementById('userInitial').textContent = 'D';
            
            // Set demo user profile
            userProfile = {
                tdee: 2200,
                weight: 65,
                goal_calories: 2200
            };

            // Calculate nutrition goals based on body weight and TDEE
            const calories = userProfile.goal_calories || userProfile.tdee;
            const weight = userProfile.weight || 65;
            
            // Protein: 1.5-2 times body weight (using 1.75 as average)
            userProfile.protein_goal = Math.round(weight * 1.75);
            
            // Carbs: 3-4 times body weight (using 3.5 as average)
            userProfile.carbs_goal = Math.round(weight * 3.5);
            
            // Fat: 25% of total calories
            userProfile.fat_goal = Math.round((calories * 0.25) / 9);

            // Update UI with demo profile data
            document.getElementById('tdeeValue').textContent = userProfile.tdee;
            document.getElementById('proteinGoal').textContent = userProfile.protein_goal + 'g';
            document.getElementById('carbsGoal').textContent = userProfile.carbs_goal + 'g';
            document.getElementById('fatGoal').textContent = userProfile.fat_goal + 'g';

            // Generate demo food logs and store globally
            allFoodLogs = generateDemoLogs();
            
            // Filter and display data for current period
            const dateRange = getDateRange(currentPeriod);
            const filteredLogs = allFoodLogs.filter(log => {
                const logDate = log.date;
                return logDate >= dateRange.start && logDate <= dateRange.end;
            });
            
            // Update statistics with filtered demo data
            updateStatistics(filteredLogs);
            updateFoodLogsList(filteredLogs);

            // Hide loading screen and show main content
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Generate demo food logs
        function generateDemoLogs() {
            const foods = [
                { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∏‡πâ‡∏á', calories: 450, protein: 25, carbs: 65, fat: 12 },
                { name: '‡∏™‡πâ‡∏°‡∏ï‡∏≥', calories: 120, protein: 3, carbs: 25, fat: 2 },
                { name: '‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á', calories: 280, protein: 35, carbs: 0, fat: 14 },
                { name: '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô', calories: 320, protein: 20, carbs: 15, fat: 22 },
                { name: '‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏°', calories: 80, protein: 1, carbs: 20, fat: 0 },
                { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß  ‡∏∞‡∏°‡πà  ‡∏á', calories: 350, protein: 4, carbs: 75, fat: 8 },
                { name: '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á', calories: 200, protein: 15, carbs: 12, fat: 10 },
                { name: '‡∏•‡∏≤‡∏ö‡∏´‡∏°‡∏π', calories: 180, protein: 22, carbs: 8, fat: 7 }
            ];

            const logs = [];
            const today = new Date();

            // Generate logs for the past 30 days
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                // 2-4 meals per day
                const mealsPerDay = Math.floor(Math.random() * 3) + 2;
                
                for (let j = 0; j < mealsPerDay; j++) {
                    const food = foods[Math.floor(Math.random() * foods.length)];
                    const portion = 0.7 + Math.random() * 0.6; // 0.7 to 1.3 portion
                    
                    logs.push({
                        food_name: food.name,
                        date: date.toISOString().split('T')[0],
                        calories: Math.round(food.calories * portion),
                        protein_g: Math.round(food.protein * portion),
                        carbs_g: Math.round(food.carbs * portion),
                        fat_g: Math.round(food.fat * portion),
                        created_at: date.toISOString()
                    });
                }
            }

            return logs.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Load user profile data from Supabase
        async function loadUserData() {
            try {
                const { data: profile, error: profileError } = await supabase
                    .from("tdee_form")
                    .select("tdee, weight, goal_calories")
                    .eq("line_user_id", currentUserId)
                    .single();

                if (profileError) {
                    console.error('Profile error:', profileError);
                    // Set default values if no profile found
                    userProfile = {
                        tdee: 2000,
                        weight: 70,
                        goal_calories: 2000
                    };
                } else {
                    userProfile = profile;
                 }
                // ‚ùó ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• TDEE ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
if (!userProfile || !userProfile.tdee || !userProfile.weight || !userProfile.goal_calories) {
    alert("‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π Dashboard ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚ù§Ô∏è");
    window.location.href = "https://liff.line.me/2007859046-AM0LQo0g"; 
    return;
}

                // Calculate nutrition goals based on body weight and TDEE
                const calories = userProfile.goal_calories || userProfile.tdee;
                const weight = userProfile.weight || 70;
                
                // Protein: 1.5-2 times body weight (using 1.75 as average)
                userProfile.protein_goal = Math.round(weight * 1.75);
                
                // Carbs: 3-4 times body weight (using 3.5 as average)
                userProfile.carbs_goal = Math.round(weight * 3.5);
                
                // Fat: 25% of total calories
                userProfile.fat_goal = Math.round((calories * 0.25) / 9);

                // Update UI with profile data
                document.getElementById('tdeeValue').textContent = userProfile.goal_calories || userProfile.tdee;
                document.getElementById('proteinGoal').textContent = userProfile.protein_goal + 'g';
                document.getElementById('carbsGoal').textContent = userProfile.carbs_goal + 'g';
                document.getElementById('fatGoal').textContent = userProfile.fat_goal + 'g';

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
            }
        }

       // Load food logs based on current period
async function loadFoodLogs() {
    try {
        // Check if we're in demo mode
        if (!supabase) {
            // Use stored demo data
            const dateRange = getDateRange(currentPeriod);
            const filteredLogs = allFoodLogs.filter(log => {
                const logDate = log.date;
                return logDate >= dateRange.start && logDate <= dateRange.end;
            });

            console.log(`Demo Mode - Period: ${currentPeriod}, Date range: ${dateRange.start} to ${dateRange.end}`);
            console.log(`Total logs: ${allFoodLogs.length}, Filtered logs: ${filteredLogs.length}`);

            updateStatistics(filteredLogs);
            updateCharts(filteredLogs);
            updateFoodLogsList(filteredLogs);
            return;
        }

        // For real Supabase connection
        if (allFoodLogs.length === 0) {

            const { data: logs, error: logsError } = await supabase
                .from("food_logs")
                .select("date, food_name, calories, protein_g, fat_g, carbs_g, created_at")
                .eq("line_userid", currentUserId)
                .order("date", { ascending: false });

            if (logsError) {
                console.error('Logs error:', logsError);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ');
                return;
            }

            allFoodLogs = logs || [];

            if (allFoodLogs.length > 0) {
                activeDate = allFoodLogs[0].date;
            }
        }

        const filteredLogs = allFoodLogs.filter(
            log => log.date === activeDate
        );

        console.log(`Active date (from DB): ${activeDate}`);
        console.log(`Total logs: ${allFoodLogs.length}, Filtered logs: ${filteredLogs.length}`);

        updateStatistics(filteredLogs);
        updateFoodLogsList(filteredLogs);

    } catch (error) {
        console.error('Error loading food logs:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ');
    }
}

        // Update statistics cards
        function updateStatistics(logs) {
            const totals = logs.reduce((acc, log) => {
                acc.calories += log.calories || 0;
                acc.protein += log.protein_g || 0;
                acc.carbs += log.carbs_g || 0;
                acc.fat += log.fat_g || 0;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            // Update values
            document.getElementById('totalCalories').textContent = Math.round(totals.calories);
            document.getElementById('totalProtein').textContent = Math.round(totals.protein) + 'g';
            document.getElementById('totalCarbs').textContent = Math.round(totals.carbs) + 'g';
            document.getElementById('totalFat').textContent = Math.round(totals.fat) + 'g';

            // Update progress bars
            const targetCalories = userProfile.goal_calories || userProfile.tdee;
            const calorieProgress = Math.min((totals.calories / targetCalories) * 100, 100);
            const proteinProgress = Math.min((totals.protein / userProfile.protein_goal) * 100, 100);
            const carbsProgress = Math.min((totals.carbs / userProfile.carbs_goal) * 100, 100);
            const fatProgress = Math.min((totals.fat / userProfile.fat_goal) * 100, 100);

            document.getElementById('calorieProgress').style.width = calorieProgress + '%';
            document.getElementById('proteinProgress').style.width = proteinProgress + '%';
            document.getElementById('carbsProgress').style.width = carbsProgress + '%';
            document.getElementById('fatProgress').style.width = fatProgress + '%';

            // Update donut chart
            updateDailyDonut(logs);

            // Show warnings for daily view
            showDailyWarnings(logs);
        }

        // Update daily donut chart
        function updateDailyDonut(logs) {
            try {
                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM render ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô (canvas ‡πÑ‡∏°‡πà hidden)
                setTimeout(() => {
                    const totals = logs.reduce((acc, log) => acc + (log.calories || 0), 0);
                    const targetCalories = (userProfile && (userProfile.goal_calories || userProfile.tdee)) || 0;

                    const diff = totals - targetCalories;
                    const isOver = diff > 0;
                    const remaining = Math.abs(diff);

                    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏á ---
                    const labelEl = document.getElementById("donutLabel");
                    const remEl = document.getElementById("remainingCalories");
                    if (labelEl) labelEl.textContent = isOver ? "Over" : "Remaining";
                    if (remEl) {
                        remEl.textContent = Math.round(remaining);
                        remEl.classList.remove("text-orange-700", "text-red-600");
                        remEl.classList.add(isOver ? "text-red-600" : "text-white");
                    }

                    // --- ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ---
                    const canvas = document.getElementById("dailyDonutChart");
                    if (!canvas) return;
                    const ctx = canvas.getContext("2d");

                    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (window.dailyDonutChart && typeof window.dailyDonutChart.destroy === "function") {
                        window.dailyDonutChart.destroy();
                    }
                    window.dailyDonutChart = null;

                    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
                    window.dailyDonutChart = new Chart(ctx, {
                        type: "doughnut",
                        data: {
                            labels: [isOver ? "Over" : "Remaining"],
                            datasets: [{
                                data: [isOver ? remaining : (targetCalories - totals), totals],
                                backgroundColor: isOver ? ["#dc2626", "#444"] : ["#444", "#C1272D"],
                                borderWidth: 0,
                                cutout: "80%"
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            animation: { duration: 800, easing: "easeOutQuart" }
                        }
                    });
                }, 600); // ‚úÖ ‡∏´‡∏ô‡πà‡∏ß‡∏á 0.6 ‡∏ß‡∏¥ ‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î
            } catch (e) {
                console.error("updateDailyDonut error:", e);
            }
        }

        // Show daily warnings
        function showDailyWarnings(logs) {
            if (!userProfile) {
                return;
            }

            // Calculate daily totals
            const totals = logs.reduce((acc, log) => {
                acc.calories += log.calories || 0;
                acc.protein += log.protein_g || 0;
                acc.carbs += log.carbs_g || 0;
                acc.fat += log.fat_g || 0;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            const targetCalories = userProfile.goal_calories || userProfile.tdee;
            const warnings = [];
            
            // Check for no food intake or very low intake first
            if (totals.calories === 0) {
                const noFoodWarnings = [
                    `üçΩÔ∏è ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ - ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞! üòä`,
                    `ü•∫ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô - ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏∞!`,
                    `‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ - ‡∏£‡∏µ‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏¥‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞! üçö`,
                                       `üò≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏•‡∏¢ ‚Äî ‡∏¢‡∏π‡πÑ‡∏õ‡∏ñ‡∏∑‡∏≠‡∏®‡∏µ‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏ô‡∏µ‡πà‡∏¢?`,
                                       `ü§® ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å! ‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏û‡∏°‡∏≤!`,
                                       `ü•≤ ‡∏ó‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ E-Cal ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á‡∏ô‡∏∞ ‡πÑ‡∏õ‡∏´‡∏≤‡∏™‡∏±‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏ñ‡∏≠‡∏∞!`,
                                       `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢‡πÄ‡∏´‡∏£‡∏≠‚Ä¶ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å? üòè`,
                    `üòü ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏à‡∏∞‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏ô‡∏∞!`
                ];
                warnings.push(noFoodWarnings[Math.floor(Math.random() * noFoodWarnings.length)]);
            } else if (totals.calories < targetCalories * 0.5) {
                // Very low intake (less than 50% of target)
                const lowIntakeWarnings = [
                    `ü•∫ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å - ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏ô‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ô‡∏∞! üçñ`,
                    `üòü ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ! ‚ö°`,
                    `‚ö†Ô∏è ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà ‡∏õ‡∏•‡∏≤ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô! ü•öüêü`,
                                       `üòµ‚Äçüí´ ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å‚Ä¶ ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏´‡∏ß‡∏°‡∏±‡πâ‡∏¢‡πÄ‡∏ô‡∏µ‡πà‡∏¢?`,
                                       `üçó ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏°‡∏û‡∏±‡∏î‡∏Å‡πá‡∏õ‡∏•‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡∏Å‡∏¥‡∏ô‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πà‡∏ß‡∏ô!`,
                                       `ü´† ‡∏¢‡∏π‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ‡∏¢‡∏π‡∏•‡∏î‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡πà‡∏∞‚Ä¶ ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ñ‡∏≠‡∏∞!`,
                                       `üò® ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡∏•‡∏ï‡πà‡∏≥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏ô‡∏∞!`,
                    `üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÄ‡∏•‡∏¢ - ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏î‡∏µ‡πÜ ‡∏ô‡∏∞! üí™`
                ];
                warnings.push(lowIntakeWarnings[Math.floor(Math.random() * lowIntakeWarnings.length)]);
            } else if (totals.calories < targetCalories * 0.8) {
                // Moderately low intake (less than 80% of target)
                const moderateLowWarnings = [
                    `ü§î ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏à‡∏∞‡∏î‡∏µ‡∏ô‡∏∞! üçó`,
                    `üòä ‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏°‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢! ü•õ`,
                    `üí° ‡∏Ñ‡∏ß‡∏£‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î - ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡∏¥‡πà‡∏°‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô! ü•©`,
                    `üåü ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡πà‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢! ü´ò`
                ];
                warnings.push(moderateLowWarnings[Math.floor(Math.random() * moderateLowWarnings.length)]);
            } else if (totals.calories > targetCalories) {
                // Excess calories
                const excess = totals.calories - targetCalories;
                const dailyWarnings = [
                    `üî• ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏∞! üèÉ‚Äç‚ôÄÔ∏è`,
                    `üçî ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢! üòÖ`,
                    `‚ö†Ô∏è ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏•‡πâ‡∏ô ${Math.round(excess)} - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° 30 ‡∏ô‡∏≤‡∏ó‡∏µ! üö∂‚Äç‚ôÄÔ∏è`,
                                       `üçî ‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏•‡∏•‡∏•‡∏•‡∏•‡∏•‡∏•‡∏• ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏¢‡∏π‡∏ó‡∏≥‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á 3 ‡∏°‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πà‡∏°‡∏±‡πâ‡∏¢‡πÄ‡∏ô‡∏µ‡πà‡∏¢?`,
                                       `üçü ‡∏¢‡∏π‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏¥‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏¢‡∏π‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏ç‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô!`,
                                       `üö® ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡∏•‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå! ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô `,
                                       `üòÇ ‡∏¢‡∏π‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢  ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏¢‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏á‡∏Å‡∏¥‡∏ô‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡∏õ‡∏∞‡πÄ‡∏ô‡∏µ‡πà‡∏¢?`,
                                       `ü§£ ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ E-Cal ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞!`,
                    `üéà ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡πÑ‡∏õ ${Math.round(excess)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà - ‡∏ó‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÇ‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡πÇ‡∏õ‡πà‡∏á! üòÇ`
                ];
                warnings.push(dailyWarnings[Math.floor(Math.random() * dailyWarnings.length)]);
            }

            // Check protein intake (only if calories > 0)
            if (totals.calories > 0) {
                if (totals.protein === 0) {
                    const noProteinWarnings = [
                        `ü•∫ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏•‡∏¢ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà ‡∏õ‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ô‡∏∞! ü•öüêü`,
                        `üòü ‡∏Ç‡∏≤‡∏î‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏°‡∏≤‡∏Å - ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏´‡∏î‡∏ô‡∏∞! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢! üí™`,
                        `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô - ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠! üçñ`
                    ];
                    warnings.push(noProteinWarnings[Math.floor(Math.random() * noProteinWarnings.length)]);
                } else if (totals.protein < userProfile.protein_goal * 0.5) {
                    const lowProteinWarnings = [
                        `ü§î ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà ‡∏õ‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏±‡πà‡∏ß‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞! ü•öüêüü´ò`,
                        `üí™ ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ - ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ!`,
                        `üçó ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô - ‡πÑ‡∏Å‡πà ‡∏´‡∏°‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞!`
                    ];
                    warnings.push(lowProteinWarnings[Math.floor(Math.random() * lowProteinWarnings.length)]);
                } else if (totals.protein > userProfile.protein_goal) {
                    const proteinWarnings = [
                        `üçñ ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! üí™`,
                        `ü•© ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å - ‡∏à‡∏∞‡πÑ‡∏õ‡∏•‡∏á‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏¢‡∏´‡∏£‡∏≠‡∏à‡πä‡∏∞! üèãÔ∏è‚Äç‚ôÇÔ∏è`
                    ];
                    warnings.push(proteinWarnings[Math.floor(Math.random() * proteinWarnings.length)]);
                }
            }

            if (totals.carbs > userProfile.carbs_goal) {
                const carbWarnings = [
                    `üçû ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡∏∞! üçö`,
                    `üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ - ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‚ö°`
                ];
                warnings.push(carbWarnings[Math.floor(Math.random() * carbWarnings.length)]);
            }

            if (totals.fat > userProfile.fat_goal) {
                const fatWarnings = [
                    `ü•ë ‡πÑ‡∏ü‡∏ï‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≠‡∏î! üòã`,
                    `üçü ‡∏ó‡∏≠‡∏î‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ - ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏•‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üõ¢Ô∏è`
                ];
                warnings.push(fatWarnings[Math.floor(Math.random() * fatWarnings.length)]);
            }

            // Show warnings
            showWarnings(warnings);
        }

        // Update food logs list
        function updateFoodLogsList(logs) {
            const container = document.getElementById('foodLogsList');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <div class="text-6xl mb-3">üçΩÔ∏è</div>
                        <p class="font-medium text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.slice(0, 10).map((log, index) => `
                <div class="flex items-center justify-between p-4 glass-effect rounded-lg hover:bg-white/10 transition-all duration-200 group">
                    <div class="flex items-center space-x-3 flex-1">
                        <div class="w-12 h-12 glass-effect rounded-xl flex items-center justify-center">
                            <span class="text-2xl">üçΩÔ∏è</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-white text-base">${log.food_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
                            <div class="text-sm text-gray-400 mt-0.5">${new Date(log.date).toLocaleDateString('th-TH')}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-right">
                            <div class="font-bold text-white text-lg">${Math.round(log.calories || 0)} kcal</div>
                            <div class="text-xs text-gray-400 mt-0.5">${Math.round(log.protein_g || 0)}P ${Math.round(log.carbs_g || 0)}C ${Math.round(log.fat_g || 0)}F</div>
                        </div>
                        <button onclick="deleteLog(${index})" class="delete-btn text-white px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Show warnings for daily view
        function showWarnings(warnings) {
            const warningsBox = document.getElementById('warningsBox');
            
    if (warnings.length > 0) {
    // Show warnings
    warningsBox.classList.remove('hidden');
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    warningsBox.querySelector('.glass-effect').classList.remove('border-green-500/30');
    warningsBox.querySelector('.glass-effect').classList.add('border-yellow-500/30');

    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡πâ‡∏≤‡∏á)
    document.getElementById('warningIcon').innerHTML = '';

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á E-Cal
    document.getElementById('warningTitle').textContent = '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô';
    document.getElementById('warningTitle').className = 'font-bold text-[#C1272D] mb-2 text-lg';

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    document.getElementById('warningContent').innerHTML =
        warnings.map(w => `<div class="mb-1">‚Ä¢ ${w}</div>`).join('');
} else {

                // Show encouragement
                const encouragements = [
                    'üéâ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏•‡∏¢!',
                    '‚ú® ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞!',
                    'üåü ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!',
                    'üëè ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏°‡∏õ‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ!'
                ];
                
                const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                
                warningsBox.classList.remove('hidden');
                warningsBox.querySelector('.glass-effect').classList.remove('border-yellow-500/30');
                warningsBox.querySelector('.glass-effect').classList.add('border-green-500/30');
                document.getElementById('warningIcon').textContent = 'üåü';
                document.getElementById('warningTitle').textContent = '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!';
                document.getElementById('warningTitle').className = 'font-bold text-green-300 mb-2 text-lg';
                document.getElementById('warningContent').innerHTML = `<div class="font-medium text-gray-200">${randomEncouragement}</div>`;
            }
        }

        // Show error screen
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
        }

        // Delete log function
        async function deleteLog(index) {
            const dateRange = getDateRange(currentPeriod);
            const filteredLogs = allFoodLogs.filter(log => {
                const logDate = log.date;
                return logDate >= dateRange.start && logDate <= dateRange.end;
            });

            const logToDelete = filteredLogs[index];
            
            if (!logToDelete) {
                return;
            }

            // Create custom confirmation UI (inline confirmation)
            const confirmBtn = event.target;
            const originalText = confirmBtn.innerHTML;
            const originalClasses = confirmBtn.className;
            
            // Change to confirmation state
            confirmBtn.innerHTML = '‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö';
            confirmBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg transition-all duration-200';
            
            // Create cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.innerHTML = '‚úï';
            cancelBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-all duration-200 ml-2';
            confirmBtn.parentElement.appendChild(cancelBtn);
            
            // Cancel handler
            const cancelHandler = () => {
                confirmBtn.innerHTML = originalText;
                confirmBtn.className = originalClasses;
                cancelBtn.remove();
                confirmBtn.removeEventListener('click', confirmHandler);
            };
            
            cancelBtn.addEventListener('click', cancelHandler);
            
            // Confirm handler
            const confirmHandler = async () => {
                try {
                    if (!supabase) {
                        // Demo mode - just remove from array
                        const originalIndex = allFoodLogs.findIndex(log => 
                            log.food_name === logToDelete.food_name && 
                            log.date === logToDelete.date &&
                            log.created_at === logToDelete.created_at
                        );
                        
                        if (originalIndex !== -1) {
                            allFoodLogs.splice(originalIndex, 1);
                            
                            // Refresh display
                            const newFilteredLogs = allFoodLogs.filter(log => {
                                const logDate = log.date;
                                return logDate >= dateRange.start && logDate <= dateRange.end;
                            });
                            
                            updateStatistics(newFilteredLogs);
                            updateFoodLogsList(newFilteredLogs);
                        }
                    } else {
                        // Real Supabase - delete from database
                        const { error } = await supabase
                            .from('food_logs')
                            .delete()
                            .eq('line_userid', currentUserId)
                            .eq('food_name', logToDelete.food_name)
                            .eq('date', logToDelete.date)
                            .eq('created_at', logToDelete.created_at);

                        if (error) {
                            console.error('Delete error:', error);
                            // Show error message inline
                            confirmBtn.innerHTML = '‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                            setTimeout(() => {
                                confirmBtn.innerHTML = originalText;
                                confirmBtn.className = originalClasses;
                                cancelBtn.remove();
                            }, 2000);
                            return;
                        }

                        // Remove from local array
                        const originalIndex = allFoodLogs.findIndex(log => 
                            log.food_name === logToDelete.food_name && 
                            log.date === logToDelete.date &&
                            log.created_at === logToDelete.created_at
                        );
                        
                        if (originalIndex !== -1) {
                            allFoodLogs.splice(originalIndex, 1);
                        }

                        // Refresh display
                        const newFilteredLogs = allFoodLogs.filter(log => {
                            const logDate = log.date;
                            return logDate >= dateRange.start && logDate <= dateRange.end;
                        });
                        
                        updateStatistics(newFilteredLogs);
                        updateFoodLogsList(newFilteredLogs);
                    }
                } catch (error) {
                    console.error('Error deleting log:', error);
                    confirmBtn.innerHTML = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                    setTimeout(() => {
                        confirmBtn.innerHTML = originalText;
                        confirmBtn.className = originalClasses;
                        cancelBtn.remove();
                    }, 2000);
                }
            };
            
            // Replace click handler
            confirmBtn.removeEventListener('click', deleteLog);
            confirmBtn.addEventListener('click', confirmHandler);
            
            // Auto-cancel after 3 seconds
            setTimeout(cancelHandler, 3000);
        }

        // Initialize app when page loads
        window.addEventListener('load', initApp);
    </script>

  <script>
function smoothGo(url) {
  document.body.classList.add("fade-out");
  setTimeout(() => {
    location.href = url;
  }, 250);
}
</script>

  <a href="https://liff.line.me/2007859046-BpXDWpXe"
   class="fixed bottom-6 right-6 
          bg-[#C1272D] text-white 
          w-14 h-14 flex items-center justify-center 
          rounded-full shadow-md 
          hover:bg-[#a01f24] 
          text-3xl z-50 transition-all duration-300">
  <i class="fi fi-rr-home text-white text-3xl"></i>
</a>
  
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a583a5147632731',t:'MTc2NDMxNTczOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
















