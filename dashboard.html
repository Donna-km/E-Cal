<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Food Dashboard - Daily Only</title>
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
/* Tailwind-based Weight Style */
body { background:#000; color:white; font-family:'Inter',sans-serif; }
.glass-effect { background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.3); }
button,a.button { background:#C1272D !important; color:white !important; border-radius:0.75rem; }
.period-btn{border:1px solid #C1272D !important;}
</style>
</head>

<body class="min-h-screen">

<header class="glass-effect text-white p-4 sticky top-0 z-50 shadow-lg rounded-b-2xl">
  <div class="flex items-center space-x-3">
    <div class="w-8 h-8 bg-white bg-opacity-25 rounded-lg flex items-center justify-center">
      <i class="fi fi-rr-salad text-white" style="font-size:22px;"></i>
    </div>
    <h1 class="text-lg sm:text-xl font-semibold">Food Dashboard</h1>

    <!-- Menu Bar -->
    <div class="flex items-center space-x-3 ml-4">
      <a href="https://liff.line.me/2007859046-WDvlrevQ"
         class="px-3 py-1.5 rounded-lg text-sm font-medium bg-[#C1272D] hover:bg-[#a01f24]">
         Dashboard
      </a>
    </div>
  </div>
</header>

<div id="loadingScreen" class="fixed inset-0 bg-black flex items-center justify-center z-40">
  <div class="text-center">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>
</div>

<main id="mainContent" class="hidden p-4 pb-20">

  <!-- DAILY ONLY BUTTON -->
  <div class="mb-6">
    <div class="glass-effect rounded-xl p-4">
      <button class="period-btn px-3 py-1.5 rounded-md text-sm font-medium bg-[#C1272D] text-white">
        <i class="fi fi-rr-calendar-lines-pen"></i> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      </button>
    </div>
  </div>

  <!-- Daily Summary -->
  <div id="periodSummary" class="glass-effect rounded-xl p-6 mb-6">
    <div id="dailySummaryCard" class="text-center">
      <h3 class="text-lg font-semibold mb-6">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
      <div class="relative flex justify-center items-center mb-2" style="height:240px;">
        <canvas id="dailyDonutChart" width="220" height="220"></canvas>
        <div class="absolute text-center">
          <div id="donutLabel" class="text-sm">Remaining</div>
          <div id="remainingCalories" class="text-4xl font-bold">0</div>
          <div class="text-sm">kcal</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Warnings -->
  <div id="warningsBox" class="glass-effect rounded-xl p-4 mb-6 hidden">
    <div class="flex space-x-3">
      <div class="text-2xl" id="warningIcon">‚ö†Ô∏è</div>
      <div class="flex-1">
        <h4 class="font-semibold mb-2" id="warningTitle">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h4>
        <div class="text-sm" id="warningContent"></div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-2 gap-4 mb-6">
    <div class="glass-effect rounded-xl p-4">
      <div class="text-2xl mb-1">üî•</div>
      <div id="totalCalories" class="text-2xl font-bold">0</div>
      <div class="text-sm">‡∏à‡∏≤‡∏Å <span id="tdeeValue">0</span> kcal</div>
    </div>

    <div class="glass-effect rounded-xl p-4">
      <div class="text-2xl mb-1">üçñ</div>
      <div id="totalProtein" class="text-2xl font-bold">0g</div>
    </div>

    <div class="glass-effect rounded-xl p-4">
      <div class="text-2xl mb-1">üçû</div>
      <div id="totalCarbs" class="text-2xl font-bold">0g</div>
    </div>

    <div class="glass-effect rounded-xl p-4">
      <div class="text-2xl mb-1">ü•ë</div>
      <div id="totalFat" class="text-2xl font-bold">0g</div>
    </div>
  </div>

  <!-- Recent Food Logs -->
  <div class="glass-effect rounded-xl p-6">
    <h3 class="text-lg font-semibold mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div id="foodLogsList" class="space-y-3"></div>
  </div>

</main>

<script>
// Only DAILY logic kept. Weekly / Monthly fully removed.

let supabase = null;
let currentUserId = null;
let userProfile = null;
let allFoodLogs = [];

const LIFF_ID = "2007859046-7NZV6xZG";
const SUPABASE_URL = "https://lvtdqeerzxpznnayccmb.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_KEY";

if (SUPABASE_URL && SUPABASE_ANON_KEY) {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

window.addEventListener("load", initApp);

async function initApp() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) return liff.login();

  const profile = await liff.getProfile();
  currentUserId = profile.userId;

  await loadUserData();
  await loadFoodLogs();

  document.getElementById("loadingScreen").classList.add("hidden");
  document.getElementById("mainContent").classList.remove("hidden");
}

async function loadUserData() {
  const { data } = await supabase.from("tdee_form")
    .select("tdee,weight,goal_calories")
    .eq("line_user_id", currentUserId)
    .maybeSingle();

  userProfile = {
    tdee: data?.tdee || 0,
    weight: data?.weight || 0,
    goal_calories: data?.goal_calories || data?.tdee || 0,
    protein_goal: Math.round((data?.weight || 60) * 1.75),
    carbs_goal: Math.round((data?.weight || 60) * 3.5),
    fat_goal: Math.round(((data?.goal_calories || data?.tdee || 0) * 0.25) / 9)
  };

  document.getElementById("tdeeValue").textContent = userProfile.goal_calories;
}

async function loadFoodLogs() {
  const { data } = await supabase.from("food_logs")
    .select("*")
    .eq("line_userid", currentUserId)
    .order("created_at", { ascending:false });

  allFoodLogs = data || [];

  updateDaily(allFoodLogs);
}

function updateDaily(logs) {
  const totals = logs.reduce((a,l)=>({
    calories:a.calories+(l.calories||0),
    protein:a.protein+(l.protein_g||0),
    carbs:a.carbs+(l.carbs_g||0),
    fat:a.fat+(l.fat_g||0),
  }),{calories:0,protein:0,carbs:0,fat:0});

  document.getElementById("totalCalories").textContent = totals.calories;
  document.getElementById("totalProtein").textContent = totals.protein+"g";
  document.getElementById("totalCarbs").textContent = totals.carbs+"g";
  document.getElementById("totalFat").textContent = totals.fat+"g";

  updateDailyDonut(logs);
  updateWarnings(totals);
  updateFoodList(logs);
}

function updateWarnings(t) {
  const box = document.getElementById("warningsBox");
  const msgs = [];

  if (t.calories === 0) msgs.push("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏•‡∏¢ üçö");
  if (t.calories > userProfile.goal_calories) msgs.push("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!");
  if (t.protein < userProfile.protein_goal*0.5) msgs.push("‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà/‡∏õ‡∏•‡∏≤ ‡∏ô‡∏∞ ü•ö");

  if (msgs.length === 0) {
    box.classList.remove("hidden");
    document.getElementById("warningTitle").textContent="‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!";
    document.getElementById("warningContent").innerHTML="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏°‡∏≤‡∏Å üéâ";
  } else {
    box.classList.remove("hidden");
    document.getElementById("warningTitle").textContent="‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô";
    document.getElementById("warningContent").innerHTML=msgs.map(m=>`‚Ä¢ ${m}`).join("<br>");
  }
}

function updateFoodList(logs){
  const c=document.getElementById("foodLogsList");
  if(!logs.length){c.innerHTML=`<p class='text-center opacity-50'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;return;}

  c.innerHTML = logs.slice(0,10).map(l=>`
    <div class="glass-effect p-3 rounded-lg flex justify-between">
      <div>
        <div class="font-medium">${l.food_name}</div>
        <div class="text-sm opacity-70">${l.date}</div>
      </div>
      <div class="text-right">
        <div class="font-semibold">${l.calories} kcal</div>
      </div>
    </div>
  `).join("");
}

// Daily Donut Chart
function updateDailyDonut(logs) {
  const totals = logs.reduce((a,l)=>a+(l.calories||0),0);
  const target = userProfile.goal_calories;
  const diff = target - totals;

  document.getElementById("remainingCalories").textContent = Math.abs(diff);
  document.getElementById("donutLabel").textContent = diff>=0 ? "Remaining":"Over";

  const ctx=document.getElementById("dailyDonutChart").getContext("2d");
  if(window.dailyDonutChart) window.dailyDonutChart.destroy();

  window.dailyDonutChart=new Chart(ctx,{
    type:"doughnut",
    data:{
      datasets:[{
        data:[Math.max(diff,0), totals],
        backgroundColor:["#FFECD0","#FF3974"],
        borderWidth:0
      }]
    },
    options:{plugins:{legend:{display:false}},cutout:"80%"}
  });
}
</script>

</body>
</html>
